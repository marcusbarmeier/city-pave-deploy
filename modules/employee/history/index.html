<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../style.css"></script> <!-- Ensure styles are loaded -->
</head>

<body class="bg-gray-100 flex flex-col h-screen">

    <header class="bg-white shadow-sm p-4 z-10 flex items-center gap-3 sticky top-0">
        <a href="../../employee/index.html" class="text-gray-600 hover:text-gray-900">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 class="font-bold text-lg text-gray-800">My Work History</h1>
    </header>

    <!-- Filters -->
    <div class="bg-white border-b border-gray-200 p-2 overflow-x-auto whitespace-nowrap scrollbar-hide">
        <div class="flex space-x-2" id="filter-bar">
            <!-- Buttons injected by JS -->
            <button data-filter="shift"
                class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200">Last
                Shift</button>
            <button data-filter="7days"
                class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-blue-600 text-white shadow-sm ring-1 ring-blue-600">7
                Days</button>
            <button data-filter="30days"
                class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200">30
                Days</button>
            <button data-filter="6months"
                class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200">6
                Months</button>
            <button data-filter="12months"
                class="filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200">12
                Months</button>
        </div>
    </div>

    <main class="flex-grow overflow-y-auto p-4 space-y-4" id="history-feed">
        <div class="animate-pulse flex space-x-4">
            <div class="flex-1 space-y-4 py-1">
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="space-y-2">
                    <div class="h-4 bg-gray-200 rounded"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { TicketAggregator } from '../../tickets/ticket-aggregator.js';

        const firebaseConfig = {
            apiKey: "AIzaSyADrnYgh1fSTo3IZD7HOEJMyjduzDYIYSs",
            authDomain: "city-pave-estimator.firebaseapp.com",
            projectId: "city-pave-estimator",
            storageBucket: "city-pave-estimator.firebasestorage.app",
            messagingSenderId: "111714884839",
            appId: "1:111714884839:web:2b782a1b7be5be8edc5642"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseServices = { db, collection, query, where, getDocs, orderBy };
        const aggregator = new TicketAggregator(window.firebaseServices);

        let currentFilter = '7days';

        async function loadHistory() {
            const feed = document.getElementById('history-feed');
            feed.innerHTML = '<p class="text-center text-gray-500 py-8">Loading history...</p>';

            try {
                const userId = auth.currentUser.uid;
                const items = await aggregator.fetchHistory(userId, currentFilter);

                if (items.length === 0) {
                    feed.innerHTML = `
                        <div class="text-center py-10">
                            <div class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <h3 class="text-gray-900 font-medium">No History Found</h3>
                            <p class="text-gray-500 text-sm mt-1">Try a different date range.</p>
                        </div>
                    `;
                    return;
                }

                feed.innerHTML = '';
                items.forEach(item => {
                    const el = createHistoryCard(item);
                    feed.appendChild(el);
                });

            } catch (e) {
                console.error(e);
                feed.innerHTML = '<p class="text-center text-red-500 py-8">Error loading history.</p>';
            }
        }

        function createHistoryCard(item) {
            const date = new Date(item.createdAt).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            const div = document.createElement('div');
            div.className = "bg-white p-4 rounded-xl shadow border-l-4 border-blue-500";

            // Format Hours or Loads
            let qtyDisplay = `${item.quantity} ${item.unitType}`;
            if (item.unitType === 'Hours') qtyDisplay = `${parseFloat(item.quantity).toFixed(2)} Hrs`;

            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${item.jobName || 'Unknown Job'}</h3>
                        <p class="text-xs text-gray-500">${date} â€¢ Ticket #${item.ticketId?.split('_')[1].slice(-4) || '???'}</p>
                    </div>
                    <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded">${item.status || 'Submitted'}</span>
                </div>
                <div class="flex gap-4 text-sm text-gray-700 mb-2">
                    <div class="flex items-center gap-1">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>${qtyDisplay}</span>
                    </div>
                    ${item.scaleTicketUrls && item.scaleTicketUrls.length ? `
                    <div class="flex items-center gap-1">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        <span>${item.scaleTicketUrls.length} Slips</span>
                    </div>` : ''}
                </div>
                <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded italic">"${item.description || 'No notes'}"</p>
            `;
            return div;
        }

        // Filter Logic
        document.getElementById('filter-bar').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                // UI Toggle
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.className = "filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors";
                });
                e.target.className = "filter-btn px-4 py-1.5 rounded-full text-sm font-medium bg-blue-600 text-white shadow-sm ring-1 ring-blue-600";

                currentFilter = e.target.getAttribute('data-filter');
                if (auth.currentUser) loadHistory();
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.firebaseServices.auth.currentUser = user; // Ensure avail for aggregator
                loadHistory();
            } else {
                window.location.href = '../../index.html';
            }
        });

    </script>
</body>

</html>