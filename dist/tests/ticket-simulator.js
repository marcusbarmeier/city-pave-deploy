// ¬© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
export async function runTicketSimulation() { console.clear(); console.log("%c üö¶ STARTING TICKET MODULE SIMULATION ", "background: #222; color: #bada55; font-size: 16px"); const report = { smartCreate: 'PENDING', manualFallback: 'PENDING', formFill: 'PENDING', submission: 'PENDING', errors: [] }; function logStep(step, msg) { console.log(`%c [${step}] ${msg}`, "color: #00bcd4"); } function logError(step, msg) { console.error(`%c [${step}] ERROR: ${msg}`, "color: #ff5252"); report.errors.push(`[${step}] ${msg}`); } logStep('SmartCreate', 'Checking for candidate scanning...'); try { if (typeof window.aggregator === 'undefined' && typeof aggregator === 'undefined') { console.warn("Global aggregator not found (expected if module scoped). Checking UI."); } } catch (e) { } const smartList = document.getElementById('smart-candidates-list'); if (!smartList) { logError('SmartCreate', 'DOM Element #smart-candidates-list not found!'); return report; } let attempts = 0; while (attempts < 10) { if (!smartList.innerText.includes("Scanning")) break; await new Promise(r => setTimeout(r, 500)); attempts++; } if (smartList.innerText.includes("Scanning")) { logError('SmartCreate', 'Timeout: "Scanning..." stuck. Logic likely broken or missing.'); report.smartCreate = 'FAILED'; } else if (smartList.innerText.includes("No work logs found") || smartList.children.length > 0) { logStep('SmartCreate', 'Scanning finished (Candidates or Empty found).'); report.smartCreate = 'PASSED'; } else { logStep('SmartCreate', 'Scanning finished (Unknown State).'); report.smartCreate = 'UNCERTAIN'; } logStep('ManualMode', 'Clicking "Create Blank Ticket"...'); const manualBtn = document.getElementById('manual-create-btn'); if (!manualBtn) { logError('ManualMode', 'Button not found.'); return report; } manualBtn.click(); report.manualFallback = 'PASSED'; await new Promise(r => setTimeout(r, 500)); logStep('FormFill', 'Filling sample data...'); const jobSelect = document.getElementById('ticket-job-select'); if (jobSelect) { await new Promise(r => setTimeout(r, 1500)); if (jobSelect.options.length > 1) { jobSelect.selectedIndex = 1; logStep('FormFill', `Selected Job: ${jobSelect.options[1].text}`); } else { logError('FormFill', 'No jobs loaded in dropdown.'); } } const desc = document.getElementById('ticket-desc'); const hours = document.getElementById('ticket-hours'); const unit = document.getElementById('ticket-unit'); if (desc) desc.value = "Test Ticket - Simulation Run"; if (hours) hours.value = 8.5; if (unit) unit.value = "Unit-99"; report.formFill = 'PASSED'; logStep('Signature', 'Drawing mock signature...'); try { const canvas = document.getElementById('signature-pad'); const mouseEvent = new MouseEvent('mousedown', { view: window, bubbles: true, cancelable: true, clientX: canvas.getBoundingClientRect().left + 20, clientY: canvas.getBoundingClientRect().top + 20 }); canvas.dispatchEvent(mouseEvent); const mouseUp = new MouseEvent('mouseup', { view: window, bubbles: true, cancelable: true }); canvas.dispatchEvent(mouseUp); logStep('Signature', 'Signature attempted.'); } catch (e) { logError('Signature', e.message); } const submitBtn = document.getElementById('submit-ticket-btn'); if (submitBtn) { logStep('Submission', 'Submit button found. Stopping before actual write.'); report.submission = 'READY'; } else { logError('Submission', 'Submit button missing.'); } console.log("%c üèÅ SIMULATION COMPLETE ", "background: #222; color: #bada55"); console.table(report); return report; }