// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
const functions = require("firebase-functions"); const admin = require("firebase-admin"); const path = require("path"); const os = require("os"); const fs = require("fs-extra"); const ffmpeg = require("fluent-ffmpeg"); const ffmpegPath = require("ffmpeg-static"); ffmpeg.setFfmpegPath(ffmpegPath); exports.processDashcamUpload = functions .runWith({ memory: "1GB", timeoutSeconds: 300 }) .storage.object() .onFinalize(async (object) => { const fileBucket = object.bucket; const filePath = object.name; const contentType = object.contentType; if (!filePath.startsWith("dashcam_videos/")) { return console.log("Skipping: Not in dashcam path."); } if (!contentType.startsWith("video/")) { return console.log("Skipping: Not a video."); } if (filePath.endsWith("thumb.jpg")) { return console.log("Skipping: Already a thumbnail."); } const fileName = path.basename(filePath); const bucket = admin.storage().bucket(fileBucket); const parts = filePath.split('/'); const uid = parts.length > 2 ? parts[1] : 'unknown'; console.log(`Processing video: ${filePath} for User: ${uid}`); const workingDir = path.join(os.tmpdir(), "dashcam_process"); const tempFilePath = path.join(workingDir, fileName); const tempThumbPath = path.join(workingDir, `${path.parse(fileName).name}_thumb.jpg`); await fs.ensureDir(workingDir); try { await bucket.file(filePath).download({ destination: tempFilePath }); console.log("File downloaded locally."); await new Promise((resolve, reject) => { ffmpeg(tempFilePath) .screenshots({ count: 1, folder: workingDir, filename: path.basename(tempThumbPath), size: '320x?', }) .on('end', resolve) .on('error', reject); }); console.log("Thumbnail generated."); const thumbStoragePath = filePath.replace("dashcam_videos/", "dashcam_thumbs/").replace(".webm", ".jpg"); await bucket.upload(tempThumbPath, { destination: thumbStoragePath, metadata: { contentType: 'image/jpeg' } }); const thumbFile = bucket.file(thumbStoragePath); const [thumbUrl] = await thumbFile.getSignedUrl({ action: 'read', expires: '03-01-2500' }); console.log("Thumbnail uploaded:", thumbUrl); const timestampStr = path.parse(fileName).name; const clipsRef = admin.firestore().collection("dashcam_clips"); const snapshot = await clipsRef .where("userId", "==", uid) .where("timestamp", "==", timestampStr) .limit(1) .get(); let docRef; if (!snapshot.empty) { docRef = snapshot.docs[0].ref; console.log("Found existing Firestore doc:", docRef.id); } else { console.log("No matching doc found. Creating new index."); docRef = clipsRef.doc(); await docRef.set({ userId: uid, timestamp: timestampStr, url: object.mediaLink || `gs: createdAt: admin.firestore.FieldValue.serverTimestamp(), recovered: true }); } await docRef.set({ thumbnailUrl: thumbUrl, processed: true, processedAt: admin.firestore.FieldValue.serverTimestamp(), sizeBytes: object.size, contentType: object.contentType }, { merge: true }); console.log("Firestore updated."); } catch (err) { console.error("Error processing dashcam video:", err); } finally { await fs.remove(workingDir); } });