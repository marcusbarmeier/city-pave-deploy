// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { initializeApp, getApps, getApp } from "https: import { getAuth, onAuthStateChanged } from "https: const firebaseConfig = { apiKey: "AIzaSyADrnYgh1fSTo3IZD7HOEJMyjduzDYIYSs", authDomain: "city-pave-estimator.firebaseapp.com", projectId: "city-pave-estimator", storageBucket: "city-pave-estimator.firebasestorage.app", messagingSenderId: "111714884839", appId: "1:111714884839:web:2b782a1b7be5be8edc5642" }; let app; if (getApps().length === 0) { app = initializeApp(firebaseConfig); } else { app = getApp(); } const qaAuth = getAuth(app); let MODULE_REGISTRY = null; async function loadModuleRegistry() { if (MODULE_REGISTRY) return MODULE_REGISTRY; try { const response = await fetch('/modules.json'); if (!response.ok) throw new Error("Failed to load modules.json"); MODULE_REGISTRY = await response.json(); console.log("[QA Agent] Module Registry Loaded:", Object.keys(MODULE_REGISTRY)); return MODULE_REGISTRY; } catch (e) { console.error("[QA Agent] Could not load module registry. Crawl will be limited.", e); return null; } } class Logger { constructor() { this.log = []; this.maxLogSize = 1000; } save(entry, type = 'info') { const timestamp = new Date().toISOString(); const path = window.location.pathname; const logEntry = `[${timestamp}] [${type.toUpperCase()}] [${path}] ${entry}`; this.log.push(logEntry); if (this.log.length > this.maxLogSize) this.log.shift(); try { const existing = sessionStorage.getItem('qa_session_logs') || ''; let newLog = existing + logEntry + '\n'; if (newLog.length > 500000) { newLog = newLog.substring(newLog.length - 500000); } sessionStorage.setItem('qa_session_logs', newLog); } catch (e) { console.warn("[QA Logger] Storage full"); } import('./logging.js').then(({ logAction, logError }) => { if (type === 'error') { logError(new Error(entry), { path, timestamp }); } else { logAction('qa_log', { message: entry, type, path }); } }).catch(err => console.warn("Failed to load cloud logging", err)); } async export() { const logs = sessionStorage.getItem('qa_session_logs') || "No logs found."; console.log(`[QA Export] Logs (${logs.length} bytes):\n`, logs); try { await navigator.clipboard.writeText(logs); alert("âœ… Logs copied to Clipboard!\n(Paste them into a text file)\n\nAttempting file download..."); } catch (e) { console.warn("Clipboard failed:", e); alert("â¬‡ï¸ Starting download..."); } const blob = new Blob([logs], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = `chaos_monkey_logs_${Date.now()}.txt`; document.body.appendChild(a); a.click(); setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 60000); } } class PermissionGuard { constructor() { this.currentUserRole = 'guest'; } setRole(role) { this.currentUserRole = role; } canInteract(element) { const rolesAttr = element.getAttribute('data-roles'); if (rolesAttr) { const allowedRoles = rolesAttr.split(','); if (!allowedRoles.includes('all') && !allowedRoles.includes(this.currentUserRole)) { return false; } } if (element.offsetParent === null) return false; if (window.getComputedStyle(element).visibility === 'hidden') return false; if (element.disabled) return false; if (element.id === 'logout-btn') return false; if (element.textContent && element.textContent.toLowerCase().includes('log out')) return false; if (element.closest('#qa-modal')) return false; if (element.id === 'qa-agent-btn') return false; return true; } validatePageAccess() { const restrictedPages = { 'admin': ['/admin-dashboard.html', '/developer-console.html'], 'operations': ['/modules/operations/'], 'finance': ['/modules/finance/'] }; if (this.currentUserRole === 'laborer' || this.currentUserRole === 'crew') { if (window.location.pathname.includes('admin')) { return `[Security Alert] Role '${this.currentUserRole}' is on restricted page: ${window.location.pathname}`; } } return null; } } class ChaosEngine { constructor(logger, guard) { this.logger = logger; this.guard = guard; this.intervalId = null; this.isRunning = false; this.isPaused = false; this.originalAlert = null; this.originalConfirm = null; this.originalPrompt = null; } start(intervalMs = 800) { if (this.isRunning && !this.isPaused) return; this.isRunning = true; this.isPaused = false; sessionStorage.setItem('qa_chaos_active', 'true'); this.overrideDialogs(); this.logger.save("Chaos Monkey Started"); console.log("ğŸ’ Chaos Monkey Started"); this.intervalId = setInterval(() => { this.performAction(); }, intervalMs); } stop(silent = false) { clearInterval(this.intervalId); this.isRunning = false; this.isPaused = false; sessionStorage.removeItem('qa_chaos_active'); this.restoreDialogs(); if (!silent) { this.logger.save("Chaos Monkey Stopped"); console.log("ğŸ’ Chaos Monkey Stopped"); alert("ğŸ’ Chaos Monkey Stopped"); } } pause() { if (this.isRunning) { clearInterval(this.intervalId); this.isPaused = true; console.log("[Chaos] Paused"); } } resume() { if (this.isRunning && this.isPaused) { this.start(); } } performAction() { const isCrawl = sessionStorage.getItem('qa_crawl_active') === 'true'; if (!isCrawl && Math.random() < 0.02) { this.logger.save("Action: History Back"); history.back(); return; } const candidates = document.querySelectorAll('button, a, input[type="checkbox"], input[type="radio"], select'); const validCandidates = Array.from(candidates).filter(el => this.guard.canInteract(el)); if (validCandidates.length === 0) return; const target = validCandidates[Math.floor(Math.random() * validCandidates.length)]; const originalBorder = target.style.outline; target.style.outline = "3px solid red"; target.scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => { try { this.logger.save(`Clicking: <${target.tagName}> ${target.id || target.className || target.textContent.substring(0, 20)}`); target.click(); } catch (e) { this.logger.save(`Error clicking: ${e.message}`, 'error'); } finally { if (target) target.style.outline = originalBorder; } }, 100); } overrideDialogs() { if (this.originalAlert) return; this.originalAlert = window.alert; this.originalConfirm = window.confirm; this.originalPrompt = window.prompt; window.alert = (msg) => { this.logger.save(`[Alert Suppressed] ${msg}`); console.log(`[Chaos] Alert: ${msg}`); return true; }; window.confirm = (msg) => { this.logger.save(`[Confirm Suppressed] ${msg} -> true`); console.log(`[Chaos] Confirm: ${msg}`); return true; }; window.prompt = (msg) => { this.logger.save(`[Prompt Suppressed] ${msg} -> 'ChaosInput'`); console.log(`[Chaos] Prompt: ${msg}`); return "ChaosInput"; }; } restoreDialogs() { if (this.originalAlert) { window.alert = this.originalAlert; this.originalAlert = null; } if (this.originalConfirm) { window.confirm = this.originalConfirm; this.originalConfirm = null; } if (this.originalPrompt) { window.prompt = this.originalPrompt; this.originalPrompt = null; } } } class Navigator { constructor(logger) { this.logger = logger; } async startCrawl(chaosEngine) { if (!confirm("Start Exhaustive Crawl? This will visit all known modules.")) return; const registry = await loadModuleRegistry(); if (!registry) { alert("Cannot load module registry. Crawl aborted."); return; } const queue = []; Object.values(registry).forEach(module => { if (module.mainHtml) { module.files.forEach(f => { if (f.endsWith('.html')) { } }); } }); Object.entries(registry).forEach(([name, config]) => { config.files.forEach(file => { if (file.endsWith('.html')) { let targetPath = `/modules/${name}/${file}`; if (file === config.mainHtml) { targetPath = `/modules/${name}/index.html`; } queue.push(targetPath); } }); }); queue.unshift('/index.html'); sessionStorage.setItem('qa_crawl_queue', JSON.stringify(queue)); sessionStorage.setItem('qa_crawl_visited', JSON.stringify([])); sessionStorage.setItem('qa_crawl_active', 'true'); this.logger.save(`Starting Crawl with ${queue.length} pages.`); chaosEngine.stop(true); this.processStep(chaosEngine); } processStep(chaosEngine) { if (sessionStorage.getItem('qa_crawl_active') !== 'true') return; const queue = JSON.parse(sessionStorage.getItem('qa_crawl_queue') || '[]'); const visited = JSON.parse(sessionStorage.getItem('qa_crawl_visited') || '[]'); const currentPath = window.location.pathname; if (!visited.includes(currentPath)) { visited.push(currentPath); sessionStorage.setItem('qa_crawl_visited', JSON.stringify(visited)); } this.logger.save(`[Crawl] Auditing ${currentPath}`); const banner = document.createElement('div'); banner.className = "fixed top-0 left-0 w-full bg-yellow-400 text-black text-center font-bold z-[10000] py-1"; banner.textContent = `ğŸ•µï¸ QA CRAWL: Auditing ${currentPath} (${queue.length} remaining)`; document.body.appendChild(banner); chaosEngine.start(300); setTimeout(() => { chaosEngine.stop(true); if (document.body.contains(banner)) document.body.removeChild(banner); const nextUrl = queue.shift(); sessionStorage.setItem('qa_crawl_queue', JSON.stringify(queue)); if (nextUrl) { this.logger.save(`[Crawl] Navigating to ${nextUrl}`); window.location.href = nextUrl; } else { alert("Crawl Complete!"); sessionStorage.removeItem('qa_crawl_active'); } }, 4000); } } export const QAAgent = { logger: new Logger(), guard: new PermissionGuard(), chaos: null, navigator: null, init: () => { QAAgent.chaos = new ChaosEngine(QAAgent.logger, QAAgent.guard); QAAgent.navigator = new Navigator(QAAgent.logger); window.onerror = (msg, url, line, col, error) => { QAAgent.logger.save(`[Global Error] ${msg} at ${url}:${line}`, 'error'); }; window.addEventListener('unhandledrejection', (e) => { QAAgent.logger.save(`[Unhandled Rejection] ${e.reason}`, 'error'); }); console.log("[QA Agent] Initialized."); }, toggleMenu: () => { QAAgent.chaos.pause(); renderQAModal(); } }; function renderQAModal() { let modal = document.getElementById('qa-modal'); if (modal) { modal.classList.remove('hidden'); return; } modal = document.createElement('div'); modal.id = 'qa-modal'; modal.className = 'fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center backdrop-blur-sm'; modal.innerHTML = ` <div class="bg-white rounded-xl p-6 shadow-2xl w-80 border border-gray-200"> <div class="flex justify-between items-center mb-4"> <h3 class="font-bold text-lg text-gray-800">ğŸ QA Tools</h3> <button id="close-qa-x" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button> </div> <div class="space-y-2"> <button id="btn-chaos-start" class="qa-btn bg-gray-50 hover:bg-blue-50 text-blue-700">ğŸ’ Start Chaos Monkey</button> <button id="btn-chaos-stop" class="qa-btn bg-gray-50 hover:bg-green-50 text-green-700">âœ‹ Stop Chaos Monkey</button> <button id="btn-crawl" class="qa-btn bg-gray-50 hover:bg-indigo-50 text-indigo-700">ğŸ•µï¸ Start Exhaustive Crawl</button> <button id="btn-export" class="qa-btn bg-gray-50 hover:bg-teal-50 text-teal-700">ğŸ’¾ Export Logs</button> <button id="btn-report" class="qa-btn bg-gray-50 hover:bg-orange-50 text-orange-700">ğŸ“ Report Issue</button> </div> <div class="mt-4 text-center"> <p class="text-[10px] text-gray-400">Shift + Esc to Stop</p> </div> </div> <style> .qa-btn { width: 100%; text-align: left; padding: 12px; border-radius: 8px; font-weight: 500; transition: all 0.2s; border: 1px solid #f3f4f6; } </style> `; document.body.appendChild(modal); document.getElementById('close-qa-x').onclick = () => { modal.classList.add('hidden'); QAAgent.chaos.resume(); }; document.getElementById('btn-chaos-start').onclick = () => { modal.classList.add('hidden'); QAAgent.chaos.start(); }; document.getElementById('btn-chaos-stop').onclick = () => { modal.classList.add('hidden'); QAAgent.chaos.stop(); }; document.getElementById('btn-crawl').onclick = () => { modal.classList.add('hidden'); QAAgent.navigator.startCrawl(QAAgent.chaos); }; document.getElementById('btn-export').onclick = () => { QAAgent.logger.export(); }; document.getElementById('btn-report').onclick = () => { const note = prompt("Issue Description:"); if (note) { QAAgent.logger.save(`[User Report] ${note}`, 'report'); console.log("Issue logged. Downloading report now..."); QAAgent.logger.export(); } }; } document.addEventListener('DOMContentLoaded', () => { QAAgent.init(); const checkUser = (user) => { if (user) { QAAgent.guard.setRole('staff'); const injectBtn = (attempts = 0) => { if (window.FloatingDock) { window.FloatingDock.addButton({ id: 'qa-agent-btn', label: 'QA Tools', icon: 'ğŸ', color: '#dc2626', onClick: QAAgent.toggleMenu }); } else if (attempts < 10) { setTimeout(() => injectBtn(attempts + 1), 200); } else { if (!document.getElementById('qa-agent-btn')) { const btn = document.createElement('button'); btn.id = 'qa-agent-btn'; btn.textContent = "ğŸ"; btn.className = "fixed bottom-4 left-4 bg-red-600 text-white rounded-full w-12 h-12 shadow-lg z-50 font-bold hover:bg-red-700 flex items-center justify-center text-2xl"; btn.onclick = QAAgent.toggleMenu; document.body.appendChild(btn); } } }; injectBtn(); if (sessionStorage.getItem('qa_chaos_active') === 'true') { QAAgent.chaos.start(); } if (sessionStorage.getItem('qa_crawl_active') === 'true') { setTimeout(() => QAAgent.navigator.processStep(QAAgent.chaos), 1000); } } }; if (window.firebaseServices && window.firebaseServices.auth) { onAuthStateChanged(window.firebaseServices.auth, checkUser); } else { onAuthStateChanged(qaAuth, checkUser); } document.addEventListener('keydown', (e) => { if (e.shiftKey && e.key === 'Escape') { QAAgent.chaos.stop(); } }); });