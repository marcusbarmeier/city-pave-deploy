// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { getFirestore, doc, getDoc, collection, getDocs } from "https: import { getFunctions, httpsCallable } from "https: import { getAuth } from "https: export class MonetizationService { constructor() { } async init(db) { this.db = db; this.auth = getAuth(); console.log("ðŸ’³ MonetizationService Initialized."); } async getPlans() { const plansRef = collection(this.db, "subscription_plans"); const snap = await getDocs(plansRef); const plans = []; snap.forEach(d => { const data = d.data(); if (data.active) plans.push(data); }); return plans.sort((a, b) => a.internal_tier_id === 'tier_free' ? -1 : 1); } async getCurrentSubscription(userId) { if (!userId && this.auth.currentUser) userId = this.auth.currentUser.uid; if (!userId) return null; const userDoc = await getDoc(doc(this.db, "users", userId)); if (userDoc.exists()) { return userDoc.data().subscription || null; } return null; } async restorePurchases() { console.log("â™»ï¸ Restore Purchases Triggered..."); const userId = this.auth.currentUser?.uid; if (!userId) throw new Error("User not logged in."); const mockReceipt = { platform: 'ios', receipt_data: 'base64_receipt_mock_12345', product_id: 'com.citypave.tier.pro' }; try { console.log("   -> Sending receipt to backend..."); await new Promise(r => setTimeout(r, 1500)); const simulatedResult = { success: true, tier_id: 'tier_pro', source: 'ios', message: "Restored 'Pro Crew' subscription from App Store." }; alert(simulatedResult.message); window.location.reload(); } catch (e) { console.error("Restore failed", e); alert("Restore failed: " + e.message); } } getManageSubscriptionUrl(source) { if (source === 'ios') return 'https: if (source === 'android') return 'https: if (source === 'stripe' || source === 'web') return '/billing-portal'; return '#'; } }