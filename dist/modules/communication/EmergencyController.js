// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { notificationEngine } from './notification-engine.js'; export class EmergencyController { constructor() { this.activeIncident = null; this.emergencyTypes = [ { id: 'accident', label: 'ACCIDENT', color: 'bg-red-600' }, { id: 'injury', label: 'INJURY', color: 'bg-red-700' }, { id: 'fire', label: 'FIRE / HAZARD', color: 'bg-orange-600' }, { id: 'security', label: 'SECURITY', color: 'bg-slate-800' } ]; } triggerEmergency(userContext) { console.warn("ðŸš¨ EMERGENCY PROTOCOL INITIATED ðŸš¨"); this.activeIncident = { id: `INC-${Date.now()}`, timestamp: new Date().toISOString(), user: userContext.name || 'Unknown User', location: userContext.location || null, status: 'active' }; console.log("[Emergency] Pausing standard time tracking..."); this.crisisTeam = ['Owner', 'SafetyOfficer', 'Admin']; window.dispatchEvent(new CustomEvent('system-emergency', { detail: { incidentId: this.activeIncident.id, location: this.activeIncident.location, timestamp: this.activeIncident.timestamp } })); return this.activeIncident; } async confirmEmergencyType(typeId) { if (!this.activeIncident) return; const typeObj = this.emergencyTypes.find(t => t.id === typeId); this.activeIncident.type = typeObj ? typeObj.label : 'UNKNOWN EMERGENCY'; notificationEngine.logEvent('emergency_triggered', this.activeIncident); console.log(`[Emergency] Broadcasting ALERT to: ${this.crisisTeam.join(', ')}`); const magicLink = this.generateMagicLink(); this.activeIncident.magicLink = magicLink; return { message: "Help is on the way. Incident Reported.", magicLink: magicLink }; } generateMagicLink() { const baseUrl = window.location.origin.includes('127.0.0.1') || window.location.origin.includes('localhost') ? window.location.origin + '/modules/communication' : '/modules/communication'; return `${baseUrl}/secure-view.html?incidentId=${this.activeIncident.id}`; } } export const emergencyController = new EmergencyController();