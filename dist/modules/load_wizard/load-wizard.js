// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { renderInvoiceScanner } from '/modules/finance/invoice-scanner/invoice-scanner.js'; export class LoadWizard { constructor(containerId, options = {}) { this.containerId = containerId; this.onComplete = options.onComplete || (() => { }); this.onCancel = options.onCancel || (() => { }); this.autoFill = options.autoFill || null; this.loadData = { hasTicket: this.autoFill ? this.autoFill.hasTicket : false, tickets: [], material: this.autoFill ? this.autoFill.material : '', quantity: this.autoFill ? this.autoFill.quantity : null, isClean: false, notOverloaded: false, safetyConcerns: '', hasDamage: false, damageDescription: '', operatorName: '', operatorSignature: false }; } render() { const area = document.getElementById(this.containerId); if (!area) { console.error(`LoadWizard: Container ${this.containerId} not found.`); return; } area.style.display = 'flex'; area.style.pointerEvents = 'auto'; area.innerHTML = ''; if (this.autoFill) { console.log("LoadWizard: Auto-Filling with", this.autoFill); this._renderStep2_Scan(area); } else { this._renderStep0_Type(area); } } destroy() { const area = document.getElementById(this.containerId); if (area) { area.innerHTML = ''; area.style.pointerEvents = 'none'; } } _renderStep0_Type(area) { area.innerHTML = ` <div class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s_ease-out] border border-slate-700 font-sans"> <div class="bg-gradient-to-r from-slate-900 to-slate-800 p-4 border-b border-slate-700 flex justify-between items-center"> <div class="flex items-center gap-3"> <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center"> <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg> </div> <h3 class="font-bold text-white text-lg tracking-wide">Logistics</h3> </div> <button id="wiz-close" class="p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors"> <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> </button> </div> <div class="p-6 text-center space-y-6 bg-slate-900"> <p class="text-xl font-bold text-slate-200">Current Objective</p> <div class="grid grid-cols-2 gap-4"> <button id="btn-type-load" class="py-10 rounded-xl border border-slate-700 bg-slate-800 hover:bg-indigo-900/40 hover:border-indigo-500/50 flex flex-col items-center justify-center gap-4 group transition-all duration-200 relative overflow-hidden"> <span class="text-5xl group-hover:scale-110 transition-transform filter drop-shadow-lg">ğŸšœ</span> <span class="font-bold text-slate-200 text-lg">Load Up</span> <div class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div> </button> <button id="btn-type-dump" class="py-10 rounded-xl border border-slate-700 bg-slate-800 hover:bg-amber-900/40 hover:border-amber-500/50 flex flex-col items-center justify-center gap-4 group transition-all duration-200 relative overflow-hidden"> <span class="text-5xl group-hover:scale-110 transition-transform filter drop-shadow-lg">ğŸš®</span> <span class="font-bold text-slate-200 text-lg">Dump</span> <div class="absolute inset-0 bg-amber-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div> </button> </div> </div> </div> `; area.querySelector('#wiz-close').onclick = () => { this.destroy(); this.onCancel(); }; area.querySelector('#btn-type-load').onclick = () => this._renderStep1_Ticket(area); area.querySelector('#btn-type-dump').onclick = () => this._renderStep0B_DumpScan(area); } _renderStep0B_DumpScan(area) { area.innerHTML = ` <div class="bg-slate-900 rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s_ease-out] border border-slate-700"> <div class="bg-amber-600 p-4 text-white flex justify-between items-center shadow-lg z-10 relative"> <div class="flex items-center gap-2"> <button id="wiz-back" class="mr-2 text-amber-200 hover:text-white transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button> <h3 class="font-bold text-lg">Dump Receipt?</h3> </div> </div> <div class="p-8 text-center space-y-6 bg-slate-900"> <div class="grid grid-cols-2 gap-4"> <button id="btn-dump-scan" class="py-8 rounded-xl border border-slate-600 bg-slate-800 hover:bg-amber-900/30 hover:border-amber-500/50 flex flex-col items-center justify-center gap-3 group transition-all"> <span class="text-4xl group-hover:scale-110 transition-transform">ğŸ§¾</span> <span class="font-bold text-amber-400">Scan Receipt</span> </button> <button id="btn-dump-no" class="py-8 rounded-xl border border-slate-600 bg-slate-800 hover:bg-slate-700 hover:border-slate-500 flex flex-col items-center justify-center gap-3 group transition-all"> <span class="text-4xl group-hover:scale-110 transition-transform">ğŸš«</span> <span class="font-bold text-slate-300">No Receipt</span> </button> </div> </div> </div> `; area.querySelector('#wiz-back').onclick = () => this._renderStep0_Type(area); area.querySelector('#btn-dump-scan').onclick = () => this._renderScanner(area, 'Dump Receipt'); area.querySelector('#btn-dump-no').onclick = () => { this.loadData.hasTicket = false; this.loadData.material = "Dump (No Receipt)"; this._renderStep4_Safety(area); }; } _renderScanner(area, title) { area.innerHTML = ` <div class="bg-slate-900 rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s_ease-out] border border-slate-700"> <div class="bg-indigo-600 p-4 text-white flex items-center justify-between"> <h3 class="font-bold text-lg">${title}</h3> <div class="flex gap-2"> <span id="scan-count" class="bg-white/20 px-2 py-1 rounded text-xs font-mono hidden">0 Scanned</span> <button id="wiz-done-scan" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-bold hidden">Done</button> </div> </div> <div id="scanner-container" class="p-4 min-h-[300px] bg-black"></div> </div> `; const updateCount = () => { const count = this.loadData.tickets.length; const badge = area.querySelector('#scan-count'); const doneBtn = area.querySelector('#wiz-done-scan'); if (count > 0) { badge.textContent = `${count} Scanned`; badge.classList.remove('hidden'); doneBtn.classList.remove('hidden'); } }; area.querySelector('#wiz-done-scan').onclick = () => { if (title.includes('Dump')) { this.loadData.material = "Dump Receipt(s)"; this._renderStep4_Safety(area); } else { this._renderStep3_Damage(area); } }; renderInvoiceScanner('scanner-container', (data) => { this.loadData.hasTicket = true; this.loadData.tickets.push({ text: data.rawText, image: data.file, type: title }); const container = document.getElementById('scanner-container'); container.innerHTML = `<div class="h-64 flex flex-col items-center justify-center text-green-500"><svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><p class="text-xl font-bold">Scanned!</p><button id="scan-more" class="mt-8 bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-lg">Scan Another?</button></div>`; updateCount(); container.querySelector('#scan-more').onclick = () => { this._renderScanner(area, title); }; }); } _renderStep1_Ticket(area) { area.innerHTML = ` <div class="bg-slate-900 rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s_ease-out] border border-slate-700"> <div class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-lg z-10 relative"> <div class="flex items-center gap-2"> <button id="wiz-back" class="mr-2 text-indigo-200 hover:text-white transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button> <h3 class="font-bold text-lg">Scale Ticket?</h3> </div> <span class="text-xs font-mono bg-black/20 px-2 py-1 rounded">Step 2/4</span> </div> <div class="p-8 text-center space-y-6 bg-slate-900"> <div class="grid grid-cols-2 gap-4"> <button id="btn-ticket-yes" class="py-8 rounded-xl border border-slate-600 bg-slate-800 hover:bg-emerald-900/30 hover:border-emerald-500/50 flex flex-col items-center justify-center gap-3 group transition-all"> <span class="text-4xl group-hover:scale-110 transition-transform">ğŸ“¸</span> <span class="font-bold text-emerald-400">Scan Ticket</span> </button> <button id="btn-ticket-no" class="py-8 rounded-xl border border-slate-600 bg-slate-800 hover:bg-slate-700 hover:border-slate-500 flex flex-col items-center justify-center gap-3 group transition-all"> <span class="text-4xl group-hover:scale-110 transition-transform">ğŸš«</span> <span class="font-bold text-slate-300">No Ticket</span> <span class="text-xs text-slate-500 font-normal">Job site material / Dirt</span> </button> </div> </div> </div> `; area.querySelector('#wiz-back').onclick = () => this._renderStep0_Type(area); area.querySelector('#btn-ticket-yes').onclick = () => this._renderStep2_Scan(area); area.querySelector('#btn-ticket-no').onclick = () => this._renderStep2_Manual(area); } _renderStep2_Scan(area) { this._renderScanner(area, 'Load Ticket'); } _renderStep2_Manual(area) { area.innerHTML = ` <div class="bg-slate-900 rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s_ease-out] border border-slate-700"> <div class="bg-indigo-600 p-4 text-white flex items-center justify-between"> <h3 class="font-bold text-lg">Select Material</h3> <button id="wiz-back" class="text-white/80 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button> </div> <div class="p-6 space-y-4 bg-slate-900"> <div class="grid grid-cols-2 gap-3"> ${['Mud/Dirt', 'Concrete Waste', 'Asphalt Waste', 'Snow', 'Gravel', 'Sand'].map(m => ` <button class="mat-btn p-3 border border-slate-600 rounded-lg text-sm font-semibold text-slate-300 hover:bg-indigo-900/40 hover:border-indigo-500 hover:text-white text-left transition-colors" data-val="${m}">${m}</button> `).join('')} </div> </div> </div> `; area.querySelector('#wiz-back').onclick = () => this._renderStep1_Ticket(area); area.querySelectorAll('.mat-btn').forEach(btn => { btn.addEventListener('click', (e) => { this.loadData.hasTicket = false; this.loadData.material = e.target.getAttribute('data-val'); this._renderStep3_Damage(area); }); }); } _renderStep3_Damage(area) { area.innerHTML = ` <div class="bg-slate-900 rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s_ease-out] border border-orange-500/50"> <div class="bg-orange-600 p-4 text-white flex items-center justify-between"> <div class="flex items-center gap-2"> <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg> <h3 class="font-bold text-lg">Equipment Check</h3> </div> <span class="text-xs font-mono bg-black/20 px-2 py-1 rounded">Step 3/4</span> </div> <div class="p-6 space-y-6 bg-slate-900 text-center"> <h4 class="text-slate-300 font-medium">Is there any NEW damage to the equipment?</h4> <div class="grid grid-cols-2 gap-4"> <button id="btn-damage-no" class="py-6 rounded-xl border border-green-600/50 bg-green-900/20 hover:bg-green-900/40 hover:border-green-500 flex flex-col items-center justify-center gap-2 transition-all"> <span class="text-3xl">âœ…</span> <span class="font-bold text-green-400">No Damage</span> </button> <button id="btn-damage-yes" class="py-6 rounded-xl border border-red-600/50 bg-red-900/20 hover:bg-red-900/40 hover:border-red-500 flex flex-col items-center justify-center gap-2 transition-all"> <span class="text-3xl">âš ï¸</span> <span class="font-bold text-red-400">Report Damage</span> </button> </div> <div class="pt-4 border-t border-slate-700"> <h4 class="text-slate-300 font-medium mb-4">Is the bed/tailgate clean?</h4> <div class="flex gap-4 justify-center"> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="clean" value="yes" class="w-5 h-5 text-indigo-600 bg-slate-700 border-slate-600" checked> <span class="text-slate-300">Yes, Clean</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="clean" value="no" class="w-5 h-5 text-indigo-600 bg-slate-700 border-slate-600"> <span class="text-slate-300">No (Needs Wash)</span> </label> </div> </div> </div> </div> `; area.querySelector('#btn-damage-no').onclick = () => { this.loadData.hasDamage = false; this.loadData.isClean = area.querySelector('input[name="clean"]:checked').value === 'yes'; this._renderStep4_Safety(area); }; area.querySelector('#btn-damage-yes').onclick = () => { this.loadData.hasDamage = true; this.loadData.isClean = area.querySelector('input[name="clean"]:checked').value === 'yes'; this._renderStep4_Safety(area); }; } _renderStep4_Safety(area) { area.innerHTML = ` <div class="bg-slate-900 rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s_ease-out] border border-red-500/50"> <div class="bg-red-600 p-4 text-white flex items-center justify-between"> <div class="flex items-center gap-2"> <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg> <h3 class="font-bold text-lg">Site & Safety Check</h3> </div> <span class="text-xs font-mono bg-black/20 px-2 py-1 rounded">Final Step</span> </div> <div class="p-6 space-y-6 bg-slate-900"> <div class="space-y-4"> <label class="flex items-center gap-4 p-4 border border-slate-700 rounded-xl bg-slate-800/50 cursor-pointer hover:bg-slate-800 transition-colors"> <input type="checkbox" id="chk-debris" class="w-6 h-6 text-red-600 rounded bg-slate-700 border-slate-600 focus:ring-red-500"> <span class="font-bold text-slate-300">Loose Debris Removed / Tarped</span> </label> <label class="flex items-center gap-4 p-4 border border-slate-700 rounded-xl bg-slate-800/50 cursor-pointer hover:bg-slate-800 transition-colors"> <input type="checkbox" id="chk-overload" class="w-6 h-6 text-red-600 rounded bg-slate-700 border-slate-600 focus:ring-red-500"> <span class="font-bold text-slate-300">Truck is NOT Overloaded</span> </label> </div> <!-- Site Evidence Section --> <div class="border-t border-slate-700 pt-4"> <label class="block font-bold text-slate-400 mb-2 text-xs uppercase tracking-wider">Site Liability Evidence (Optional)</label> <div class="grid grid-cols-2 gap-3 mb-3"> <button id="btn-ev-photo" class="py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-slate-300 flex items-center justify-center gap-2 transition-colors"> <span>ğŸ“·</span> Add Photo </button> <button id="btn-ev-video" class="py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-slate-300 flex items-center justify-center gap-2 transition-colors"> <span>ğŸ¥</span> Add Video </button> </div> <textarea id="safety-notes" class="w-full p-3 border border-slate-700 bg-black/30 rounded-lg text-sm text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all" rows="2" placeholder="Site Conditions / Location Notes..."></textarea> </div> <button id="btn-safety-next" class="w-full py-4 bg-slate-800 text-slate-500 font-bold rounded-xl cursor-not-allowed border border-slate-700 transition-all" disabled> Confirm & Log Load </button> </div> </div> `; const check = () => { const c1 = document.getElementById('chk-debris').checked; const c2 = document.getElementById('chk-overload').checked; const btn = document.getElementById('btn-safety-next'); if (c1 && c2) { btn.disabled = false; btn.classList.remove('bg-slate-800', 'text-slate-500', 'cursor-not-allowed', 'border-slate-700'); btn.classList.add('bg-emerald-600', 'text-white', 'hover:bg-emerald-500', 'shadow-lg', 'shadow-emerald-900/50', 'border-emerald-500'); } else { btn.disabled = true; btn.classList.add('bg-slate-800', 'text-slate-500', 'cursor-not-allowed', 'border-slate-700'); btn.classList.remove('bg-emerald-600', 'text-white', 'hover:bg-emerald-500', 'shadow-lg', 'shadow-emerald-900/50', 'border-emerald-500'); } }; area.querySelector('#chk-debris').onchange = check; area.querySelector('#chk-overload').onchange = check; area.querySelector('#btn-ev-photo').onclick = (e) => { const btn = e.target.closest('button'); btn.classList.add('bg-green-600', 'text-white', 'border-green-500'); btn.innerHTML = '<span>âœ…</span> Photo Added'; this.loadData.hasEvidence = true; }; area.querySelector('#btn-ev-video').onclick = (e) => { const btn = e.target.closest('button'); btn.classList.add('bg-green-600', 'text-white', 'border-green-500'); btn.innerHTML = '<span>âœ…</span> Video Added'; this.loadData.hasEvidence = true; }; area.querySelector('#btn-safety-next').onclick = () => { this.loadData.isClean = true; this.loadData.notOverloaded = true; this.loadData.safetyConcerns = document.getElementById('safety-notes').value; this.destroy(); this.onComplete(this.loadData); }; } }