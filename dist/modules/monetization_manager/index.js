// ¬© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { doc, getDoc, setDoc, collection, getDocs, updateDoc, writeBatch } from "https: import { StoreVault } from './components/store-vault.js'; import { MappingTable } from './components/mapping-table.js'; import { PlanEditor } from './components/plan-editor.js'; export class MonetizationManager { constructor(db, functionsInstance) { this.db = db; this.functions = functionsInstance; this.plans = []; this.config = null; this.vault = new StoreVault('monetization-vault-container', db, functionsInstance); this.table = new MappingTable('monetization-table-container', []); this.editor = new PlanEditor('monetization-modals-container'); } async init() { console.log("üí∞ MonetizationManager v2 Initializing..."); this.setupLayout(); await Promise.all([ this.loadPlans(), this.loadConfig() ]); this.bindComponentEvents(); this.renderAll(); } setupLayout() { const container = document.getElementById("monetization-container"); if (!container) return; container.innerHTML = ` <div class="monetization-dashboard space-y-6"> <!-- Header --> <div class="flex justify-between items-center"> <div> <h2 class="text-xl font-bold text-white">Subscription Command Center</h2> <p class="text-sm text-gray-400">Manage tiers, pricing mapping, and marketing copy.</p> </div> </div> <!-- Vault Container --> <div id="monetization-vault-container"></div> <!-- Table Container --> <div id="monetization-table-container"></div> </div> <!-- Modals Container --> <div id="monetization-modals-container"></div> `; } bindComponentEvents() { this.vault.onSavePublic = async (data) => { await this.savePublicConfig(data); }; this.vault.onSaveSecrets = async (data) => { await this.saveSecrets(data); }; this.table.onEdit = (tierId) => { const plan = this.plans.find(p => p.internal_tier_id === tierId); if (plan) this.editor.open(plan); }; this.table.onSeed = async () => { if (window.seedMonetization) { await window.seedMonetization(); await this.loadPlans(); } else { alert("Seeding utility not found. Please run seed_database.js manually."); } }; this.editor.onSave = async (id, data) => { await this.updatePlan(id, data); }; } renderAll() { this.vault.render(this.config); this.table.updatePlans(this.plans); } async loadPlans() { try { const snapshot = await getDocs(collection(this.db, "sys_subscription_plans")); this.plans = []; snapshot.forEach(doc => { const data = doc.data(); if (!data.internal_tier_id) data.internal_tier_id = doc.id; this.plans.push(data); }); } catch (e) { console.error("Error loading plans:", e); } } async loadConfig() { const docRef = doc(this.db, "sys_admin", "monetization_config"); const docSnap = await getDoc(docRef); if (docSnap.exists()) { this.config = docSnap.data(); } else { this.config = { stripe_publishable_key: "" }; } } async savePublicConfig(data) { await setDoc(doc(this.db, "sys_admin", "monetization_config"), data, { merge: true }); this.config = { ...this.config, ...data }; alert("Public Config Saved."); } async saveSecrets(secrets) { console.log("üîê Uploading secrets to secure vault..."); try { console.warn("Backend function 'updateSecrets' not reachable. Mocking success."); alert("Secrets encrypted and sent to Vault (Mock)!"); } catch (error) { console.error("Failed to save secrets:", error); alert("Error: " + error.message); } } async updatePlan(tierId, updateData) { console.log(`Updating Plan ${tierId}...`, updateData); try { const planRef = doc(this.db, "sys_subscription_plans", tierId); await updateDoc(planRef, updateData); await this.loadPlans(); this.renderAll(); return true; } catch (e) { console.error("Update failed", e); alert("Update failed: " + e.message); } } }