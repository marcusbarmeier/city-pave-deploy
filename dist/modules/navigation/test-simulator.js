// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
export class TestSimulator { constructor(app) { this.app = app; this.originalWatchPosition = navigator.geolocation.watchPosition; this.mockWatchId = null; this.interval = null; this.step = 0; } start() { console.log("Starting Simulation..."); window.SIM_MODE = true; alert("Simulation Started. Sit back and watch the scenario unfold."); this.mockGeolocation(); this.mockDashcam(); setTimeout(() => this.triggerDispatch(), 1000); this.runScenario(); } stop() { if (this.interval) clearInterval(this.interval); if (this.mockWatchId && navigator.geolocation.clearWatch) { navigator.geolocation.clearWatch(this.mockWatchId); } window.SIM_MODE = false; } mockGeolocation() { window._mockPosCallback = null; navigator.geolocation.watchPosition = (success, error, options) => { window._mockPosCallback = success; return 999; }; this.app.startLocationWatch(); } updateLocation(lat, lng, speed = 45) { if (window._mockPosCallback) { window._mockPosCallback({ coords: { latitude: lat, longitude: lng, accuracy: 10, speed: speed / 2.23694, heading: 0 }, timestamp: Date.now() }); } } mockDashcam() { console.log("Sim: Mocking Camera & Mic..."); const canvas = document.createElement('canvas'); canvas.width = 640; canvas.height = 480; const ctx = canvas.getContext('2d'); const draw = () => { ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 640, 480); ctx.fillStyle = '#fff'; ctx.font = '30px Arial'; ctx.fillText('SIMULATION CAM', 200, 200); ctx.fillText(new Date().toLocaleTimeString(), 200, 250); requestAnimationFrame(draw); }; draw(); const stream = canvas.captureStream(30); const audioCtx = new AudioContext(); const osc = audioCtx.createOscillator(); const dst = audioCtx.createMediaStreamDestination(); osc.connect(dst); const audioTrack = dst.stream.getAudioTracks()[0]; stream.addTrack(audioTrack); navigator.mediaDevices.getUserMedia = async (constraints) => { console.log("Sim: getUserMedia called with", constraints); return stream; }; } triggerDispatch() { console.log("Simulating New Dispatch..."); const mockJob = { id: 'sim-job-1', clientName: "Simulation Estates", siteAddress: "123 Job Site Rd", dumpAddress: "999 Dump Lane", date: new Date().toISOString().split('T')[0], crew: [{ userId: this.app.currentUser?.uid || 'test-user' }] }; const jobLat = 44.9800; const jobLng = -93.2700; this.injectZone('job', 'Simulation Estates', jobLat, jobLng); const dumpLat = 44.9600; const dumpLng = -93.2500; this.injectZone('dump', 'City Dump', dumpLat, dumpLng); const shopLat = 44.9200; const shopLng = -93.2600; this.app.handleNewAssignment(mockJob); setTimeout(() => { console.log("Sim: Auto-Accepting Route..."); const destCoords = { lat: mockJob.siteAddress ? 44.9800 : 0, lng: -93.2700 }; this.app.startRouteTo({ lat: jobLat, lng: jobLng }, 'job', mockJob.clientName); }, 5000); this.waypoints = { jobLat, jobLng, dumpLat, dumpLng, shopLat, shopLng }; } injectZone(type, name, lat, lng) { const paths = [ { lat: lat + 0.002, lng: lng + 0.002 }, { lat: lat - 0.002, lng: lng + 0.002 }, { lat: lat - 0.002, lng: lng - 0.002 }, { lat: lat + 0.002, lng: lng - 0.002 } ]; this.app.geofence.addZone({ id: `sim-${type}`, name: name, type: type, paths: paths }); } runScenario() { let seconds = 0; this.interval = setInterval(() => { seconds++; const wp = this.waypoints; if (!wp) return; if (seconds < 5) { this.updateLocation(44.9778, -93.2650, 15); } else if (seconds === 7) { console.log("Sim: Engaging Drive Mode (Dashcam ON)"); const dashBtn = document.getElementById('nav-dashcam-btn'); if (dashBtn) dashBtn.click(); } else if (seconds < 10) { this.updateLocation(44.9790, -93.2680, 45); } else if (seconds === 11) { this.updateLocation(wp.jobLat, wp.jobLng, 5); } else if (seconds < 15) { this.updateLocation(wp.jobLat, wp.jobLng, 0); } else if (seconds < 20) { this.updateLocation(44.9700, -93.2600, 50); } else if (seconds === 20) { console.log("Sim: Triggering Dashcam Incident!"); const incidentBtn = document.getElementById('nav-dashcam-bay-btn-incident'); if (incidentBtn) { incidentBtn.click(); } else { console.warn("Sim: Could not find incident button!"); } } else if (seconds === 21) { this.updateLocation(wp.dumpLat, wp.dumpLng, 5); } else if (seconds < 30) { this.updateLocation(wp.dumpLat, wp.dumpLng, 0); } else if (seconds === 31) { this.updateLocation(44.9650, -93.2550, 45); } else if (seconds === 35) { this.updateLocation(wp.shopLat, wp.shopLng, 5); } else if (seconds > 36 && seconds < 55) { this.updateLocation(wp.shopLat, wp.shopLng, 0); } else if (seconds === 60) { console.log("Scenario & Loop Complete."); clearInterval(this.interval); } }, 1000); } }