// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
export class ImpactMonitor { constructor(options = {}) { this.onImpact = options.onImpact || (() => { }); this.threshold = options.threshold || 25.0; this.isEnabled = false; this.lastImpact = 0; this.COOLDOWN = 5000; this.DEBOUNCE_WINDOW = 1000; this.incidentStart = 0; this.handleMotion = this.handleMotion.bind(this); } start() { if (this.isEnabled) return; if (window.DeviceMotionEvent) { window.addEventListener('devicemotion', this.handleMotion); this.isEnabled = true; console.log("Impact Monitor Started"); } else { console.warn("DeviceMotionEvent not supported"); } } stop() { window.removeEventListener('devicemotion', this.handleMotion); this.isEnabled = false; } setSensitivity(level) { this.threshold = level === 'bumpy' ? 35.0 : 20.0; console.log(`Impact Sensitivity set to: ${level} (${this.threshold})`); } handleMotion(event) { if (!this.isEnabled) return; const now = Date.now(); if (now - this.lastImpact < this.COOLDOWN) return; const { x, y, z } = event.accelerationIncludingGravity || { x: 0, y: 0, z: 0 }; const gForce = Math.sqrt(x * x + y * y + z * z); if (this.onLiveReading) this.onLiveReading(gForce); if (gForce > this.threshold) { if (now - this.incidentStart < this.DEBOUNCE_WINDOW) { return; } console.warn(`IMPACT DETECTED: ${gForce.toFixed(2)} (Threshold: ${this.threshold})`); this.lastImpact = now; this.incidentStart = now; this.onImpact({ gForce, timestamp: new Date().toISOString(), raw: { x, y, z } }); } } simulate(force = 30.0) { console.warn("DEV: Simulating Impact Trigger"); this.onImpact({ gForce: force, timestamp: new Date().toISOString(), isSimulation: true }); } }