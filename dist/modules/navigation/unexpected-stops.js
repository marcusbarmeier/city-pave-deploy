// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
export class UnexpectedStopMonitor { constructor(options = {}) { this.stationaryThresholdMeters = options.distanceThreshold || 20; this.stationaryTimeMs = options.timeThreshold || 5 * 60 * 1000; this.onStopDetected = options.onStopDetected || (() => { }); this.onMotionDetected = options.onMotionDetected || (() => { }); this.lastSignificantLocation = null; this.stationarySince = null; this.isPromptActive = false; this.debug = options.debug || false; } updateLocation(location) { if (!location || !location.lat || !location.lng) return; if (!this.lastSignificantLocation) { this.lastSignificantLocation = location; this.stationarySince = Date.now(); return; } const distance = this.getDistanceFromLatLonInMeters( this.lastSignificantLocation.lat, this.lastSignificantLocation.lng, location.lat, location.lng ); if (distance > this.stationaryThresholdMeters) { if (this.debug) console.log(`[StopMonitor] Moved ${distance.toFixed(1)}m. Resetting timer.`); this.lastSignificantLocation = location; this.stationarySince = Date.now(); if (this.isPromptActive) { this.isPromptActive = false; this.onMotionDetected(); } } else { const elapsed = Date.now() - this.stationarySince; if (this.debug) console.log(`[StopMonitor] Stationary for ${(elapsed / 1000).toFixed(1)}s (Radius: ${distance.toFixed(1)}m)`); if (elapsed > this.stationaryTimeMs && !this.isPromptActive) { this.isPromptActive = true; this.onStopDetected(elapsed); } } } reset() { this.stationarySince = Date.now(); this.isPromptActive = false; } getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) { var R = 6371; var dLat = this.deg2rad(lat2 - lat1); var dLon = this.deg2rad(lon2 - lon1); var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2); var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); var d = R * c; return d * 1000; } deg2rad(deg) { return deg * (Math.PI / 180); } }