// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
const DEFAULT_SECTIONS = [ { title: "Section 1 - Safety and Health Policy", category: "Policies" }, { title: "Section 2: Hazard Assessment, Analysis and Control", category: "Policies" }, { title: "Section 5 - Company Rules", category: "Policies" }, { title: "Section 9 - Inspections", category: "Policies" }, { title: "Section 10 - Investigation & Reporting", category: "Policies" }, { title: "Section 3 - Safe Work & Emergency Activities", category: "Emergency" }, { title: "Section 11 - Emergency Preparedness", category: "Emergency" }, { title: "SWP - Emergency Response - Environmental (Spills & Weather)", category: "Emergency" }, { title: "SWP - Emergency Response - Fires & Explosions", category: "Emergency" }, { title: "SWP - Emergency Response - Significant Property Damage", category: "Emergency" }, { title: "SWP - Emergency Response - Traffic Accidents", category: "Emergency" }, { title: "SWP - Emergency Response - Bodily Harm / Injury", category: "Emergency" }, { title: "SWP - Emergency Response - Excavation / Trench Collapse", category: "Emergency" }, { title: "Section 4 - Safe Work Procedures - Tools & Equipment", category: "Heavy Equipment" }, { title: "SWP - Dump Trucks (Tandem)", category: "Heavy Equipment" }, { title: "SWP - Loading Dump Trucks", category: "Heavy Equipment" }, { title: "SWP - Unloading and Dumping Materials", category: "Heavy Equipment" }, { title: "SWP - Equipment Trailer Use (Skid Steer / General)", category: "Heavy Equipment" }, { title: "SWP - Loading/Unloading Equipment from Trailers", category: "Heavy Equipment" }, { title: "SWP - Excavators (4-ton to 16-ton)", category: "Heavy Equipment" }, { title: "SWP - Forklift Operation", category: "Heavy Equipment" }, { title: "SWP - Skid Steer Loader", category: "Heavy Equipment" }, { title: "SWP - Skid Steer Attachment - Bucket (1-yard)", category: "Heavy Equipment" }, { title: "SWP - Skid Steer Attachments - Forks", category: "Heavy Equipment" }, { title: "SWP - Wheel Loader (CAT 924K)", category: "Heavy Equipment" }, { title: "SWP - Loader Attachment - Material Bucket (3-yard)", category: "Heavy Equipment" }, { title: "SWP - Loader Snow Pusher (12-foot)", category: "Heavy Equipment" }, { title: "SWP - Pickup Truck (1-ton)", category: "Heavy Equipment" }, { title: "SWP - General Vehicles", category: "Heavy Equipment" }, { title: "SWP - Spotting for Heavy Equipment", category: "Heavy Equipment" }, { title: "SWP - 1-2-3 Blocks", category: "Shop Tools" }, { title: "SWP - Anvil", category: "Shop Tools" }, { title: "SWP - Bench Vice", category: "Shop Tools" }, { title: "SWP - Bolt Cutters", category: "Shop Tools" }, { title: "SWP - Breaker Bars", category: "Shop Tools" }, { title: "SWP - Calipers", category: "Shop Tools" }, { title: "SWP - Chisels", category: "Shop Tools" }, { title: "SWP - Clamps (Assortment)", category: "Shop Tools" }, { title: "SWP - Engine Hoist / Cherry Picker", category: "Shop Tools" }, { title: "SWP - Files (Assortment)", category: "Shop Tools" }, { title: "SWP - Gauge Blocks", category: "Shop Tools" }, { title: "SWP - Hacksaw", category: "Shop Tools" }, { title: "SWP - Hammers (Ball-peen, General)", category: "Shop Tools" }, { title: "SWP - Hand Sockets", category: "Shop Tools" }, { title: "SWP - Handsaw", category: "Shop Tools" }, { title: "SWP - High-Force Tools (Ball joint press)", category: "Shop Tools" }, { title: "SWP - Knives", category: "Shop Tools" }, { title: "SWP - Mallets", category: "Shop Tools" }, { title: "SWP - Mechanic's Creeper", category: "Shop Tools" }, { title: "SWP - Micrometers", category: "Shop Tools" }, { title: "SWP - Other Power Tools", category: "Shop Tools" }, { title: "SWP - Pinch Bars (Tires)", category: "Shop Tools" }, { title: "SWP - Pliers (Assortment)", category: "Shop Tools" }, { title: "SWP - Pneumatic Tools", category: "Shop Tools" }, { title: "SWP - Presses", category: "Shop Tools" }, { title: "SWP - Pry Bars", category: "Shop Tools" }, { title: "SWP - Pullers", category: "Shop Tools" }, { title: "SWP - Punches", category: "Shop Tools" }, { title: "SWP - Ratchets", category: "Shop Tools" }, { title: "SWP - Rigging Chains", category: "Shop Tools" }, { title: "SWP - Rigging Straps", category: "Shop Tools" }, { title: "SWP - Rotating Power Tools (Hazardous)", category: "Shop Tools" }, { title: "SWP - Rotating Power Tools (Gloves Optional)", category: "Shop Tools" }, { title: "SWP - Rulers / Straight Edges", category: "Shop Tools" }, { title: "SWP - Screwdrivers", category: "Shop Tools" }, { title: "SWP - Sledgehammers", category: "Shop Tools" }, { title: "SWP - Socket Accessories", category: "Shop Tools" }, { title: "SWP - Tape Measures", category: "Shop Tools" }, { title: "SWP - Telescoping Gauges", category: "Shop Tools" }, { title: "SWP - Tin Snips / Shears", category: "Shop Tools" }, { title: "SWP - Transmission Jacks", category: "Shop Tools" }, { title: "SWP - Two-Post Vehicle Hoist", category: "Shop Tools" }, { title: "SWP - Vehicle Lifting (Bottle Jacks)", category: "Shop Tools" }, { title: "SWP - Vehicle Lifting (Floor Jacks)", category: "Shop Tools" }, { title: "SWP - Welding & Cutting", category: "Shop Tools" }, { title: "SWP - Wire Cutters / Side Cutters", category: "Shop Tools" }, { title: "SWP - Wrenches", category: "Shop Tools" }, { title: "Section 7 - Maintenance Program", category: "Work Activities" }, { title: "Section 8 - Training", category: "Work Activities" }, { title: "Section 12 - Record Keeping", category: "Work Activities" }, { title: "Section 14 - Procurement and Contractor Management", category: "Work Activities" }, { title: "SWP - Basic Site Traffic Control", category: "Work Activities" }, { title: "SWP - Communication Protocols", category: "Work Activities" }, { title: "SWP - Coupling & Uncoupling Fifth Wheel", category: "Work Activities" }, { title: "SWP - Coupling & Uncoupling Tag Trailers", category: "Work Activities" }, { title: "SWP - Driving Practices", category: "Work Activities" }, { title: "SWP - Entering/Exiting Vehicle Cabs", category: "Work Activities" }, { title: "SWP - Fluid Handling & Disposal", category: "Work Activities" }, { title: "SWP - Interacting with Other Equipment", category: "Work Activities" }, { title: "SWP - Load Securement (Dump Trucks)", category: "Work Activities" }, { title: "SWP - Manual Material Handling", category: "Work Activities" }, { title: "SWP - Mid-Shift Equipment Inspection", category: "Work Activities" }, { title: "SWP - Operating Stationary Machinery", category: "Work Activities" }, { title: "SWP - Parts Handling and Storage", category: "Work Activities" }, { title: "SWP - Performing Repairs (Workshop)", category: "Work Activities" }, { title: "SWP - Post-Trip Inspection", category: "Work Activities" }, { title: "SWP - Pre-Trip Inspection", category: "Work Activities" }, { title: "SWP - Site Hazard Assessment", category: "Work Activities" }, { title: "SWP - Slips, Trips & Falls Prevention", category: "Work Activities" }, { title: "SWP - Vehicle Washing (Workshop)", category: "Work Activities" }, { title: "SWP - Waste Disposal", category: "Work Activities" }, { title: "SWP - Welding and Hot Work", category: "Work Activities" }, { title: "SWP - Working at Heights (Minor)", category: "Work Activities" }, { title: "SWP - Working in Adverse Weather", category: "Work Activities" }, { title: "SWP - Working Near Open Excavations", category: "Work Activities" }, { title: "SWP - Working Near Overhead Power Lines", category: "Work Activities" }, { title: "SWP - Working Near Underground Utilities", category: "Work Activities" }, { title: "SWP - Working Under Raised Equipment", category: "Work Activities" }, { title: "SWP - Workshop Entry & Conduct", category: "Work Activities" }, { title: "SWP - Workshop Tire Maintenance", category: "Work Activities" }, { title: "Procedure - Periodic Equipment Inspection", category: "Work Activities" }, { title: "Procedure - Tool and Shop Equipment Inspection", category: "Work Activities" }, { title: "Section 6 - Personal Protection Equipment (PPE)", category: "PPE" }, { title: "SWP - Personal Protective Equipment (PPE) Use & Maintenance", category: "PPE" }, { title: "Section 13 - Legislation", category: "Legislation" }, { title: "Section 15 - Manitoba Supplement", category: "Legislation" }, { title: "Manitoba Workplace Safety and Health Act (W210)", category: "Legislation", type: "pdf" } ]; let allDocs = []; let isAdmin = false; export async function initializeSafetyManual() { const { auth, db, doc, getDoc, collection, getDocs, addDoc, updateDoc } = window.firebaseServices; const user = auth.currentUser; if (user) { try { const userSnap = await getDoc(doc(db, "users", user.uid)); if ((userSnap.exists() && (userSnap.data().role === 'admin' || userSnap.data().role === 'office')) || user.email === 'dev@citypave.ca') { isAdmin = true; document.getElementById('admin-edit-btn').classList.remove('hidden'); document.getElementById('admin-edit-btn').addEventListener('click', () => openEditor()); document.getElementById('admin-bulk-btn').classList.remove('hidden'); document.getElementById('admin-bulk-btn').addEventListener('click', () => { document.getElementById('bulk-upload-modal').classList.remove('hidden'); }); } } catch (e) { console.error("Role check failed", e); } } setupSearchAndFilters(); setupSearchAndFilters(); setupEditor(); setupBulkUpload(); if (isAdmin) { await syncCategories(db); const q = collection(db, "safety_manual"); const snapshot = await getDocs(q); const existingTitles = snapshot.docs.map(doc => doc.data().title); const newItemsToSeed = DEFAULT_SECTIONS.filter(item => !existingTitles.includes(item.title)); if (newItemsToSeed.length > 0) { for (const section of newItemsToSeed) { await addDoc(collection(db, "safety_manual"), { title: section.title, category: section.category, type: section.type || 'text', content: '<p><em>Content to be added from Google Docs...</em></p>', updatedAt: new Date().toISOString() }); } loadManualContent(); } else { loadManualContent(); } } else { loadManualContent(); } } async function syncCategories(db) { const { collection, getDocs, updateDoc } = window.firebaseServices; const snapshot = await getDocs(collection(db, "safety_manual")); snapshot.forEach(async (docSnap) => { const data = docSnap.data(); const template = DEFAULT_SECTIONS.find(s => s.title === data.title); if (template && template.category !== data.category) { await updateDoc(docSnap.ref, { category: template.category }); } }); } async function loadManualContent() { const { db, collection, getDocs, query, orderBy } = window.firebaseServices; const container = document.getElementById('manual-content'); try { const q = query(collection(db, "safety_manual"), orderBy("title")); const snapshot = await getDocs(q); allDocs = []; snapshot.forEach(doc => allDocs.push({ id: doc.id, ...doc.data() })); renderDocs(allDocs); const searchInput = document.getElementById('safety-search'); if (searchInput && searchInput.value) { searchInput.dispatchEvent(new Event('input')); } } catch (error) { console.error("Error loading manual:", error); container.innerHTML = '<p class="text-center text-red-500">Failed to load manual.</p>'; } } function renderDocs(docs) { const container = document.getElementById('manual-content'); container.innerHTML = ''; if (docs.length === 0) { container.innerHTML = '<div class="text-center py-10"><p class="text-gray-400 font-medium">No documents found.</p></div>'; return; } docs.sort((a, b) => { const numA = parseInt(a.title.match(/Section (\d+)/)?.[1]) || 999; const numB = parseInt(b.title.match(/Section (\d+)/)?.[1]) || 999; if (numA !== numB) return numA - numB; return a.title.localeCompare(b.title); }); docs.forEach(doc => { const icon = doc.type === 'pdf' ? `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>` : `<svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`; const categoryColor = { "Policies": "text-purple-500 bg-purple-50", "Emergency": "text-red-600 bg-red-50", "Heavy Equipment": "text-blue-600 bg-blue-50", "Shop Tools": "text-indigo-600 bg-indigo-50", "Work Activities": "text-gray-600 bg-gray-50", "PPE": "text-orange-600 bg-orange-50", "Legislation": "text-gray-800 bg-gray-200" }[doc.category] || "text-gray-500 bg-gray-50"; const el = document.createElement('div'); el.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-blue-400 transition-colors cursor-pointer flex items-center justify-between group"; el.innerHTML = ` <div class="flex items-center gap-4 overflow-hidden"> <div class="flex-shrink-0 bg-gray-50 p-2 rounded-lg">${icon}</div> <div class="min-w-0"> <h3 class="font-bold text-gray-800 truncate text-sm md:text-base">${doc.title}</h3> <span class="text-[10px] uppercase tracking-wide font-bold px-2 py-0.5 rounded ${categoryColor}">${doc.category}</span> </div> </div> ${isAdmin ? `<button class="edit-doc-icon hidden group-hover:block text-gray-400 hover:text-blue-600 p-2" title="Edit"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button>` : ''} `; el.addEventListener('click', (e) => { if (e.target.closest('.edit-doc-icon')) { openEditor(doc); } else { openViewer(doc); } }); container.appendChild(el); }); } function openViewer(doc) { const modal = document.getElementById('doc-viewer-modal'); const title = document.getElementById('viewer-title'); const body = document.getElementById('viewer-body'); const editBtn = document.getElementById('viewer-edit-btn'); if (isAdmin) { editBtn.classList.remove('hidden'); editBtn.onclick = () => { modal.classList.add('hidden'); openEditor(doc); }; } else { editBtn.classList.add('hidden'); } title.textContent = doc.title; if (doc.type === 'pdf' && doc.contentUrl) { body.innerHTML = `<iframe src="${doc.contentUrl}" class="w-full h-full border-0" title="PDF Viewer"></iframe>`; } else { body.innerHTML = `<div class="prose max-w-none text-sm md:text-base whitespace-pre-wrap">${doc.content || ''}</div>`; } modal.classList.remove('hidden'); } function setupSearchAndFilters() { const searchInput = document.getElementById('safety-search'); const categoryBtns = document.querySelectorAll('.category-btn'); const urlParams = new URLSearchParams(window.location.search); const initialSearch = urlParams.get('search'); if (initialSearch) { searchInput.value = initialSearch; } const filterDocs = () => { const term = searchInput.value.toLowerCase(); const activeCat = document.querySelector('.category-btn.active').dataset.cat; const filtered = allDocs.filter(doc => { const matchesSearch = doc.title.toLowerCase().includes(term) || (doc.content || '').toLowerCase().includes(term); const matchesCat = activeCat === 'all' || doc.category === activeCat; return matchesSearch && matchesCat; }); renderDocs(filtered); }; searchInput.addEventListener('input', filterDocs); categoryBtns.forEach(btn => { btn.addEventListener('click', () => { categoryBtns.forEach(b => { b.classList.remove('active', 'bg-blue-600', 'text-white'); b.classList.add('bg-gray-200', 'text-gray-700'); }); btn.classList.add('active', 'bg-blue-600', 'text-white'); btn.classList.remove('bg-gray-200', 'text-gray-700'); filterDocs(); }); }); } function setupEditor() { const saveBtn = document.getElementById('save-doc-btn'); const typeSelect = document.getElementById('edit-doc-type'); const deleteBtn = document.getElementById('delete-doc-btn'); typeSelect.addEventListener('change', (e) => { if (e.target.value === 'pdf') { document.getElementById('editor-text-container').classList.add('hidden'); document.getElementById('editor-pdf-container').classList.remove('hidden'); } else { document.getElementById('editor-text-container').classList.remove('hidden'); document.getElementById('editor-pdf-container').classList.add('hidden'); } }); saveBtn.addEventListener('click', saveDocument); deleteBtn.addEventListener('click', deleteDocument); } function openEditor(docData = null) { const modal = document.getElementById('admin-editor-modal'); const deleteBtn = document.getElementById('delete-doc-btn'); document.getElementById('edit-doc-id').value = docData ? docData.id : ''; document.getElementById('edit-doc-title').value = docData ? docData.title : ''; document.getElementById('edit-doc-category').value = docData ? docData.category : 'Policies'; document.getElementById('edit-doc-type').value = docData ? docData.type : 'text'; document.getElementById('edit-doc-content').value = docData ? docData.content : ''; document.getElementById('current-file-link').textContent = docData?.contentUrl ? 'Current PDF: ' + docData.contentUrl.split('%2F').pop().split('?')[0] : ''; document.getElementById('edit-doc-file').value = ''; document.getElementById('edit-doc-type').dispatchEvent(new Event('change')); if (docData) deleteBtn.classList.remove('hidden'); else deleteBtn.classList.add('hidden'); modal.classList.remove('hidden'); } async function saveDocument() { const btn = document.getElementById('save-doc-btn'); const id = document.getElementById('edit-doc-id').value; const title = document.getElementById('edit-doc-title').value; const category = document.getElementById('edit-doc-category').value; const type = document.getElementById('edit-doc-type').value; const contentText = document.getElementById('edit-doc-content').value; const fileInput = document.getElementById('edit-doc-file'); if (!title) return alert("Title is required."); btn.disabled = true; btn.textContent = "Saving..."; const { db, collection, addDoc, doc, updateDoc, storage, ref, uploadBytes, getDownloadURL } = window.firebaseServices; try { let data = { title, category, type, updatedAt: new Date().toISOString() }; if (type === 'text') { data.content = contentText; data.contentUrl = null; } else if (fileInput.files.length > 0) { const file = fileInput.files[0]; const storageRef = ref(storage, `safety_manual/${Date.now()}_${file.name}`); await uploadBytes(storageRef, file); data.contentUrl = await getDownloadURL(storageRef); data.content = null; } if (id) await updateDoc(doc(db, "safety_manual", id), data); else await addDoc(collection(db, "safety_manual"), data); document.getElementById('admin-editor-modal').classList.add('hidden'); loadManualContent(); } catch (error) { alert("Save failed: " + error.message); } finally { btn.disabled = false; btn.textContent = "Save Document"; } } async function deleteDocument() { const id = document.getElementById('edit-doc-id').value; if (!id || !confirm("Are you sure?")) return; const { db, doc, deleteDoc } = window.firebaseServices; try { await deleteDoc(doc(db, "safety_manual", id)); document.getElementById('admin-editor-modal').classList.add('hidden'); loadManualContent(); } catch (e) { alert(e.message); } } let bulkFiles = []; function setupBulkUpload() { const dropZone = document.getElementById('drop-zone'); const fileInput = document.getElementById('bulk-file-input'); const uploadBtn = document.getElementById('start-bulk-upload-btn'); dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-blue-50', 'border-blue-400'); }); dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('bg-blue-50', 'border-blue-400'); }); dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('bg-blue-50', 'border-blue-400'); handleFiles(e.dataTransfer.files); }); dropZone.addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', (e) => handleFiles(e.target.files)); uploadBtn.addEventListener('click', executeBulkUpload); } function handleFiles(files) { const list = document.getElementById('upload-preview-list'); const btn = document.getElementById('start-bulk-upload-btn'); const newFiles = Array.from(files).filter(f => f.type === 'application/pdf'); if (newFiles.length === 0) return alert("Only PDF files are allowed."); bulkFiles = [...bulkFiles, ...newFiles]; if (bulkFiles.length > 0) { list.innerHTML = ''; btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); } bulkFiles.forEach((file, index) => { const category = guessCategory(file.name); const el = document.createElement('div'); el.className = "flex items-center justify-between bg-white p-3 rounded border shadow-sm"; el.innerHTML = ` <div class="flex items-center gap-3 overflow-hidden"> <svg class="w-8 h-8 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg> <div class="min-w-0"> <p class="font-bold text-sm truncate text-gray-800">${file.name}</p> <select class="text-xs border rounded bg-gray-50 p-1 mt-1 category-selector" data-index="${index}"> ${getCategoryOptions(category)} </select> </div> </div> <button class="text-gray-400 hover:text-red-500 p-2 remove-file-btn" data-index="${index}">&times;</button> `; list.appendChild(el); }); document.querySelectorAll('.remove-file-btn').forEach(b => { b.addEventListener('click', (e) => { const idx = parseInt(e.target.dataset.index); bulkFiles.splice(idx, 1); handleFiles([]); renderPreviewList(); }); }); } function renderPreviewList() { const list = document.getElementById('upload-preview-list'); const btn = document.getElementById('start-bulk-upload-btn'); list.innerHTML = ''; if (bulkFiles.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 py-8 text-sm">No files selected yet.</p>'; btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); return; } bulkFiles.forEach((file, index) => { const category = guessCategory(file.name); const el = document.createElement('div'); el.className = "flex items-center justify-between bg-white p-3 rounded border shadow-sm"; el.innerHTML = ` <div class="flex items-center gap-3 overflow-hidden"> <svg class="w-8 h-8 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg> <div class="min-w-0"> <p class="font-bold text-sm truncate text-gray-800">${file.name}</p> <select class="text-xs border rounded bg-gray-50 p-1 mt-1 category-selector" id="cat-select-${index}"> ${getCategoryOptions(category)} </select> </div> </div> <button class="text-gray-400 hover:text-red-500 p-2" onclick="removeBulkFile(${index})">&times;</button> `; list.appendChild(el); }); } window.removeBulkFile = (index) => { bulkFiles.splice(index, 1); renderPreviewList(); }; function getCategoryOptions(selected) { const cats = ["Policies", "Emergency", "Heavy Equipment", "Shop Tools", "Work Activities", "PPE", "Legislation"]; return cats.map(c => `<option value="${c}" ${c === selected ? 'selected' : ''}>${c}</option>`).join(''); } function guessCategory(filename) { const lower = filename.toLowerCase(); if (lower.includes('policy') || lower.includes('rule') || lower.includes('section 1') || lower.includes('section 2') || lower.includes('section 5') || lower.includes('section 9') || lower.includes('section 10')) return 'Policies'; if (lower.includes('emergency') || lower.includes('fire') || lower.includes('spill') || lower.includes('accident') || lower.includes('section 3') || lower.includes('section 11')) return 'Emergency'; if (lower.includes('truck') || lower.includes('loader') || lower.includes('excavator') || lower.includes('skid steer') || lower.includes('trailer') || lower.includes('section 4')) return 'Heavy Equipment'; if (lower.includes('tool') || lower.includes('wrench') || lower.includes('hammer') || lower.includes('saw') || lower.includes('drill') || lower.includes('grinder') || lower.includes('jack') || lower.includes('hoist')) return 'Shop Tools'; if (lower.includes('ppe') || lower.includes('personal protection') || lower.includes('section 6')) return 'PPE'; if (lower.includes('legislation') || lower.includes('act') || lower.includes('regulation') || lower.includes('section 13') || lower.includes('section 15')) return 'Legislation'; return 'Work Activities'; } async function executeBulkUpload() { const btn = document.getElementById('start-bulk-upload-btn'); const { db, collection, addDoc, storage, ref, uploadBytes, getDownloadURL } = window.firebaseServices; btn.disabled = true; btn.textContent = "Uploading... (0/" + bulkFiles.length + ")"; let successCount = 0; for (let i = 0; i < bulkFiles.length; i++) { const file = bulkFiles[i]; const category = document.getElementById(`cat-select-${i}`).value; const title = file.name.replace('.pdf', '').replace(/_/g, ' '); try { const storageRef = ref(storage, `safety_manual/${category}/${Date.now()}_${file.name}`); await uploadBytes(storageRef, file); const url = await getDownloadURL(storageRef); await addDoc(collection(db, "safety_manual"), { title: title, category: category, type: 'pdf', contentUrl: url, content: null, updatedAt: new Date().toISOString() }); successCount++; btn.textContent = `Uploading... (${successCount}/${bulkFiles.length})`; } catch (error) { console.error("Failed to upload", file.name, error); } } alert(`Upload Complete! ${successCount} of ${bulkFiles.length} files uploaded.`); document.getElementById('bulk-upload-modal').classList.add('hidden'); bulkFiles = []; renderPreviewList(); btn.textContent = "Upload All Files"; btn.disabled = false; loadManualContent(); }