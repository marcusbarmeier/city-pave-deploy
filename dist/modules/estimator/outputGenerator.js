// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { pricingOptions, GST_RATE } from './pricing.js'; function formatCurrency(amount) { return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(amount || 0); } function renderFinancialSummary(summaryData, selectedTotalPrice) { const items = summaryData?.items || []; if (items.length === 0 && selectedTotalPrice === 0) { return ''; } let totalPaid = 0; let totalAdjustments = 0; let unpaidRowsHtml = ''; let paidRowsHtml = ''; items.forEach(item => { const amount = parseFloat(item.amount) || 0; const dueDate = item.dueDate || 'N/A'; const description = item.description || 'Line Item'; if (item.isPaid) { totalPaid += amount; paidRowsHtml += `<tr><td>${description}</td><td class="text-right">${formatCurrency(amount)}</td><td class="text-right">Paid</td></tr>`; } else { if ((item.type === 'adjustment' || item.type === 'holdback') && amount < 0) { totalAdjustments += amount; } unpaidRowsHtml += `<tr><td>${description}</td><td class="text-right">${formatCurrency(amount)}</td><td class="text-right">${dueDate}</td></tr>`; } }); const adjustedTotal = selectedTotalPrice + totalAdjustments; const remainingBalance = adjustedTotal - totalPaid; let unpaidTableHtml = ''; if (unpaidRowsHtml) { unpaidTableHtml = ` <h3 style="font-size: 11pt; margin-bottom: 0.8rem; color: #111827; margin-top: 1rem;">Payment Schedule (Due)</h3> <table class="summary-table"> <thead><tr><th>Description</th><th class="text-right">Amount</th><th class="text-right">Due Date</th></tr></thead> <tbody>${unpaidRowsHtml}</tbody> </table>`; } let paidTableHtml = ''; if (paidRowsHtml) { paidTableHtml = ` <h3 style="font-size: 11pt; margin-bottom: 0.8rem; color: #111827; margin-top: 1rem;">Payment History (Received)</h3> <table class="summary-table"> <thead><tr><th>Description</th><th class="text-right">Amount</th><th class="text-right">Status</th></tr></thead> <tbody>${paidRowsHtml}</tbody> </table>`; } const interestRate = summaryData.interestRate || 2; return ` <div class="section" id="print-section-financial-summary"> <h2>Financial Summary & Payment Schedule</h2> <table class="summary-table" style="margin-bottom: 1.5rem;"> <tbody> <tr><td>Total Contract Amount</td><td class="text-right">${formatCurrency(selectedTotalPrice)}</td></tr> <tr><td>Total Adjustments (Discounts/Holdbacks)</td><td class="text-right" style="color: #DC2626;">${formatCurrency(totalAdjustments)}</td></tr> <tr class="total-row" style="border-top-width: 1.5px; border-color: #1F2937;"> <td>Adjusted Contract Total</td> <td class="text-right">${formatCurrency(adjustedTotal)}</td> </tr> </tbody> </table> ${unpaidTableHtml} ${paidTableHtml} <table class="summary-table" style="margin-top: 1.5rem; border-top-width: 1.5px; border-color: #1F2937;"> <tbody> <tr><td>Amount Paid to Date</td><td class="text-right" style="color: #16A34A;">${formatCurrency(totalPaid)}</td></tr> <tr class="total-row"> <td>Total Remaining Balance</td> <td class="text-right">${formatCurrency(remainingBalance)}</td> </tr> </tbody> </table> <p style="font-size: 7pt; color: #6B7280; margin-top: 0.5rem;">A late payment charge of ${interestRate}% per month will be applied to all overdue accounts.</p> </div> `; } function renderSnowRouteSection(mapUrl, locations, order, clientName, estimateId) { if (!locations || locations.length === 0) return ''; let orderedLocations = [...locations]; if (order && order.length > 0) { const orderMap = new Map(order.map((id, index) => [id, index])); orderedLocations.sort((a, b) => { const indexA = orderMap.get(a.id); const indexB = orderMap.get(b.id); if (indexA === undefined && indexB === undefined) return 0; if (indexA === undefined) return 1; if (indexB === undefined) return -1; return indexA - indexB; }); } const locationDetailsHtml = orderedLocations.map((loc, index) => { const sketchLinkHtml = loc.sourceSketchId && estimateId ? `<a href="sketch.html?estimateId=${estimateId}&sketchId=${loc.sourceSketchId}&address=${encodeURIComponent(loc.address || '')}" target="_blank" class="text-blue-600 hover:underline text-xs ml-2">(View Sketch)</a>` : ''; return ` <div class="snow-location-item"> <h4>${index + 1}. ${loc.title || 'Unnamed Location'} ${sketchLinkHtml }</h4> <p><strong>Address:</strong> ${loc.address || 'N/A'}</p> <p><strong>Est. Time:</strong> ${loc.timeToComplete?.toFixed(1) || 'N/A'} hrs | <strong>Trigger:</strong> ${loc.clearingTrigger || 'N/A'}</p> <p><strong>Equipment:</strong> ${loc.equipmentInfo || 'Details unavailable'}</p> {} <p><strong>Seasonal Cost:</strong> ${formatCurrency(loc.priceSeasonal)}</p> </div> `; }).join(''); const mapImageHtml = mapUrl ? `<div class="snow-route-map"><img src="${mapUrl}" alt="Snow Route Map"></div>` : ''; return ` <div class="section snow-route-section" id="print-section-snow"> <h2>Snow Route Plan</h2> <div class="snow-route-content"> ${mapImageHtml} <div class="snow-route-details"> <h3>Route Stops for ${clientName || 'Client'}</h3> ${locationDetailsHtml} </div> </div> </div> `; } function renderBeforeAndAfterSection(pairs, MAPS_API_KEY) { if (!pairs || pairs.length === 0) { return ''; } const buildSection = (title, content, extraClasses = '', id = '') => { const finalContent = (!content || content.trim() === '') ? '<p style="color: #9ca3af; font-style: italic;">(No content provided for this section)</p>' : content; const idAttr = id ? ` id="${id}"` : ''; return `<div class="section ${extraClasses}"${idAttr}><h2>${title}</h2><div class="section-content">${finalContent}</div></div>`; }; const renderMediaGrid = (mediaList) => { if (!mediaList || mediaList.length === 0) return '<p style="font-size: 7.5pt; color: #9ca3af;">(No media)</p>'; return mediaList.map(media => { if (media.type === 'video') { return `<div class="image-grid-ba-item"><p style="font-size: 7.5pt; color: #6B7280;">[Video: <a href="${media.url}" target="_blank">View Online</a>]</p></div>`; } else { return `<div class="image-grid-ba-item"><img src="${media.url}" alt="Work Photo"></div>`; } }).join(''); }; const pairsHtml = pairs.map(pair => { const allLocations = [...(pair.beforePhotos || []), ...(pair.afterPhotos || [])] .map(p => p.location) .filter(loc => loc && typeof loc.lat === 'number'); let mapHtml = ''; if (allLocations.length > 0) { const uniqueLocations = [...new Map(allLocations.map(item => [`${item.lat},${item.lng}`, item])).values()]; const markers = uniqueLocations.map(loc => `&markers=color:red%7C${loc.lat},${loc.lng}`).join(''); const mapUrl = `https: mapHtml = `<div class="ba-map-container"><h4>Media Locations</h4><img src="${mapUrl}" alt="Map of media locations"></div>`; } return ` <div class="before-after-block"> <h3>${pair.title || 'Work Showcase'}</h3> ${mapHtml} <div class="ba-grid"> <div> <h4>Before</h4> <div class="image-grid-ba">${renderMediaGrid(pair.beforePhotos)}</div> </div> <div> <h4>After</h4> <div class="image-grid-ba">${renderMediaGrid(pair.afterPhotos)}</div> </div> </div> ${pair.description && pair.description !== '<p><br></p>' ? `<div class="notes-section"><h4>Description & Notes</h4><div class="quill-content">${pair.description}</div></div>` : ''} </div> `; }).join(''); return buildSection('Before & After Work Showcase', pairsHtml, '', 'print-section-before-after'); } export function generatePrintableEstimateHTML(estimateData, options = {}) { const config = window.appConfig || { name: 'City Pave', logo_light: 'https: phone: '(431) 482-5688', email: 'Info@citypave.ca', address: '9-2310 Logan Ave, Winnipeg, Manitoba, R2R 2T8', }; const MAPS_API_KEY = "AIzaSyADrnYgh1fSTo3IZD7HOEJMyjduzDYIYSs"; const renderQuill = (content) => { if (!content || content === '<p><br></p>') return ''; return `<div class="quill-content">${content}</div>`; }; const buildSection = (title, content, extraClasses = '', id = '') => { const finalContent = (!content || content.trim() === '') ? '<p style="color: #9ca3af; font-style: italic;">(No content provided for this section)</p>' : content; const idAttr = id ? ` id="${id}"` : ''; const newClasses = `cover-page-visual-appendix ${extraClasses}`; return `<div class="section ${newClasses}"${idAttr}><h2>${title}</h2><div class="section-content">${finalContent}</div></div>`; }; let mostRecentVisitDate = 'N/A'; if (estimateData.siteVisits && estimateData.siteVisits.length > 0) { const sortedVisits = [...estimateData.siteVisits].filter(v => v.date).sort((a, b) => new Date(b.date) - new Date(a.date)); if (sortedVisits.length > 0) mostRecentVisitDate = new Date(sortedVisits[0].date + 'T00:00:00').toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' }); } const { initialContactDate, followUpDate, source, description } = estimateData.contactHistory || {}; const overviewSectionHtml = ` <div class="overview-section"> <h4>Project & Contact Overview</h4> <div class="overview-grid"> <div><span>Tentative Start</span><strong>${estimateData.tentativeStartDate || 'TBD'}</strong></div> <div><span>Proof Roll</span><strong>${estimateData.tentativeProofRollDate || 'TBD'}</strong></div> <div><span>Completion</span><strong>${estimateData.tentativeEndDate || 'TBD'}</strong></div> <div><span>Last Visit</span><strong>${mostRecentVisitDate}</strong></div> <div><span>Initial Contact</span><strong>${initialContactDate || 'N/A'}</strong></div> <div><span>Follow-up</span><strong>${followUpDate || 'N/A'}</strong></div> <div><span>Source</span><strong>${source || 'N/A'}</strong></div> </div> ${renderQuill(description)} </div> `; let visualContent = ''; if (estimateData.propertyPhotoURL) { visualContent += `<div class="image-block"><img src="${estimateData.propertyPhotoURL}" alt="Property Photo"><h4>Property Photo</h4></div>`; } else if (estimateData.customerInfo?.address) { const streetViewUrl = `https: visualContent += `<div class="image-block"><img src="${streetViewUrl}" alt="Property Photo"><h4>Property Photo (Street View)</h4></div>`; } if (estimateData.customerInfo?.address) { const mapUrl = `https: visualContent += `<div class="image-block"><img src="${mapUrl}" alt="Location Map"><h4>Location Map</h4></div>`; } (estimateData.sketches || []).forEach((sketch, i) => { visualContent += `<div class="image-block sketch-block"><img src="${sketch.screenshotUrl}" alt="Sketch"><h4>${sketch.title || `Sketch #${i + 1}`}</h4></div>`; }); const coverPageHtml = ` <div class="cover-page-section"> <div class="cover-main"> <img src="${config.logo_light}" alt="${config.name} Logo" class="cover-logo"> <h1>Estimate</h1> <div class="cover-details"> <p><strong>Date:</strong> ${new Date(estimateData.lastSaved || Date.now()).toLocaleDateString()}</p> <p><strong>Estimate #:</strong> ${estimateData.id ? estimateData.id.substring(0, 6).toUpperCase() : 'N/A'}</p> </div> </div> <div class="info-grid"> <div class="info-box"> <h4>Prepared For</h4> <p> <strong>${estimateData.customerInfo?.name || ''}</strong><br> ${estimateData.customerInfo?.address || ''}<br> ${estimateData.customerInfo?.phone || ''}<br> ${estimateData.customerInfo?.email || ''} </p> </div> <div class="info-box"> <h4>Our Information</h4> <p> <strong>${config.name}</strong><br> Marcus Barmeier<br> Cell: (204) 293-9742 | Office: ${config.phone}<br> ${config.email} </p> </div> </div> ${buildSection('Visual Appendix', `<div class="image-grid">${visualContent}</div>`, '', 'print-section-sketches')} ${overviewSectionHtml} </div> `; let mainContentHtml = ''; const scopeContent = (renderQuill(estimateData.scopeOfWork?.manual) || '') + (renderQuill(estimateData.scopeOfWork?.auto) || ''); mainContentHtml += buildSection('General Scope of Work', scopeContent, '', 'print-section-scope'); mainContentHtml += renderBeforeAndAfterSection(estimateData.beforeAndAfter, MAPS_API_KEY); const appendixContent = renderQuill(estimateData.appendixContent); mainContentHtml += buildSection('Our Process Overview', appendixContent, '', 'print-section-appendix'); const allOptions = [ ...(estimateData.pricing?.dynamicOptions || []), { title: 'Sketch Pricing', id: 'sketch', ...(estimateData.pricing?.options?.sketch || { items: [] }) }, { title: 'Change Order', id: 'change-order', ...(estimateData.pricing?.options?.['change-order'] || { items: [], enabled: false }) } ]; mainContentHtml += renderSnowRouteSection( estimateData.snowRouteMapUrl, estimateData.snowLocations, estimateData.snowRouteOrder, estimateData.customerInfo?.name, estimateData.id ); const pricingContent = allOptions.map(opt => { if (!opt) return ''; if (opt.id === 'change-order' && !(opt.enabled && opt.items && opt.items.length > 0)) { return ''; } if (opt.id === 'sketch' && (!opt.items || opt.items.length === 0)) { return ''; } if (opt.id && opt.id.startsWith('option-')) { if ((!opt.title || opt.title.trim() === '') && (!opt.items || opt.items.length === 0)) { return ''; } } const items = opt.items || []; const title = opt.title || 'Pricing Option'; const subtotal = items.reduce((sum, item) => sum + (item.units || 0) * (item.unitPrice || 0), 0); const gst = subtotal * GST_RATE; const total = subtotal + gst; let summaryParts = []; const summary = opt.summary || {}; if (summary.sqft) summaryParts.push(`<strong>Total Area:</strong> ${summary.sqft} sq ft`); if (summary.thickness && summary.thickness !== 'none') summaryParts.push(`<strong>Asphalt Thickness:</strong> ${summary.thickness.replace('-', ' ')}`); if (summary.tonnage) summaryParts.push(`<strong>Est. Tonnage:</strong> ${summary.tonnage}`); if (summary.demo === 'Yes') summaryParts.push(`<strong>Demolition:</strong> Yes`); if (summary.basework === 'Yes') summaryParts.push(`<strong>Basework:</strong> Yes`); if (summary.excavation === 'Yes') summaryParts.push(`<strong>Excavation:</strong> Yes`); const projectSummaryHtml = summaryParts.length > 0 ? `<p class="project-summary"><em>Project Summary: ${summaryParts.join(' | ')}</em></p>` : ''; const warrantyHtml = summary.warranty ? `<div class="warranty-info"><h4>Warranty</h4><p>${summary.warranty}</p></div>` : ''; const firstItemColor = (items.length > 0 && items[0].color) ? items[0].color : '#cccccc'; const colorBarHtml = `<div style="width: 100%; height: 10px; background-color: ${firstItemColor}; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); margin-bottom: 4px;"></div>`; return ` <div class="price-option-block"> ${colorBarHtml} <h3>${title}</h3> ${projectSummaryHtml} <table class="price-table"> <thead><tr><th>Description</th><th>Units</th><th>Unit Price</th><th>Total</th></tr></thead> <tbody> ${items.map(item => ` <tr> <td> <div style="display: flex; align-items: flex-start; gap: 8px;"> <div style="width: 16px; height: 16px; background-color: ${item.color || '#ccc'}; border: 1px solid #ccc; border-radius: 3px; flex-shrink: 0; margin-top: 4px;"></div> <div> <strong>${pricingOptions.find(p => p.id === item.product)?.name || item.product}</strong> ${renderQuill(item.description)} </div> </div> </td> <td class="text-right">${(item.units || 0) > 0 ? item.units.toFixed(2) : '-'}</td> <td class="text-right">${formatCurrency(item.unitPrice)}</td> <td class="text-right">${formatCurrency((item.units || 0) * (item.unitPrice || 0))}</td> </tr>`).join('')} </tbody> </table> <table class="summary-table option-summary-table"> <tbody> <tr><td>Subtotal</td><td class="text-right">${formatCurrency(subtotal)}</td></tr> <tr><td>GST (${(GST_RATE * 100)}%)</td><td class="text-right">${formatCurrency(gst)}</td></tr> <tr class="total-row"><td>Option Total</td><td class="text-right">${formatCurrency(total)}</td></tr> </tbody> </table> ${warrantyHtml} </div>`; }).join(''); mainContentHtml += buildSection('Investment & Pricing Details', pricingContent, '', 'print-section-pricing-options'); let finalPageHtml = ''; let selectedSubtotal = 0; const selectedOptionIds = estimateData.pricing?.selectedOptions || []; if (selectedOptionIds.length > 0) { selectedOptionIds.forEach(optionId => { const foundOption = allOptions.find(opt => opt.id === optionId); if (foundOption) selectedSubtotal += (foundOption.items || []).reduce((s, i) => s + (i.units || 0) * (i.unitPrice || 0), 0); }); } const selectedGst = selectedSubtotal * GST_RATE; const selectedTotalPrice = selectedSubtotal + selectedGst; finalPageHtml += ` <div class="section"> <h2>Pricing Summary (for Selected Options)</h2> <table class="summary-table"> <tbody> <tr><td>Subtotal</td><td class="text-right">${formatCurrency(selectedSubtotal)}</td></tr> <tr><td>GST (${(GST_RATE * 100)}%)</td><td class="text-right">${formatCurrency(selectedGst)}</td></tr> <tr class="total-row"><td>Total Investment</td><td class="text-right">${formatCurrency(selectedTotalPrice)}</td></tr> </tbody> </table> </div> `; finalPageHtml += renderFinancialSummary(estimateData.financialSummary, selectedTotalPrice); if (!options.hideAcceptance) { finalPageHtml += renderAcceptanceSection(estimateData.acceptance, config.name, estimateData.customerNotes); } const termsContent = (renderQuill(estimateData.terms) || '') .replace(/\[Your Company Name\]/g, config.name) .replace(/\{config\.name\}/g, config.name); finalPageHtml += buildSection('Terms and Conditions', termsContent, '', 'print-section-terms'); const styles = ` <style> @import url('https: :root { --accent-color: #2563EB; --text-light: #6B7280; --border-light: #E5E7EB; } .printable-estimate { font-family: 'Inter', sans-serif; color: #1F2937; font-size: 8pt; line-height: 1.35; } .cover-logo { height: 35px; width: auto; object-fit: contain; margin-bottom: 1.2rem; } h1, h2, h3, h4 { font-weight: 600; margin: 0; } h2 { color: var(--accent-color); } h3 { font-size: 11pt; margin-bottom: 0.8rem; color: #111827; } h4 { font-size: 9.5pt; font-weight: 600; margin-bottom: 0.4rem; color: #374151; } p { margin: 0; line-height: 1.4; } strong { font-weight: 500; color: #111827; } .text-right { text-align: right; } .cover-main { text-align: center; padding: 1in 0; } .cover-main h1 { font-size: 26pt; margin-bottom: 0.5rem; color: #111827; } .cover-details { color: var(--text-light); font-size: 8.5pt; } .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding-top: 0.8rem; border-top: 1px solid var(--border-light); } .info-box h4 { font-size: 7.5pt; color: var(--text-light); margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.5px; } .info-box p { font-size: 8.5pt; line-height: 1.4; } .overview-section { margin-top: 1.2rem; padding-top: 0.8rem; border-top: 1px solid var(--border-light); } .overview-section h4 { text-align: center; font-size: 7.5pt; color: var(--text-light); margin-bottom: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; } .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 0.8rem; text-align: center; margin-bottom: 0.8rem; padding: 0.8rem; background-color: #F9FAFB; border-radius: 6px; } .overview-grid div span { font-size: 7pt; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 0.2rem; } .overview-grid div strong { font-size: 9pt; } .overview-section .quill-content { padding: 0.4rem 0.8rem; font-size: 8pt; text-align: center; color: var(--text-light); font-style: italic; } .cover-page-visual-appendix { margin-top: 1.2rem; padding-top: 0.8rem; border-top: 1px solid var(--border-light); } .cover-page-visual-appendix .image-grid { grid-template-columns: 1fr 1fr 1fr; } .cover-page-visual-appendix .sketch-block { grid-column: 1 / -1; } .section { margin-bottom: 1.2rem; } .section h2 { font-size: 13pt; padding-bottom: 0.4rem; border-bottom: 1.5px solid #1F2937; margin-bottom: 0.8rem; } .quill-content { font-size: 8.5pt; line-height: 1.5; } .quill-content p, .quill-content li { margin-bottom: 0.5rem; } table { width: 100%; border-collapse: collapse; } th, td { padding: 0.4rem 0; border-bottom: 1px solid var(--border-light); vertical-align: top; } thead { border-bottom: 1.5px solid #374151; } thead th { background-color: #F9FAFB; padding: 0.4rem; text-align: right; font-weight: 600; color: var(--text-light); font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.5px; } thead th:first-child { text-align: left; } .summary-table tbody tr:last-child td { border-bottom: none; } .total-row td { font-size: 10pt; font-weight: 700; color: var(--accent-color); padding-top: 0.6rem !important; } .image-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; } .sketch-block { grid-column: 1 / -1; } .image-block img { width: 100%; border-radius: 4px; border: 1px solid var(--border-light); margin-bottom: 0.4rem; } .image-block h4 { font-size: 8pt; color: var(--text-light); text-align: center; } .price-option-block { margin-bottom: 1.5rem; } .price-table td { padding: 0.6rem; } .option-summary-table { margin-top: 0.5rem; width: 50%; margin-left: auto; } .option-summary-table td { font-size: 8.5pt; padding: 0.25rem 0; border-bottom: 1px solid var(--border-light); } .project-summary { font-size: 8pt; color: #4B5563; margin-bottom: 0.75rem; border-bottom: 1px dashed var(--border-light); padding-bottom: 0.5rem;} .warranty-info { margin-top: 1rem; padding-top: 0.5rem; border-top: 1px dashed var(--border-light); } .warranty-info h4 { font-weight: 600; font-size: 8.5pt; margin-bottom: 0.2rem; } .warranty-info p { font-size: 8pt; color: #6B7280; } .acceptance-section { margin-top: auto; border-top: 1.5px solid #1F2937; padding-top: 1.2rem; } .acceptance-section p { margin-bottom: 1.5rem; font-size: 8pt; } .signature-area-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; } .signature-box { display: flex; flex-direction: column; justify-content: flex-end; border-top: 1px solid #1F2937; padding-top: 0.4rem; height: 75px; } .signature-box.signed { height: auto; border: none; padding-top: 0; } .signature-image { min-height: 40px; max-height: 40px; object-fit: contain; object-position: left bottom; width: auto; margin-bottom: 0.4rem; } .printed-name { font-weight: 500; min-height: 1.1em; border-bottom: 1px solid #1F2937; padding-bottom: 0.2rem; } .date-box { border-top: 1px solid #1F2937; padding-top: 0.4rem; margin-bottom: 1.5rem; } .date-box.signed { border: none; text-align: center; margin-top: 1.5rem; padding-top: 0.8rem; border-top: 1px solid var(--border-light); } .signed-date { font-weight: 500; } .signature-area-grid label, .date-box label { font-size: 7.5pt; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 0.2rem; } .customer-notes-section { margin-top: 1.5rem; padding: 0.8rem; background-color: #F9FAFB; border-radius: 6px; } .customer-notes-section h4 { font-size: 9.5pt; margin-bottom: 0.4rem; } .ba-map-container { margin-bottom: 1rem; } .ba-map-container h4 { text-align: center; margin-bottom: 0.5rem; color: var(--text-light); } .ba-map-container img { width: 100%; border-radius: 4px; border: 1px solid var(--border-light); } .before-after-block { margin-bottom: 1.5rem; border-top: 1px solid var(--border-light); padding-top: 1.2rem; } .before-after-block:first-child { border-top: none; padding-top: 0; } .ba-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; } .image-grid-ba { display: grid; grid-template-columns: 1fr; gap: 0.5rem; } .image-grid-ba-item img { width: 100%; border-radius: 4px; border: 1px solid var(--border-light); } .notes-section { margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px dashed var(--border-light); } .snow-route-section { } .snow-route-content { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start; } .snow-route-map img { width: 100%; border: 1px solid var(--border-light); border-radius: 4px; } .snow-route-details h3 { font-size: 10pt; margin-bottom: 0.5rem; } .snow-location-item { border-bottom: 1px dashed var(--border-light); padding-bottom: 0.5rem; margin-bottom: 0.5rem; } .snow-location-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; } .snow-location-item h4 { font-size: 9pt; font-weight: 600; margin-bottom: 0.2rem; } .snow-location-item p { font-size: 8pt; margin: 0; line-height: 1.3; } @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } body > *:not(.printable-estimate) { display: none; } .printable-estimate { display: block; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; } .section, .price-option-block, .before-after-block, .snow-location-item, .info-box, .signature-area-grid, .acceptance-section { page-break-inside: avoid; } .cover-page-section { page-break-after: always; } .final-page-wrapper { page-break-before: always; } h2, h3 { page-break-after: avoid; } table, thead, tbody, tr { page-break-inside: avoid; } } </style> `; const currentUser = window.currentUser; const isPremium = currentUser && (currentUser.role === 'admin' || currentUser.subscription === 'premium'); let watermarkHtml = ''; let watermarkCss = ''; if (!isPremium) { watermarkHtml = `<div class="watermark">Created with City Pave Free</div>`; watermarkCss = ` .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 80pt; color: rgba(0, 0, 0, 0.05); pointer-events: none; z-index: 9999; white-space: nowrap; font-weight: bold; } @media print { .watermark { display: block; position: fixed; } } `; } return `<div class="printable-estimate">${styles}<style>${watermarkCss}</style>${watermarkHtml}${coverPageHtml}${mainContentHtml}<div class="final-page-wrapper">${finalPageHtml}</div></div>`; } function renderAcceptanceSection(acceptance, companyName, customerNotes) { if (!acceptance) return ''; const signed = acceptance.signatureDataURL; let signatureHtml = ''; if (signed) { signatureHtml = ` <div class="signature-box signed"> <img src="${acceptance.signatureDataURL}" class="signature-image" alt="Client Signature"> <p class="printed-name">${acceptance.printedName || 'N/A'}</p> <label>Client Signature</label> </div> <div class="signature-box signed"> ${acceptance.witnessSignatureDataURL ? `<img src="${acceptance.witnessSignatureDataURL}" class="signature-image" alt="Witness Signature">` : '<div class="signature-image" style="height: 40px;"></div>'} <p class="printed-name">${acceptance.witnessPrintedName || 'N/A'}</p> <label>Witness Signature</label> </div> `; } else { signatureHtml = ` <div class="signature-box"> <label>Client Signature</label> </div> <div class="signature-box"> <label>Witness Signature</label> </div> <div class="signature-box"> <label>Print Name</label> </div> <div class="signature-box"> <label>Print Witness Name</label> </div> `; } const dateHtml = signed ? `<div class="date-box signed"><p class="signed-date">${acceptance.acceptanceDate || 'N/A'}</p><label>Date of Acceptance</label></div>` : '<div class="date-box"><label>Date of Acceptance</label></div>'; const customerNotesHtml = customerNotes ? `<div class="customer-notes-section"><h4>Additional Information from Client</h4><p>${customerNotes}</p></div>` : ''; return ` <div class="acceptance-section"> <h2>Acceptance of Proposal</h2> <p>By signing, you accept the prices, specifications, and conditions for the option(s) selected. You authorize ${companyName} to do the work as specified. Payment will be made as outlined.</p> <div class="signature-area-grid">${signatureHtml}</div> ${dateHtml} ${customerNotesHtml} </div> `; }