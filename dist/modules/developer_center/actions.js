// ¬© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { TIER_LEVELS, BUNDLES } from '../subscription/tiers.js'; export class Actions { constructor(app) { this.app = app; this.currentModule = null; this.currentTenant = null; this.activeTab = 'settings'; } reset() { this.currentModule = null; document.getElementById('action-panel-empty').classList.remove('hidden'); document.getElementById('action-panel-content').classList.add('hidden'); } renderConfiguration(module, tenant) { this.currentModule = module; this.currentTenant = tenant; document.getElementById('action-panel-empty').classList.add('hidden'); const content = document.getElementById('action-panel-content'); content.classList.remove('hidden'); content.innerHTML = ` <div style="padding:1rem;"> <!-- Helper Header: Tier & Status --> <div style="margin-bottom:1.5rem; padding-bottom:1rem; border-bottom:1px solid var(--border-color);"> <div style="display:flex; justify-content:space-between; align-items:start;"> <div> <h2 style="margin:0; font-size:1.1rem;">${module.name}</h2> <span style="color:var(--text-secondary); font-size:0.8rem; font-family:var(--font-mono);">ID: ${module.id} | v${module.version}</span> </div> <div class="status-indicator" style="background:${module.status === 'locked' ? '#333' : 'rgba(16,185,129,0.1)'}; color:${module.status === 'locked' ? '#aaa' : 'var(--success)'}"> ${module.status.toUpperCase()} </div> </div> </div> <!-- Action Tabs --> <div class="nav-tabs" style="margin-bottom:1rem; border-bottom:1px solid var(--border-color); display:flex; gap:10px;"> <button class="nav-tab ${this.activeTab === 'settings' ? 'active' : ''}" onclick="window.brain.actions.switchTab('settings')" style="padding:6px 12px; font-size:0.8rem; background:none; border:none; color:${this.activeTab === 'settings' ? 'white' : 'var(--text-secondary)'}; border-bottom:${this.activeTab === 'settings' ? '2px solid var(--accent-color)' : 'none'}; cursor:pointer;">Settings</button> <button class="nav-tab ${this.activeTab === 'modules' ? 'active' : ''}" onclick="window.brain.actions.switchTab('modules')" style="padding:6px 12px; font-size:0.8rem; background:none; border:none; color:${this.activeTab === 'modules' ? 'white' : 'var(--text-secondary)'}; border-bottom:${this.activeTab === 'modules' ? '2px solid var(--accent-color)' : 'none'}; cursor:pointer;">Modules</button> <button class="nav-tab ${this.activeTab === 'services' ? 'active' : ''}" onclick="window.brain.actions.switchTab('services')" style="padding:6px 12px; font-size:0.8rem; background:none; border:none; color:${this.activeTab === 'services' ? 'white' : 'var(--text-secondary)'}; border-bottom:${this.activeTab === 'services' ? '2px solid var(--accent-color)' : 'none'}; cursor:pointer;">Services</button> </div> <!-- Content Area --> <div id="action-tab-content"> ${this.renderTabContent()} </div> </div> `; const bindIf = (id, event, handler) => { const el = document.getElementById(id); if (el) el.addEventListener(event, handler); }; if (this.activeTab === 'settings') { bindIf('tier-select', 'change', (e) => { console.log(`[Admin] Changing Tier for ${tenant.id} to ${e.target.value}`); }); bindIf('bundle-select', 'change', (e) => { console.log(`[Admin] Assigning Bundle ${e.target.value} to ${tenant.id}`); }); } if (this.activeTab === 'services') { bindIf('svc-deployment', 'change', (e) => { const isEnabled = e.target.checked; console.log(`[Admin] Custom Deployment for ${tenant.id}: ${isEnabled}`); if (!tenant.services) tenant.services = {}; tenant.services.custom_deployment = isEnabled; }); bindIf('svc-support', 'change', (e) => console.log(`[Admin] Priority Support: ${e.target.checked}`)); bindIf('svc-whitelabel', 'change', (e) => console.log(`[Admin] White Labeling: ${e.target.checked}`)); } if (this.activeTab === 'modules') { const modules = ['estimator', 'sketch', 'employee', 'safety', 'fleet', 'snow', 'excavator', 'maintenance', 'expenses', 'operations']; modules.forEach(modId => { bindIf(`mod-toggle-${modId}`, 'change', (e) => { const isEnabled = e.target.checked; console.log(`[Admin] Module ${modId} for ${tenant.id}: ${isEnabled}`); if (!tenant.modules) tenant.modules = []; if (isEnabled) { if (!tenant.modules.includes(modId)) tenant.modules.push(modId); } else { tenant.modules = tenant.modules.filter(m => m !== modId); } }); }); } } switchTab(tabName) { this.activeTab = tabName; this.renderConfiguration(this.currentModule, this.currentTenant); } renderTabContent() { if (this.activeTab === 'settings') return this.renderSettings(); if (this.activeTab === 'modules') return this.renderModulesTab(); if (this.activeTab === 'services') return this.renderServicesTab(); } renderSettings() { const tenant = this.currentTenant; return ` <!-- Subscription Tier Logic --> <div style="margin-bottom:2rem;"> <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"> <div> <label style="display:block; font-size:0.8rem; color:var(--text-secondary); margin-bottom:4px;">Subscriber Tier:</label> <select id="tier-select" style="width:100%; background:var(--bg-panel); color:white; border:1px solid var(--border-color); padding:4px; border-radius:4px; font-size:0.8rem;"> ${Object.values(TIER_LEVELS).map(level => `<option value="${level}" ${tenant.tier === level ? 'selected' : ''}>${level}</option>` ).join('')} </select> </div> <div> <label style="display:block; font-size:0.8rem; color:var(--text-secondary); margin-bottom:4px;">Assign Bundle:</label> <select id="bundle-select" style="width:100%; background:var(--bg-panel); color:white; border:1px solid var(--border-color); padding:4px; border-radius:4px; font-size:0.8rem;"> <option value="">-- None --</option> ${Object.values(BUNDLES).map(b => `<option value="${b.id}">${b.name}</option>` ).join('')} </select> </div> </div> </div> <!-- Deployment --> <div class="control-group" style="margin-bottom:2rem;"> <h4 style="color:var(--text-secondary); text-transform:uppercase; font-size:0.75rem; border-bottom:1px solid var(--border-color); padding-bottom:4px; margin-bottom:1rem;"> Deployment </h4> <div style="display:flex; gap:1rem; margin-bottom:1rem;"> <button class="btn-sm" style="flex:1;">Deploy Latest</button> <button class="btn-toggle" style="flex:1;">Rollback</button> </div> </div> `; } renderModulesTab() { const modules = [ { id: 'estimator', name: 'Estimator Engine' }, { id: 'sketch', name: 'Sketch Tool' }, { id: 'employee', name: 'Employee Portal' }, { id: 'safety', name: 'Safety Manual' }, { id: 'fleet', name: 'Fleet Manager' }, { id: 'snow', name: 'Snow Calculator' }, { id: 'excavator', name: 'Excavator Calculator' }, { id: 'maintenance', name: 'Maintenance & Repairs' }, { id: 'expenses', name: 'Expenses' }, { id: 'operations', name: 'Operations Hub' } ]; const tenantModules = this.currentTenant.modules || []; return ` <div class="control-group"> <h4 style="color:var(--text-secondary); text-transform:uppercase; font-size:0.75rem; margin-bottom:1rem;"> Granular Module Access </h4> <p style="font-size:0.7rem; color:var(--text-secondary); margin-bottom:1rem;"> Select which modules are enabled for this tenant. These override the base tier settings. </p> <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"> ${modules.map(mod => { const isChecked = tenantModules.includes(mod.id); return this.renderFeatureToggle(mod.name, isChecked, `mod-toggle-${mod.id}`); }).join('')} </div> </div> `; } renderServicesTab() { const services = this.currentTenant.services || {}; return ` <div class="control-group"> <h4 style="color:var(--text-secondary); text-transform:uppercase; font-size:0.75rem; margin-bottom:1rem;"> Service Flags </h4> <!-- Custom Deployment Service --> <div style="margin-bottom:1rem; padding:10px; background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.3); border-radius:6px;"> ${this.renderFeatureToggle('Custom Deployment Authority', services.custom_deployment, 'svc-deployment')} <p style="font-size:0.7rem; color:var(--text-secondary); margin-top:8px;"> Allows the Tenant Admin to assign specific modules to their employees via the User Admin dashboard. </p> </div> <div style="margin-bottom:1rem;"> ${this.renderFeatureToggle('Priority Support', services.priority_support, 'svc-support')} </div> <div style="margin-bottom:1rem;"> ${this.renderFeatureToggle('White Labeling', services.white_label, 'svc-whitelabel')} </div> </div> `; } renderGlobalBrandingSuite() { const tenant = this.currentTenant; return ` <div class="control-group" style="animation: fadeIn 0.3s ease;"> <div style="background:linear-gradient(135deg, rgba(59,130,246,0.1), rgba(147,51,234,0.05)); padding:1.5rem; border-radius:8px; border:1px solid rgba(59,130,246,0.3); margin-bottom:2rem;"> <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;"> <h3 style="margin:0; font-size:1rem; color:white;">Global Brand Identity</h3> <span class="badge" style="background:#3b82f6; color:white;">PRO</span> </div> <p style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:1.5rem;"> These settings apply to the <strong>entire application ecosystem</strong> for ${tenant.name}. </p> <!-- Logo & Identity --> <div style="display:grid; grid-template-columns: 100px 1fr; gap:1.5rem; margin-bottom:2rem;"> <div style="width:100px; height:100px; background:#111; border:2px dashed #444; border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#444'"> <span style="font-size:2rem;">üì∑</span> <span style="font-size:0.6rem; color:#888; margin-top:4px;">Upload Logo</span> </div> <div style="display:flex; flex-direction:column; gap:1rem;"> <div> <label style="display:block; font-size:0.75rem; color:var(--text-secondary); margin-bottom:4px;">App Name</label> <input type="text" value="${tenant.name} App" style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border-color); color:white; padding:8px; border-radius:6px;"> </div> <div> <label style="display:block; font-size:0.75rem; color:var(--text-secondary); margin-bottom:4px;">Custom Domain</label> <div style="display:flex; align-items:center;"> <input type="text" placeholder="app.company.com" style="flex:1; background:rgba(0,0,0,0.3); border:1px solid var(--border-color); color:white; padding:8px; border-radius:6px 0 0 6px;"> <button class="btn-sm" style="border-radius:0 6px 6px 0; background:#333; border:1px solid var(--border-color); border-left:none;">Verify</button> </div> </div> </div> </div> <!-- Color Palette --> <div style="margin-bottom:2rem;"> <label style="display:block; font-size:0.75rem; color:var(--text-secondary); margin-bottom:8px;">Global Palette (Auto-generated from Logo)</label> <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;"> <div> <div style="height:40px; background:${this.mockGetColor(tenant.name)}; border-radius:6px; cursor:pointer; margin-bottom:4px;"></div> <div style="font-size:0.7rem; color:#888; text-align:center;">Primary</div> </div> <div> <div style="height:40px; background:#1f2937; border-radius:6px; cursor:pointer; margin-bottom:4px; border:1px solid #444;"></div> <div style="font-size:0.7rem; color:#888; text-align:center;">Surface</div> </div> <div> <div style="height:40px; background:#10b981; border-radius:6px; cursor:pointer; margin-bottom:4px;"></div> <div style="font-size:0.7rem; color:#888; text-align:center;">Success</div> </div> <div> <div style="height:40px; background:#ef4444; border-radius:6px; cursor:pointer; margin-bottom:4px;"></div> <div style="font-size:0.7rem; color:#888; text-align:center;">Danger</div> </div> </div> </div> <!-- Typography --> <div style="margin-bottom:2rem;"> <label style="display:block; font-size:0.75rem; color:var(--text-secondary); margin-bottom:8px;">Typography</label> <select style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border-color); color:white; padding:8px; border-radius:6px;"> <option value="inter">Inter (Modern & Clean)</option> <option value="roboto">Roboto (Standard)</option> <option value="serif">Merriweather (Classic)</option> </select> </div> <div style="display:flex; justify-content:flex-end;"> <button class="btn-sm" style="padding:10px 24px; font-weight:600;">Save Global Branding</button> </div> </div> </div> `; } renderSettings() { return ` <!-- Deployment --> <div class="control-group" style="margin-bottom:2rem;"> <h4 style="color:var(--text-secondary); text-transform:uppercase; font-size:0.75rem; border-bottom:1px solid var(--border-color); padding-bottom:4px; margin-bottom:1rem;"> Deployment </h4> <div style="display:flex; gap:1rem; margin-bottom:1rem;"> <button class="btn-sm" style="flex:1;">Deploy Latest</button> <button class="btn-toggle" style="flex:1;">Rollback</button> </div> </div> <!-- Features --> <div class="control-group" style="margin-bottom:2rem;"> <h4 style="color:var(--text-secondary); text-transform:uppercase; font-size:0.75rem; border-bottom:1px solid var(--border-color); padding-bottom:4px; margin-bottom:1rem;"> Feature Flags </h4> ${this.renderFeatureToggle('Enable Beta', false)} ${this.renderFeatureToggle('Strict Mode', true)} </div> <!-- White Labeling (Only for Mini-Apps) --> ${this.currentTenant.tier.includes('Mini-App') ? ` <div class="control-group"> <button class="btn-toggle" style="width:100%;">Configure White Labeling (Mini-App)</button> </div> ` : ''} `; } renderResources() { return ` <div class="control-group"> <h4 style="color:var(--text-secondary); text-transform:uppercase; font-size:0.75rem; margin-bottom:1rem;"> Module Resources (${this.currentModule.name}) </h4> <div class="glass-panel" style="background:var(--bg-panel); border:1px solid var(--border-color); border-radius:6px;"> <button class="btn-sm" style="width:100%; margin-bottom:0.5rem;">+ Upload Resource</button> <div style="font-size:0.8rem; color:var(--text-secondary);"> <div style="padding:8px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;"> <span>üìÑ Inspection_Form_v2.pdf</span> <span>1.2MB</span> </div> <div style="padding:8px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;"> <span>üñºÔ∏è Company_Logo_HighRes.png</span> <span>4.5MB</span> </div> <div style="padding:8px; display:flex; justify-content:space-between;"> <span>‚öôÔ∏è config_override.json</span> <span>2KB</span> </div> </div> </div> </div> `; } renderUsers() { const isComm = this.currentModule.id === 'ai_overlay' || this.currentModule.name.includes('Speech'); return ` <div class="control-group"> <h4 style="color:var(--text-secondary); text-transform:uppercase; font-size:0.75rem; margin-bottom:1rem;"> Active Users (${this.currentModule.name}) </h4> <div class="glass-panel" style="background:var(--bg-panel); border:1px solid var(--border-color); border-radius:6px; padding:0;"> <table style="width:100%; text-align:left; font-size:0.8rem; border-collapse:collapse;"> <thead style="background:rgba(255,255,255,0.05); color:var(--text-secondary);"> <tr> <th style="padding:8px;">User</th> <th style="padding:8px;">Last Active</th> <th style="padding:8px;">Usage</th> </tr> </thead> <tbody> <tr> <td style="padding:8px;">Alice (Foreman)</td> <td style="padding:8px;">2m ago</td> <td style="padding:8px;">High</td> </tr> <tr> <td style="padding:8px;">Bob (Driver)</td> <td style="padding:8px;">1h ago</td> <td style="padding:8px;">Low</td> </tr> </tbody> </table> </div> ${isComm ? ` <div style="margin-top:1rem; padding:1rem; border:1px dashed var(--accent-color); border-radius:6px; background:rgba(59,130,246,0.05);"> <strong style="color:var(--accent-color);">Communication Log</strong> <div style="font-size:0.75rem; margin-top:0.5rem; color: #ccc;"> [10:42] Alice: "Site 4 needs more gravel."<br> [10:45] AI Agent: "Order queued." </div> </div> ` : ''} </div> `; } renderFeatureToggle(label, checked, id) { return ` <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05);"> <span style="font-size:0.9rem;">${label}</span> <label class="toggle-switch" style="position:relative; display:inline-block; width:36px; height:20px;"> <input type="checkbox" id="${id}" ${checked ? 'checked' : ''} style="opacity:0; width:0; height:0;"> <span class="slider" style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#333; transition:.4s; border-radius:34px;"></span> <span class="knob" style="position:absolute; content:''; height:14px; width:14px; left:3px; bottom:3px; background-color:white; transition:.4s; border-radius:50%;"></span> </label> </div> <style> input:checked + .slider { background-color: var(--accent-color); } input:checked + .slider .knob { transform: translateX(16px); } </style> `; } mockGetColor(str) { let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); } const c = (hash & 0x00FFFFFF).toString(16).toUpperCase(); return '#' + '00000'.substring(0, 6 - c.length) + c; } }