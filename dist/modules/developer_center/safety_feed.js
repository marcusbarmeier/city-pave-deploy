// ¬© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { db } from './firebase-client.js'; import { collection, query, orderBy, limit, onSnapshot, where } from "https: export class SafetyFeed { constructor(app) { this.app = app; this.unsub = null; } init() { console.log("[Safety Feed] Initializing..."); this.render(); this.listen(); } listen() { const q = query( collection(db, 'form_submissions'), orderBy('submittedAt', 'desc'), limit(20) ); this.unsub = onSnapshot(q, (snapshot) => { const forms = []; snapshot.forEach(doc => forms.push({ id: doc.id, ...doc.data() })); this.updateTable(forms); }); } render() { const platformView = document.getElementById('ws-platform'); if (!platformView) return; let section = document.getElementById('global-safety-section'); if (!section) { section = document.createElement('div'); section.id = 'global-safety-section'; section.style.marginTop = '2rem'; section.innerHTML = ` <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;"> <h3>Live Safety Stream</h3> <div style="display:flex; gap:10px;"> <span class="badge" style="background:#ef4444; color:white;">‚óè High Priority</span> </div> </div> <div class="glass-panel" style="background:var(--bg-panel); border:1px solid var(--border-color); border-radius:8px; overflow:hidden;"> <table style="width:100%; text-align:left; border-collapse:collapse; font-size:0.85rem;"> <thead> <tr style="border-bottom:1px solid var(--border-color); color:var(--text-secondary);"> <th style="padding:10px;">Type</th> <th style="padding:10px;">Reporter</th> <th style="padding:10px;">Location / Details</th> <th style="padding:10px;">Time</th> </tr> </thead> <tbody id="global-safety-body"> <tr><td colspan="4" style="padding:20px; text-align:center;">Listening for alerts...</td></tr> </tbody> </table> </div> `; platformView.appendChild(section); } } updateTable(forms) { const tbody = document.getElementById('global-safety-body'); if (!tbody) return; if (forms.length === 0) { tbody.innerHTML = `<tr><td colspan="4" style="padding:2rem; text-align:center; opacity:0.5;">No safety reports found.</td></tr>`; return; } tbody.innerHTML = forms.map(form => { let badgeColor = '#6b7280'; let badgeText = form.formTitle || form.formType; if (form.formType === 'incident') { badgeColor = '#ef4444'; badgeText = 'INCIDENT'; } else if (form.formType === 'hazard') { badgeColor = '#f59e0b'; badgeText = 'HAZARD'; } else if (form.formType === 'pre-trip' && form.data?.defects) { badgeColor = '#f59e0b'; badgeText = 'DEFECT FOUND'; } const timestamp = form.submittedAt ? new Date(form.submittedAt) : new Date(); let summary = 'No details'; if (form.data?.description) summary = form.data.description; else if (form.data?.hazards) summary = form.data.hazards; else if (form.data?.defects) summary = "Defects: " + form.data.defects; else summary = "Routine Submission"; return ` <tr style="border-bottom:1px solid rgba(255,255,255,0.05);"> <td style="padding:10px;"> <span style="background:${badgeColor}20; color:${badgeColor}; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold;"> ${badgeText} </span> </td> <td style="padding:10px;"> <div style="font-weight:600;">${form.userName || 'Unknown'}</div> <div style="font-size:0.7rem; opacity:0.6;">${form.userId ? form.userId.substring(0, 8) : 'N/A'}</div> </td> <td style="padding:10px;"> <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;" title="${summary}"> ${summary} </div> ${form.location ? `<div style="font-size:0.7rem; opacity:0.5;">üìç ${form.location.lat.toFixed(4)}, ${form.location.lng.toFixed(4)}</div>` : ''} </td> <td style="padding:10px;"> ${timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} <div style="font-size:0.7rem; opacity:0.5;">${timestamp.toLocaleDateString()}</div> </td> </tr> `; }).join(''); } }