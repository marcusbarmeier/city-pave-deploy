// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { renderInventoryTable, populateAssetDropdown, toggleCompatibleWrapper } from './inventory-ui.js'; export function initializeInventoryManager() { setupTabListeners(); setupFormListeners(); } function setupTabListeners() { const tabInventory = document.getElementById('tab-inventory'); const viewInventory = document.getElementById('view-inventory'); if (tabInventory && viewInventory) { tabInventory.addEventListener('click', () => { document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active')); document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden')); tabInventory.classList.add('active'); viewInventory.classList.remove('hidden'); refreshInventoryList(); fetchAssetsForDropdown(); }); } } function setupFormListeners() { const saveBtn = document.getElementById('save-part-btn'); if (saveBtn) { const newSaveBtn = saveBtn.cloneNode(true); saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn); newSaveBtn.addEventListener('click', () => savePart(true)); } const formContainer = document.querySelector('#view-inventory .space-y-3'); if (formContainer && !document.getElementById('save-next-part-btn')) { const nextBtn = document.createElement('button'); nextBtn.id = 'save-next-part-btn'; nextBtn.className = "w-full bg-gray-100 text-gray-800 font-bold py-2 rounded hover:bg-gray-200 border border-gray-300 mt-2"; nextBtn.textContent = "Save & Add Next Item (Keep Invoice)"; nextBtn.addEventListener('click', () => savePart(false)); formContainer.appendChild(nextBtn); } const scanBtn = document.getElementById('scan-invoice-btn'); if (scanBtn) { scanBtn.addEventListener('click', () => { const input = document.getElementById('invoice-photo-input'); if (input) input.click(); }); } const invoiceInput = document.getElementById('invoice-photo-input'); if (invoiceInput) { invoiceInput.addEventListener('change', handleInvoiceScan); } const categorySelect = document.getElementById('inv-category'); if (categorySelect) { categorySelect.addEventListener('change', (e) => { toggleCompatibleWrapper(e.target.value === 'Vehicle Part'); }); } } async function fetchAssetsForDropdown() { if (!window.firebaseServices) return; const { db, collection, getDocs } = window.firebaseServices; try { const snapshot = await getDocs(collection(db, "assets")); const assets = []; snapshot.forEach(doc => assets.push({ id: doc.id, ...doc.data() })); populateAssetDropdown('inv-compatible-assets', assets); } catch (e) { console.error("Error fetching assets:", e); } } async function refreshInventoryList() { if (!window.firebaseServices) return; const { db, collection, getDocs, query, orderBy, limit } = window.firebaseServices; const tbodyId = 'inventory-table-body'; try { const q = query(collection(db, "inventory"), orderBy("createdAt", "desc"), limit(50)); const snapshot = await getDocs(q); const items = []; snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() })); renderInventoryTable(tbodyId, items, handleDeleteItem); } catch (e) { console.error("Error loading inventory:", e); const tbody = document.getElementById(tbodyId); if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-red-500">Error: ${e.message}</td></tr>`; } } async function handleDeleteItem(itemId) { if (!confirm("Delete this item?")) return; const { db, doc, deleteDoc } = window.firebaseServices; try { await deleteDoc(doc(db, "inventory", itemId)); refreshInventoryList(); } catch (e) { alert("Delete failed: " + e.message); } } async function savePart(resetAll) { const partNumber = document.getElementById('inv-part-number')?.value; const description = document.getElementById('inv-description')?.value; const quantity = document.getElementById('inv-quantity')?.value; const cost = document.getElementById('inv-cost')?.value; const vendor = document.getElementById('inv-vendor')?.value; const poNumber = document.getElementById('inv-po')?.value; const category = document.getElementById('inv-category')?.value; const partPhotoInput = document.getElementById('inv-part-photo'); if (!partNumber || !description) return alert("Part Number and Description are required."); const btn = document.getElementById('save-part-btn'); if (btn) { btn.disabled = true; btn.textContent = "Saving..."; } const { db, collection, addDoc, storage, ref, uploadBytes, getDownloadURL } = window.firebaseServices; try { const selectedAssets = Array.from(document.getElementById('inv-compatible-assets').selectedOptions).map(opt => opt.value); let partPhotoUrl = null; if (partPhotoInput && partPhotoInput.files.length > 0) { const file = partPhotoInput.files[0]; const storageRef = ref(storage, `inventory/${Date.now()}_${file.name}`); const snapshot = await uploadBytes(storageRef, file); partPhotoUrl = await getDownloadURL(snapshot.ref); } await addDoc(collection(db, "inventory"), { partNumber, description, quantity: parseInt(quantity) || 0, cost: parseFloat(cost) || 0, vendor, poNumber, category, compatibleAssets: category === 'Vehicle Part' ? selectedAssets : [], partPhotoUrl, createdAt: new Date().toISOString() }); alert("Part added!"); if (resetAll) { document.querySelectorAll('#view-inventory input').forEach(i => i.value = ''); if (document.getElementById('inv-quantity')) document.getElementById('inv-quantity').value = '1'; } else { const idsToClear = ['inv-part-number', 'inv-description', 'inv-cost']; idsToClear.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; }); if (document.getElementById('inv-quantity')) document.getElementById('inv-quantity').value = '1'; if (partPhotoInput) partPhotoInput.value = ''; } refreshInventoryList(); } catch (error) { console.error("Error saving part:", error); alert("Error: " + error.message); } finally { if (btn) { btn.disabled = false; btn.textContent = "Add to Inventory"; } } } async function handleInvoiceScan(e) { const file = e.target.files[0]; if (!file) return; const btn = document.getElementById('scan-invoice-btn'); if (btn) { btn.disabled = true; btn.textContent = "Scanning..."; } try { if (!window.Tesseract) throw new Error("Tesseract library not loaded."); const worker = await Tesseract.createWorker('eng'); const { data: { text } } = await worker.recognize(file); await worker.terminate(); console.log("Invoice OCR:", text); const costMatch = text.match(/[$]\s*(\d+\.\d{2})/); if (costMatch) { const costInput = document.getElementById('inv-cost'); if (costInput) costInput.value = costMatch[1]; } const lowerText = text.toLowerCase(); const vendorInput = document.getElementById('inv-vendor'); if (vendorInput) { if (lowerText.includes('napa')) vendorInput.value = 'NAPA Auto Parts'; else if (lowerText.includes('uauto')) vendorInput.value = 'U-Auto'; else if (lowerText.includes('cat')) vendorInput.value = 'Caterpillar'; } alert("Invoice scanned! Adjust details as needed."); } catch (error) { console.error("OCR Error:", error); alert("Could not read invoice."); } finally { if (btn) { btn.disabled = false; btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> Scan Invoice`; } } }