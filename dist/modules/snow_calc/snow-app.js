// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { calculateSnowServiceCost, calculateSnowRouteCost } from './snow-core.js'; import { updateCardWithResults, updateSnowContractSummary, getInputsFromCard as getUIInputsFromCard } from './snow-ui.js'; async function getHaulingRoundTripTime() { return 0.95; } async function getFullInputsFromCard(card) { const rawInputs = await getUIInputsFromCard(card); const roundTripTime = await getHaulingRoundTripTime(); return { ...rawInputs, roundTripTime: roundTripTime }; } async function getTravelTimeBetweenPoints(originAddress, destinationAddress) { if (!originAddress || !destinationAddress || !window.google || !window.google.maps || !window.google.maps.DirectionsService) { return 0.25; } const directionsService = new google.maps.DirectionsService(); return new Promise(resolve => { directionsService.route({ origin: originAddress, destination: destinationAddress, travelMode: google.maps.TravelMode.DRIVING }, (result, status) => { if (status === 'OK') { const route = result.routes[0]; let totalDurationSeconds = 0; route.legs.forEach(leg => { totalDurationSeconds += leg.duration.value; }); resolve((totalDurationSeconds / 3600) * 1.10); } else { console.warn(`Directions request failed: ${status}`); resolve(0.25); } }); }); } export async function handleAutoCalculateSnowPrice(card, showBanner = true) { if (!card) return; if (showBanner && window.ui) window.ui.showSuccessBanner("Calculating...", true); try { const inputs = await getFullInputsFromCard(card); const result = calculateSnowServiceCost(inputs); updateCardWithResults(card, result); if (showBanner && window.ui) window.ui.showSuccessBanner("Prices calculated for this location."); const isRouted = document.getElementById('snow-is-routed-job')?.checked; if (isRouted) { handleRouteChange(); } else { updateSnowContractSummary(); } } catch (error) { console.error("Snow Calculation Error:", error); if (showBanner && window.ui) window.ui.showErrorBanner(`Calculation Error: ${error.message}`); const detailsContainer = card.querySelector('.snow-calculation-details'); if (detailsContainer) { detailsContainer.innerHTML = `<h4 class="font-bold mb-2">Calculation Error</h4><p class="text-red-600">${error.message}</p>`; } } } export async function handleRouteChange() { const isRouted = document.getElementById('snow-is-routed-job')?.checked; const allCards = document.querySelectorAll('.snow-location-card'); if (allCards.length === 0) { updateSnowContractSummary(); return; } if (window.ui) window.ui.showSuccessBanner("Recalculating prices...", true); try { if (isRouted && allCards.length > 1) { const allLocationInputs = []; for (const card of allCards) { const inputs = await getFullInputsFromCard(card); allLocationInputs.push(inputs); } const routeResults = await calculateSnowRouteCost(allLocationInputs, getTravelTimeBetweenPoints); routeResults.forEach(result => { const cardToUpdate = document.getElementById(result.id); if (cardToUpdate) { updateCardWithResults(cardToUpdate, result); } }); } else { for (const card of allCards) { await handleAutoCalculateSnowPrice(card, false); } } if (window.ui) window.ui.showSuccessBanner("Prices updated."); } catch (error) { console.error("Route calculation error:", error); if (window.ui) window.ui.showErrorBanner(error.message); } } export function applyAllSnowLocationsToOption(costType) { const firstOptionCard = document.querySelector('#pricing-options-container .price-option-card'); if (!firstOptionCard) { return window.ui?.showErrorBanner("Please add a Pricing Option card first."); } const firstOptionId = firstOptionCard.dataset.optionId; const allSnowCards = document.querySelectorAll('.snow-location-card'); if (allSnowCards.length === 0) { return window.ui?.showErrorBanner("No snow locations found to apply."); } let itemsAddedCount = 0; allSnowCards.forEach(card => { const title = card.querySelector('.snow-location-title')?.value || 'Unnamed Location'; const address = card.querySelector('.snow-location-address')?.value || 'No Address'; const breakdownHtml = card.querySelector('.snow-calculation-details')?.innerHTML || ''; let price = 0; let serviceTerm = ''; if (costType === 'perPush') { price = parseFloat(card.querySelector('.snow-price-per-push')?.value) || 0; serviceTerm = 'Per Push Service'; } else if (costType === 'monthly') { price = parseFloat(card.querySelector('.snow-price-monthly')?.value) || 0; serviceTerm = 'Monthly Service'; } else { price = parseFloat(card.querySelector('.snow-price-seasonal')?.value) || 0; serviceTerm = 'Seasonal Service'; } if (price > 0) { const itemData = { product: null, description: `<strong>${title}</strong><br>${address}<br><em>${serviceTerm}</em><br><div class="text-xs mt-1 text-gray-500">${breakdownHtml}</div>`, units: 1, unitPrice: price, color: '#e0f2fe' }; if (window.ui && window.ui.addItemToOption) { window.ui.addItemToOption(firstOptionId, itemData, true, () => { }); itemsAddedCount++; } } }); if (itemsAddedCount > 0) { if (window.ui) window.ui.showSuccessBanner(`Added ${itemsAddedCount} snow locations to pricing option.`); } else { if (window.ui) window.ui.showErrorBanner("No locations had a valid price for the selected term."); } }