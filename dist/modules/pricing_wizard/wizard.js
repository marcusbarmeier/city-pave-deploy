// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
class PricingWizard { constructor() { this.currentStep = 'info'; this.model = { id: 'custom-' + Date.now(), name: '', description: '', category: 'other', inputs: [], calculations: [], outputs: [] }; this.contentArea = document.getElementById('wizard-content'); this.stepTitle = document.getElementById('step-title'); this.btnNext = document.getElementById('btn-next'); this.btnPrev = document.getElementById('btn-prev'); this.steps = document.querySelectorAll('.step-btn'); this.previewContainer = document.getElementById('preview-container'); this.jsonPreview = document.getElementById('json-preview'); this.init(); } init() { this.bindGlobalEvents(); this.renderStep(this.currentStep); this.updatePreview(); } bindGlobalEvents() { this.btnNext.addEventListener('click', () => this.navigate('next')); this.btnPrev.addEventListener('click', () => this.navigate('prev')); this.steps.forEach(btn => { btn.addEventListener('click', (e) => { const step = e.currentTarget.dataset.step; this.currentStep = step; this.renderStep(step); }); }); document.getElementById('btn-reset').addEventListener('click', () => { if (confirm('Clear all progress?')) { window.location.reload(); } }); const exportBtns = [document.getElementById('btn-export-json')]; const finalExport = document.getElementById('btn-final-export'); exportBtns.forEach(btn => btn.addEventListener('click', () => this.exportJSON())); this.contentArea.addEventListener('input', (e) => { this.handleInputUpdate(e); }); this.contentArea.addEventListener('change', (e) => { this.handleInputUpdate(e); }); this.contentArea.addEventListener('click', (e) => { this.handleClick(e); }); } navigate(direction) { const order = ['info', 'inputs', 'formulas', 'outputs']; const idx = order.indexOf(this.currentStep); if (direction === 'next' && idx < order.length - 1) { this.currentStep = order[idx + 1]; } else if (direction === 'prev' && idx > 0) { this.currentStep = order[idx - 1]; } this.renderStep(this.currentStep); } renderStep(step) { const order = ['info', 'inputs', 'formulas', 'outputs']; const idx = order.indexOf(step); this.btnPrev.disabled = idx === 0; this.btnNext.textContent = idx === order.length - 1 ? 'Finish' : 'Next Step'; this.btnNext.disabled = false; this.steps.forEach(s => { if (s.dataset.step === step) { s.classList.add('bg-indigo-50', 'text-indigo-700'); s.querySelector('div').classList.remove('bg-gray-200', 'text-gray-600'); s.querySelector('div').classList.add('bg-indigo-200', 'text-indigo-700'); } else { s.classList.remove('bg-indigo-50', 'text-indigo-700'); s.querySelector('div').classList.add('bg-gray-200', 'text-gray-600'); s.querySelector('div').classList.remove('bg-indigo-200', 'text-indigo-700'); } }); const template = document.getElementById(`tpl-step-${step}`); if (template) { this.contentArea.innerHTML = ''; this.contentArea.appendChild(template.content.cloneNode(true)); } this.stepTitle.innerText = step.charAt(0).toUpperCase() + step.slice(1); if (step === 'info') this.fillInfoStep(); if (step === 'inputs') this.renderInputsList(); if (step === 'formulas') this.renderFormulasList(); if (step === 'outputs') this.renderSummary(); } handleInputUpdate(e) { const target = e.target; if (target.id === 'inp-name') this.model.name = target.value; if (target.id === 'inp-desc') this.model.description = target.value; if (target.id === 'inp-category') this.model.category = target.value; if (target.matches('#inputs-list input, #inputs-list select')) { this.saveInputsFromDOM(); } if (target.matches('#formulas-list input')) { this.saveFormulasFromDOM(); } this.updatePreview(); } handleClick(e) { const target = e.target; if (target.closest('#btn-add-input')) { this.addInput(); } if (target.closest('.btn-remove-input')) { target.closest('.group').remove(); this.saveInputsFromDOM(); this.updatePreview(); } if (target.closest('#btn-add-formula')) { this.addFormula(); } if (target.closest('.btn-remove-formula')) { target.closest('.group').remove(); this.saveFormulasFromDOM(); this.updatePreview(); } if (target.id === 'btn-final-export') { this.exportJSON(); } } fillInfoStep() { document.getElementById('inp-name').value = this.model.name; document.getElementById('inp-desc').value = this.model.description; document.getElementById('inp-category').value = this.model.category; } renderInputsList() { const list = document.getElementById('inputs-list'); list.innerHTML = ''; this.model.inputs.forEach(inp => this.appendInputDOM(inp)); if (this.model.inputs.length === 0) this.addInput(); } addInput() { const newInput = { id: `var_${this.model.inputs.length + 1}`, type: 'number', label: 'New Variable', default: 0 }; this.model.inputs.push(newInput); this.appendInputDOM(newInput); } appendInputDOM(data) { const list = document.getElementById('inputs-list'); const tpl = document.getElementById('tpl-input-item'); const clone = tpl.content.cloneNode(true); clone.querySelector('.inp-id').value = data.id; clone.querySelector('.inp-type').value = data.type; clone.querySelector('.inp-label').value = data.label; clone.querySelector('.inp-default').value = data.default || ''; const optsDiv = clone.querySelector('.settings-select'); const optsInp = clone.querySelector('.inp-options'); if (data.type === 'select') { optsDiv.classList.remove('hidden'); if (data.options) { optsInp.value = data.options.map(o => `${o.label}:${o.value}`).join(', '); } } const typeSelect = clone.querySelector('.inp-type'); typeSelect.addEventListener('change', (e) => { if (e.target.value === 'select') optsDiv.classList.remove('hidden'); else optsDiv.classList.add('hidden'); }); list.appendChild(clone); } saveInputsFromDOM() { const items = document.querySelectorAll('#inputs-list > div'); const newInputs = []; items.forEach(el => { const type = el.querySelector('.inp-type').value; const inputConfig = { id: el.querySelector('.inp-id').value, type: type, label: el.querySelector('.inp-label').value, default: el.querySelector('.inp-default').value }; if (type === 'select') { const rawOpts = el.querySelector('.inp-options').value; inputConfig.options = rawOpts.split(',').map(pair => { const [l, v] = pair.split(':'); return { label: l ? l.trim() : 'Option', value: v ? v.trim() : l }; }); } newInputs.push(inputConfig); }); this.model.inputs = newInputs; } renderFormulasList() { const list = document.getElementById('formulas-list'); list.innerHTML = ''; const varsBox = document.getElementById('available-vars'); varsBox.innerHTML = ''; this.model.inputs.forEach(inp => { varsBox.innerHTML += `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded border border-blue-200 font-mono tracking-tight">${inp.id}</span>`; }); this.model.calculations.forEach(calc => this.appendFormulaDOM(calc)); if (this.model.calculations.length === 0) this.addFormula(); } addFormula() { const newCalc = { id: `res_${this.model.calculations.length + 1}`, formula: '', label: 'Result', isCost: false }; this.model.calculations.push(newCalc); this.appendFormulaDOM(newCalc); } appendFormulaDOM(data) { const list = document.getElementById('formulas-list'); const tpl = document.getElementById('tpl-formula-item'); const clone = tpl.content.cloneNode(true); clone.querySelector('.form-id').value = data.id; clone.querySelector('.form-expression').value = data.formula; clone.querySelector('.form-label').value = data.label; clone.querySelector('.form-is-cost').checked = data.isCost || false; list.appendChild(clone); } saveFormulasFromDOM() { const items = document.querySelectorAll('#formulas-list > div'); const newCalcs = []; items.forEach(el => { newCalcs.push({ id: el.querySelector('.form-id').value, formula: el.querySelector('.form-expression').value, label: el.querySelector('.form-label').value, isCost: el.querySelector('.form-is-cost').checked }); }); this.model.calculations = newCalcs; } renderSummary() { document.getElementById('summary-inputs-count').innerText = this.model.inputs.length; document.getElementById('summary-formulas-count').innerText = this.model.calculations.length; document.getElementById('summary-category').innerText = this.model.category; } updatePreview() { this.jsonPreview.innerText = JSON.stringify(this.model, null, 2); this.renderLivePreviewUI(); } renderLivePreviewUI() { const container = this.previewContainer; let headerColor = 'bg-gray-50'; let headerText = 'text-gray-800'; let icon = ''; switch (this.model.category) { case 'excavation': headerColor = 'bg-orange-50'; headerText = 'text-orange-900'; break; case 'snow': headerColor = 'bg-blue-50'; headerText = 'text-blue-900'; break; case 'paving': headerColor = 'bg-gray-800'; headerText = 'text-white'; break; } let html = ` <div class="${headerColor} p-4 border-b border-gray-200"> <h3 class="font-bold ${headerText}">${this.model.name || 'Untitled Calculator'}</h3> </div> <div class="p-4 space-y-4"> `; this.model.inputs.forEach(inp => { html += `<div> <label class="block text-xs font-bold text-gray-500 uppercase mb-1">${inp.label} (${inp.id})</label>`; if (inp.type === 'select') { html += `<select class="w-full p-2 border rounded text-sm bg-white">`; if (inp.options) { inp.options.forEach(o => { html += `<option value="${o.value}">${o.label}</option>`; }); } html += `</select>`; } else if (inp.type === 'system') { html += `<input type="number" class="w-full p-2 border rounded bg-gray-100 text-sm" value="1000" readonly title="Mock System Value">`; } else { html += `<input type="number" class="w-full p-2 border rounded text-sm" value="${inp.default}">`; } html += `</div>`; }); html += `<hr class="border-gray-200 my-4">`; const dummyVars = {}; this.model.inputs.forEach(i => { dummyVars[i.id] = i.type === 'system' ? 1000 : (parseFloat(i.default) || 1); }); const resultsHTML = this.model.calculations.map(calc => { let resValue = 'Error'; try { let formula = calc.formula; for (const [key, val] of Object.entries(dummyVars)) { formula = formula.replace(new RegExp(key, 'g'), val); } resValue = eval(formula); if (!isNaN(resValue)) { if (calc.isCost) resValue = '$' + resValue.toFixed(2); else resValue = resValue.toFixed(2); } } catch (e) { resValue = '...'; } const colorClass = calc.isCost ? 'text-green-700 font-bold text-lg' : 'text-gray-800 font-bold'; return ` <div class="flex justify-between items-center py-1"> <span class="text-sm text-gray-600">${calc.label}:</span> <span class="${colorClass}">${resValue}</span> </div> `; }).join(''); html += ` <div class="bg-gray-50 p-3 rounded border border-gray-200 space-y-1"> ${resultsHTML || '<span class="text-xs text-gray-400">Results will appear here</span>'} </div> `; html += `</div>`; html += `<div class="p-3 bg-gray-50 border-t border-gray-200 text-center"><button class="w-full py-2 bg-indigo-600 text-white rounded font-bold text-sm shadow">Add to Estimate</button></div>`; container.innerHTML = html; } exportJSON() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.model, null, 2)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", this.model.name.replace(/\s+/g, '_') + ".json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); } } window.addEventListener('DOMContentLoaded', () => { new PricingWizard(); });