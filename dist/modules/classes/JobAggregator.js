// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
export class JobAggregator { constructor(firebaseServices) { this.services = firebaseServices; this.db = firebaseServices.db; this.collection = firebaseServices.collection; this.query = firebaseServices.query; this.where = firebaseServices.where; this.getDocs = firebaseServices.getDocs; this.orderBy = firebaseServices.orderBy; } async getJobAssets(jobId) { if (!jobId) throw new Error("Missing jobId"); try { const [forms, tickets, expenses] = await Promise.all([ this.fetchJobForms(jobId), this.fetchJobTickets(jobId), this.fetchJobExpenses(jobId) ]); const gallery = []; forms.forEach(f => { const date = f.submittedAt ? new Date(f.submittedAt) : new Date(); if (f.data) { if (f.data.photos && Array.isArray(f.data.photos)) { f.data.photos.forEach(p => { gallery.push({ type: 'image', url: p.url || p, title: `${f.formTitle} Photo`, date: date, source: 'Form', user: f.userName }); }); } } }); tickets.forEach(t => { const date = t.date ? new Date(t.date) : new Date(); if (t.signatureUrl) { gallery.push({ type: 'image', url: t.signatureUrl, title: `Ticket #${t.ticketNumber || 'Draft'} Signature`, date: date, source: 'Ticket', user: t.userName }); } if (t.paperTicketUrl) { gallery.push({ type: 'image', url: t.paperTicketUrl, title: `Ticket #${t.ticketNumber || 'Draft'} Paper Copy`, date: date, source: 'Ticket', user: t.userName }); } }); expenses.forEach(e => { const date = e.date ? new Date(e.date) : new Date(); if (e.receiptUrl) { gallery.push({ type: 'image', url: e.receiptUrl, title: `Expense: ${e.description || 'Receipt'}`, date: date, source: 'Expense', user: e.userName }); } }); return gallery.sort((a, b) => b.date - a.date); } catch (error) { console.error("Error aggregating job assets:", error); return []; } } async fetchJobForms(jobId) { const q = this.query( this.collection(this.db, "form_submissions"), this.where("jobId", "==", jobId), this.orderBy("submittedAt", "desc") ); const snap = await this.getDocs(q); return snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); } async fetchJobTickets(jobId) { const q = this.query( this.collection(this.db, "time_tickets"), this.where("jobId", "==", jobId), this.orderBy("date", "desc") ); const snap = await this.getDocs(q); return snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); } async fetchJobExpenses(jobId) { const q = this.query( this.collection(this.db, "expenses"), this.where("jobId", "==", jobId), this.orderBy("date", "desc") ); const snap = await this.getDocs(q); return snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); } }