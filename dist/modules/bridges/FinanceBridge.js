// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { BaseBridge } from './BaseBridge.js'; export class FinanceBridge extends BaseBridge { constructor() { super('ExpenseManager', 'JobCosting'); } extract(context) { console.log(`[FinanceBridge] Extracting expenses for Job: ${context.jobId}...`); return context.expenses.filter(e => e.jobId === context.jobId); } transform(rawExpenses) { console.log(`[FinanceBridge] Transforming ${rawExpenses.length} expenses...`); const costs = { totalActual: 0, breakdown: { material: 0, labor: 0, equipment: 0, other: 0 }, updatedAt: new Date().toISOString() }; rawExpenses.forEach(exp => { const amount = parseFloat(exp.amount) || (exp.totalKm * 0.58) || 0; costs.totalActual += amount; const desc = (exp.description || '').toLowerCase(); if (desc.includes('material') || desc.includes('asphalt') || desc.includes('concrete')) { costs.breakdown.material += amount; } else if (desc.includes('labor') || desc.includes('crew')) { costs.breakdown.labor += amount; } else if (desc.includes('truck') || desc.includes('fuel') || exp.type === 'mileage') { costs.breakdown.equipment += amount; } else { costs.breakdown.other += amount; } }); costs.totalActual = parseFloat(costs.totalActual.toFixed(2)); for (const k in costs.breakdown) { costs.breakdown[k] = parseFloat(costs.breakdown[k].toFixed(2)); } return { jobId: rawExpenses[0]?.jobId, costs }; } async load(processedData, dbRef) { console.log(`[FinanceBridge] Loading Job Costing Data...`, processedData.costs); if (typeof window !== 'undefined' && window.firebaseServices) { const { updateDoc, doc } = window.firebaseServices; const estimateDocRef = doc(dbRef, 'estimates', processedData.jobId); await updateDoc(estimateDocRef, { actualCosts: processedData.costs, jobCostingLastUpdated: processedData.costs.updatedAt }); } else { console.log("[FinanceBridge] Mock DB Update:", processedData); } return { success: true, totalActual: processedData.costs.totalActual }; } }