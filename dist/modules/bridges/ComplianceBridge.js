// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { BaseBridge } from './BaseBridge.js'; export class ComplianceBridge extends BaseBridge { constructor() { super('Safety_Sub_Portal', 'Admin_Dashboard'); } extract(context) { console.log("[ComplianceBridge] Extracting compliance data..."); const dailyLogs = context.safetyLogs || []; const subs = context.subUsers || []; return { dailyLogs, subs }; } transform(rawData) { const { dailyLogs, subs } = rawData; const totalSubs = subs.length; const verifiedSubs = subs.filter(s => s.verified).length; const subScore = totalSubs === 0 ? 100 : (verifiedSubs / totalSubs) * 100; const safetyScore = Math.min(dailyLogs.length * 10, 100); const totalScore = (safetyScore * 0.6) + (subScore * 0.4); return { generatedAt: new Date().toISOString(), metrics: { totalScore: Math.round(totalScore), subCompliance: Math.round(subScore), safetyHabits: Math.round(safetyScore) }, flags: subs.filter(s => !s.verified).map(s => `${s.company} missing insurance/verification`) }; } async fetchSafetyDocs() { if (typeof window === 'undefined' || !window.firebaseServices) return []; try { const { db, collection, getDocs, query, orderBy } = window.firebaseServices; const q = query(collection(db, "safety_manual"), orderBy("title")); const snapshot = await getDocs(q); const docs = []; snapshot.forEach(d => docs.push(d.data())); return docs; } catch (e) { console.error("[ComplianceBridge] Error fetching docs:", e); return []; } } async load(report, dbRef) { console.log(`[ComplianceBridge] Loading Report (Score: ${report.metrics.totalScore})...`); if (typeof window !== 'undefined' && window.firebaseServices) { const { addDoc, collection } = window.firebaseServices; await addDoc(collection(dbRef, 'compliance_reports'), report); } else { console.log("[ComplianceBridge] Mock DB Report:", report); } return { success: true, score: report.metrics.totalScore }; } }