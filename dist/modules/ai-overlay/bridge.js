// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { LogicBridge } from '../../logic-bridge.js'; export const Bridge = { checkPermissions: (user, requiredRole) => { if (!user) return false; const roles = ['crew', 'foreman', 'manager', 'admin', 'super_admin']; const userRoleIndex = roles.indexOf(user.role || 'crew'); const requiredIndex = roles.indexOf(requiredRole); return userRoleIndex >= requiredIndex; }, fetchData: async (type, query) => { console.log(`[Bridge] Fetching ${type} for Query: ${query}`); try { switch (type) { case 'asset_availability': { const assetMatch = query.match(/\b([A-Z]{1,2}-\d{3}|asset_\w+)\b/i); const assetId = assetMatch ? assetMatch[0] : null; let date = new Date().toISOString().split('T')[0]; if (query.toLowerCase().includes('tomorrow')) { const d = new Date(); d.setDate(d.getDate() + 1); date = d.toISOString().split('T')[0]; } if (!assetId) return { error: "Could not identify an Asset ID." }; return await LogicBridge.checkAssetAvailability(assetId, date); } case 'staff_availability': { return await LogicBridge.checkStaffAvailability('currentUser', new Date().toISOString().split('T')[0]); } case 'repair_history': return Bridge._mockRepairHistory(query); default: return null; } } catch (error) { console.error("[Bridge] Data fetch failed:", error); return { error: "Bridge connection failed." }; } }, clockIn: async (user, site) => { console.log(`[Bridge] Clocking in ${user.email} at ${site.name}`); const { db, collection, addDoc } = window.firebaseServices || {}; if (!db) return false; try { await addDoc(collection(db, 'time_records'), { userId: user.uid, userName: user.displayName || user.email, type: 'clock_in', siteId: site.id, siteName: site.name, timestamp: new Date() }); return true; } catch (e) { console.error("[Bridge] Clock In Failed", e); return false; } }, createHazardForm: async (user, site) => { console.log(`[Bridge] Creating Hazard Form for ${site.name}`); const { db, collection, addDoc } = window.firebaseServices || {}; if (!db) return false; try { await addDoc(collection(db, 'safety_forms'), { type: 'hazard_assessment', status: 'draft', userId: user.uid, siteId: site.id, siteName: site.name, createdAt: new Date(), riskLevel: 'unknown' }); return true; } catch (e) { console.error("[Bridge] Safety Form Failed", e); return false; } }, _mockRepairHistory: (assetId) => { return [ { date: '2025-11-10', repair: 'Hydraulic Hoses Replaced', cost: 1200 }, { date: '2025-08-15', repair: 'Oil Change service', cost: 350 } ]; }, getSnapshot: () => { return { timestamp: Date.now(), activeData: { repairs: 2, projects: 5 } }; }, getAllModuleSnapshots: async () => { return { fleet: { activeRepairs: 5, urgentRepairs: 1, lastBreakdown: { assetId: 'T-101', loc: 'Zone-A' } }, sketch: { activeProjects: 3, delayedProjects: 1, delays: [{ projectId: 'P-500', loc: 'Zone-A' }] }, employee: { clockedIn: 45, overtimeAlerts: 2 } }; } };