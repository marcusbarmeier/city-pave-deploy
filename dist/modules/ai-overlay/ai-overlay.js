// ¬© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { Context } from './context.js'; import { Bridge } from './bridge.js'; import { Admin } from './admin.js'; import { UI } from './ui.js'; import { FloatingDock } from './floating-dock.js'; import { VoiceManager } from './voice-manager.js'; import { globalPermissionGate, CAPABILITIES } from '../subscription/tiers.js'; import { SmartQueue } from './smart-queue.js'; import { routingService } from '../communication/RoutingService.js'; import { emergencyController } from '../communication/EmergencyController.js'; import { contactDirectory } from '../communication/ContactDirectory.js'; export class AIOverlay { constructor() { this.isVisible = false; this.initialized = false; this.processingQueue = false; this.dismissals = []; this.dndUntil = 0; } async init() { if (this.initialized) return; Admin.init(); if (window.currentUser) { globalPermissionGate.syncWithUser(window.currentUser); } if (!Admin.shouldActivate(window.currentUser)) { console.log("[AI Overlay] Disabled by Admin or Permissions."); return; } Context.init(); const voiceEnabled = VoiceManager.init(); FloatingDock.addButton({ id: 'ai-trigger-btn', label: 'AI Assistant', icon: '‚ú®', color: 'linear-gradient(135deg, #4f46e5, #ec4899)', onClick: () => this.toggle() }); if (voiceEnabled) { FloatingDock.addButton({ id: 'ai-voice-btn', label: 'Tap to Talk', icon: 'üéôÔ∏è', color: '#f59e0b', onClick: () => this.startVoiceInteraction() }); window.addEventListener('voice-start', () => UI.showToast("Listening...", "üëÇ")); } window.addEventListener('geofence-enter', (e) => this.handleTrigger('geofence-enter', e.detail)); window.addEventListener('geofence-exit', (e) => this.handleTrigger('geofence-exit', e.detail)); window.addEventListener('ai-trigger', (e) => { if (e.detail && e.detail.type) { this.handleTrigger(e.detail.type, e.detail.data); } }); if (globalPermissionGate.can(CAPABILITIES.RED_PHONE)) { FloatingDock.addButton({ id: 'red-phone-btn', label: 'EMERGENCY', icon: 'üö®', color: '#dc2626', onClick: () => this.startEmergencyFlow() }); } FloatingDock.addButton({ id: 'comm-dir-btn', label: 'Directory', icon: 'üìí', color: '#10b981', onClick: () => contactDirectory.toggle() }); UI.init( () => this.toggle(), (text) => this.handleUserMessage(text) ); this.initialized = true; console.log("[AI Overlay] Initialized."); setInterval(() => this.processNextInQueue(), 2000); } toggle() { if (this.isVisible) { this.handleDismissal(); } this.isVisible = !this.isVisible; UI.toggleWindow(this.isVisible); if (this.isVisible) { this.showContextTip(); } } async startVoiceInteraction() { if (!this.isVisible) this.toggle(); this.processingQueue = true; try { VoiceManager.speak("I'm listening."); const text = await VoiceManager.listenOnce(); if (text) { this.handleUserMessage(text); } } catch (e) { console.warn("[AI Voice] Interaction failed/cancelled", e); UI.showToast("Voice check failed. Try again.", "‚ùå"); } finally { this.processingQueue = false; } } showContextTip() { const snapshot = Context.getSnapshot(); const msg = `Context: ${snapshot.userRole} @${snapshot.currentModule} `; UI.addContextTip(msg); } async handleTrigger(eventType, data) { console.log(`[AI Brain] Trigger Enqueued: ${eventType} `, data); let priority = SmartQueue.PRIORITY.NORMAL; if (eventType === 'geofence-enter' || eventType === 'dispatch-received') { priority = SmartQueue.PRIORITY.HIGH; } SmartQueue.enqueue({ type: eventType, data: data, priority: priority, timestamp: Date.now() }); return { queued: true }; } startEmergencyFlow() { const snapshot = Context.getSnapshot(); if (!snapshot.location) snapshot.location = { lat: 0, lng: 0 }; snapshot.name = window.currentUser ? window.currentUser.name : 'Unknown'; const incident = emergencyController.triggerEmergency(snapshot); if (!this.isVisible) this.toggle(); UI.addMessage(`üö® EMERGENCY MODE ACTIVATED üö®\nID: ${incident.id}`, 'ai'); UI.addMessage("What is the nature of the emergency?", 'ai'); VoiceManager.speak("Emergency mode activated. State the nature of the emergency."); setTimeout(() => { UI.addMessage(`[Accident] [Injury] [Fire] [Security]`, 'system'); }, 1000); this.activeContext = { action: 'confirm-emergency-type', incidentId: incident.id }; this.startVoiceInteraction(); } handleDismissal() { const now = Date.now(); this.dismissals = this.dismissals.filter(t => now - t < 300000); this.dismissals.push(now); if (this.dismissals.length >= 2) { this.dndUntil = now + (60 * 60 * 1000); UI.showToast("AI silenced for 1 hour (DND)", "üåô"); console.log("[AI Overlay] Do Not Disturb Activated until", new Date(this.dndUntil).toLocaleTimeString()); this.dismissals = []; } } async processNextInQueue() { if (this.processingQueue || SmartQueue.isEmpty()) return; if (Date.now() < this.dndUntil) { return; } if (VoiceManager.state.isSpeaking || VoiceManager.state.isListening) return; const item = SmartQueue.getNext(); if (!item) return; console.log("[AI Brain] Processing Item:", item); this.processingQueue = true; try { const { type, data } = item; let prompt = ""; let contextData = null; switch (type) { case 'geofence-enter': const isEndOfDay = new Date().getHours() >= 16; const isYard = /Home|Yard/i.test(data.name); if (isYard && isEndOfDay) { prompt = "Back at the Yard. Complete Daily Ops Log?"; contextData = { action: 'open-daily-log' }; } else { prompt = `You just arrived at ${data.name}. Clock in and start a hazard assessment?`; contextData = { action: 'clock-in', site: data }; } break; case 'geofence-exit': prompt = `Leaving ${data.name}. Clock out ? `; contextData = { action: 'clock-out', site: data }; break; case 'dispatch-received': prompt = `New Job detected: ${data.clientName}. Accept and start route ? `; contextData = { action: 'accept-job', job: data }; break; case 'estimate-ready': prompt = `Estimate for ${data.clientName} is ready ($${data.amount}). Send to Client Portal?`; contextData = { action: 'send-estimate', estimate: data }; break; default: console.log("[AI Brain] Unknown trigger ignored."); this.processingQueue = false; return; } this.activeContext = contextData; if (!this.isVisible) this.toggle(); UI.addMessage(prompt, 'ai'); VoiceManager.speak(prompt); setTimeout(() => { this.startVoiceInteraction().then(() => { this.processingQueue = false; }).catch(err => { console.log("Auto-listen blocked/failed:", err); this.processingQueue = false; }); }, 3000); } catch (e) { console.error("Error processing queue item:", e); this.processingQueue = false; } } async processQuery(input, context, data = null) { const lowerInput = input.toLowerCase(); if (this.activeContext && (lowerInput.includes('yes') || lowerInput.includes('sure') || lowerInput.includes('confirm'))) { const action = this.activeContext.action; const site = this.activeContext.site; if (action === 'clock-in') { console.log("[AI Bridge] Clocking In User..."); UI.addMessage(`‚úÖ Clocking you in at ${site.name}...`, 'ai'); const user = window.currentUser || { uid: 'sim-user', email: 'driver@citypave.com', displayName: 'Sim Driver' }; const clockResult = await Bridge.clockIn(user, site); if (clockResult) { UI.addMessage("üïí Time Record Created", 'system'); await Bridge.createHazardForm(user, site); UI.addMessage("üìã Hazard Assessment Opened (Draft)", 'system'); VoiceManager.speak("Clocked in. Safety form is ready."); } else { UI.addMessage("‚ùå Error writing to database.", 'error'); } this.activeContext = null; return "You are clocked in. Drive safe!"; } else if (action === 'open-daily-log') { } else if (action === 'send-estimate') { } } if (this.activeContext && this.activeContext.action === 'confirm-emergency-type') { let typeId = null; if (lowerInput.includes('accident') || lowerInput.includes('crash')) typeId = 'accident'; else if (lowerInput.includes('injury') || lowerInput.includes('hurt')) typeId = 'injury'; else if (lowerInput.includes('fire') || lowerInput.includes('smoke')) typeId = 'fire'; else if (lowerInput.includes('security') || lowerInput.includes('theft')) typeId = 'security'; if (typeId) { const result = await emergencyController.confirmEmergencyType(typeId); if (result) { UI.addMessage(`üì£ **ALERT BROADCASTED** to Crisis Team.`, 'warning'); if (globalPermissionGate.can(CAPABILITIES.MAGIC_LINKS)) { UI.addMessage(`üîó **Magic Link Created**: [Secure View](${result.magicLink})`, 'system'); VoiceManager.speak("Alert broadcasted. Secure link created."); } else { UI.addMessage(`(Magic Link generation requires Pro Tier)`, 'system-subtle'); VoiceManager.speak("Alert broadcasted."); } this.activeContext = null; return `Stay safe. Help is on the way.`; } } } if (this.isExpensiveRequest(lowerInput)) { return "‚ö†Ô∏è To conserve system resources, I cannot generate media files (images, videos, etc.) at this time. However, I can help you with text descriptions, estimates, and data analysis!"; } if (!globalPermissionGate.can(CAPABILITIES.AI_OVERLAY_GLOBAL)) { if (lowerInput.includes('bridge') || lowerInput.includes('global')) { return "üîí Upgrade to Level 3 for Global AI & Full Data Bridging."; } } if (lowerInput.includes('available') && (lowerInput.includes('asset') || lowerInput.match(/[A-Z]-\d+/))) { const availability = await Bridge.fetchData('asset_availability', input); if (availability.error) return availability.error; return availability.available ? `‚úÖ Yes, that asset is operational and available for assignment.` : `‚ùå Asset Unavailable.Reason: ${availability.reason} `; } if (lowerInput.includes('repair') || lowerInput.includes('history')) { const history = await Bridge.fetchData('repair_history', input); if (history && history.length > 0) { return `found ${history.length} records.Most recent: ${history[0].repair} on ${history[0].date} costing $${history[0].cost}.`; } return "No repair history found."; } if (data) { return `I found related data: ${JSON.stringify(data)} `; } if (lowerInput.includes('status') || lowerInput.includes('where am i')) { return `System is fully operational.You are currently in the ** ${context.currentModule}** module(${context.page}).\nRole: ${context.userRole} `; } if (lowerInput.includes('weather')) { if (!globalPermissionGate.can(CAPABILITIES.AI_OVERLAY_GLOBAL)) return "üîí Weather data requires Level 3 Global AI."; return "It looks like rain is expected tomorrow, so check the Schedule module to adjust your paving plans!"; } if (lowerInput.includes('safety')) return "Checking safety protocols... Always ensure you are wearing high-visibility gear on site. For specific hazards, check the Safety module."; if (lowerInput.includes('estimate') || lowerInput.includes('calculate')) return "I can help with estimates. Please provide the square footage and material type, and I'll run the numbers."; return `I can help with "${input}".As your AI assistant, I have access to the Logic Bridge for real - time asset checks and data.\n\nTry asking: "Is asset A-101 available?"`; } async handleUserMessage(text) { UI.addMessage("Thinking...", 'ai-temp'); const context = Context.getSnapshot(); try { if (!globalPermissionGate.can(CAPABILITIES.AI_OVERLAY_PAGE)) { throw new Error("AI Overlay not available in this Tier."); } const route = routingService.analyze(text, context); console.log("[AI Router] Decision:", route); let response = ""; if (route.type === 'SAFETY') { this.startEmergencyFlow(); const temp = UI.elements.messages.querySelector('.ai-msg.ai-temp'); if (temp) temp.remove(); return; } else if (route.recipient === 'AI_INTERCEPT') { if (text.match(/address|location|where/i)) { if (context.activeJob) { response = `üìç ${context.activeJob.name}: ${context.activeJob.address || '123 Main St, Springfield'}`; } else { response = "I don't see an active job for you right now. Please check Dispatch."; } } else if (text.match(/weather/i)) { response = "partly cloudy, 72¬∞F. No rain expected today."; } else { response = await this.processQuery(text, context); } } else if (route.type === 'ACCESS') { const siteId = context.site ? context.site.id : 'Unknown'; console.log(`[AI Logic] Fetching Gate Code for Site ${siteId}...`); const mockCodes = { 'S-101': '4499#', 'S-102': '1234' }; const code = mockCodes[siteId] || '0000#'; response = `üîê Access Code for this site is: **${code}**`; } else { if (!globalPermissionGate.can(CAPABILITIES.SMART_ROUTING)) { response = "üîí **Smart Routing** (Auto-Ticketing & Switchboard) is a Pro feature.\nI can answer general questions, but I cannot route requests to other departments yet."; } else { response = `üîÑ Routing to **${route.recipient}** (${route.action})...\nConfidence: ${(route.confidence * 100).toFixed(0)}%`; if (route.type === 'MECHANICAL') { response += `\nüõ†Ô∏è Ticket created for Fleet Manager.`; } } } const temp = UI.elements.messages.querySelector('.ai-msg.ai-temp'); if (temp) temp.remove(); UI.addMessage(response, 'ai'); if (response.length < 150) VoiceManager.speak(response); } catch (e) { console.error(e); const temp = UI.elements.messages.querySelector('.ai-msg.ai-temp'); if (temp) temp.remove(); if (e.message.includes("not available")) { UI.addMessage("üîí AI Assistant is not available in your current Subscription Tier.", 'ai'); } else { UI.addMessage("Sorry, I encountered an error connecting to the Logic Bridge.", 'ai'); } } } isExpensiveRequest(input) { const expensiveTerms = ['image', 'picture', 'photo', 'video', 'movie', 'generate a', 'draw', 'paint']; if (input.includes('generate') || input.includes('create')) { return expensiveTerms.some(term => input.includes(term)); } return false; } generateSimulatedResponse(input) { const responses = [ "That's an interesting question! I can certainly help you think through that.", "I'm here to help with anything you need, whether it's related to paving or just general information.", "Could you tell me more about what you're looking for?", "I've noted that. Is there anything specific in the system you'd like me to cross-reference?" ]; return `I understand you're asking about "${input}". While I don't have real - time internet access in this demo, I'm designed to process this kind of request!`; } } const aiOverlay = new AIOverlay(); export default aiOverlay;