// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
export const VoiceManager = { state: { isListening: false, isSpeaking: false, voices: [], recognition: null, synthesis: window.speechSynthesis }, init: () => { if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { console.warn("[Voice] Speech Recognition API not supported."); return false; } const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; const recognition = new SpeechRecognition(); recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'en-US'; recognition.onstart = () => { VoiceManager.state.isListening = true; console.log("[Voice] Listening..."); window.dispatchEvent(new CustomEvent('voice-start')); }; recognition.onend = () => { VoiceManager.state.isListening = false; console.log("[Voice] Stopped listening."); window.dispatchEvent(new CustomEvent('voice-end')); }; recognition.onError = (event) => { console.error("[Voice] Error:", event.error); }; VoiceManager.state.recognition = recognition; if (VoiceManager.state.synthesis) { VoiceManager.state.synthesis.onvoiceschanged = () => { VoiceManager.state.voices = VoiceManager.state.synthesis.getVoices(); }; } return true; }, speak: (text) => { if (!VoiceManager.state.synthesis) return; VoiceManager.state.synthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); const voices = VoiceManager.state.voices.length ? VoiceManager.state.voices : VoiceManager.state.synthesis.getVoices(); const preferredVoice = voices.find(v => v.name.includes('Google US English')) || voices.find(v => v.lang === 'en-US'); if (preferredVoice) utterance.voice = preferredVoice; utterance.rate = 1.0; utterance.pitch = 1.0; utterance.onstart = () => { VoiceManager.state.isSpeaking = true; }; utterance.onend = () => { VoiceManager.state.isSpeaking = false; }; VoiceManager.state.synthesis.speak(utterance); }, listenOnce: () => { return new Promise((resolve, reject) => { if (!VoiceManager.state.recognition) { reject("Voice API not supported"); return; } const rec = VoiceManager.state.recognition; rec.onresult = (event) => { const transcript = event.results[0][0].transcript; console.log(`[Voice] Heard: "${transcript}"`); resolve(transcript); }; rec.onerror = (event) => { reject(event.error); }; try { rec.start(); } catch (e) { rec.stop(); setTimeout(() => rec.start(), 100); } }); } };