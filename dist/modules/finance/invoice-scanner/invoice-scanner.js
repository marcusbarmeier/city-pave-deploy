// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { Modal, Button, Input, StatusBadge } from '/ui-components.js'; const DATE_REGEX = /(\d{1,2}[\/\.-]\d{1,2}[\/\.-]\d{2,4})/g; const AMOUNT_REGEX = /\$\s?(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/g; const AMOUNT_FALLBACK_REGEX = /(\d+\.\d{2})\b/g; export function renderInvoiceScanner(containerId, onScanComplete) { const container = document.getElementById(containerId); if (!container) return; container.innerHTML = ''; const wrapper = document.createElement('div'); wrapper.className = "flex flex-col items-center justify-center space-y-6 p-4"; const icon = document.createElement('div'); icon.innerHTML = `<svg xmlns="http: wrapper.appendChild(icon); const text = document.createElement('p'); text.className = "text-center text-gray-600 dark:text-gray-300"; text.textContent = "Take a clear photo of your invoice or receipt. We'll try to read the date and amount automatically."; wrapper.appendChild(text); const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = 'image/*'; fileInput.className = 'hidden'; fileInput.onchange = async (e) => { if (e.target.files && e.target.files[0]) { await processImage(e.target.files[0], container, onScanComplete); } }; wrapper.appendChild(fileInput); wrapper.appendChild(Button({ text: 'Select Photo / Camera', variant: 'primary', className: 'w-full max-w-xs py-3 text-lg', onClick: () => fileInput.click() })); container.appendChild(wrapper); } async function processImage(file, container, callback) { container.innerHTML = ` <div class="flex flex-col items-center justify-center h-64 space-y-4"> <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div> <p class="text-blue-600 font-bold animate-pulse">Scanning Invoice...</p> <p class="text-xs text-gray-400">This happens locally on your device.</p> </div> `; try { if (typeof Tesseract === 'undefined') { throw new Error("OCR Library not loaded. Please refresh and try again."); } const { data: { text } } = await Tesseract.recognize( file, 'eng', { logger: m => console.log(m) } ); console.log("OCR Result:", text); const extractedData = parseInvoiceData(text); if (callback) callback({ ...extractedData, file, rawText: text }); } catch (error) { console.error("OCR Error:", error); container.innerHTML = ` <div class="text-center p-4"> <p class="text-red-500 font-bold mb-2">Scan Failed</p> <p class="text-sm text-gray-600 mb-4">${error.message}</p> <button class="text-blue-600 underline" onclick="renderInvoiceScanner('${container.id}', ${callback})">Try Again</button> </div> `; } } const LINE_ITEM_REGEX = /^\s*(\d+)[xX\s]\s+(.+?)\s+\$?(\d+\.\d{2})/gm; function parseInvoiceData(text) { let date = null; let totalAmount = null; let items = []; const dateMatch = text.match(DATE_REGEX); if (dateMatch) date = dateMatch[0]; const allAmounts = text.match(AMOUNT_FALLBACK_REGEX); if (allAmounts) { totalAmount = Math.max(...allAmounts.map(n => parseFloat(n))); } let match; while ((match = LINE_ITEM_REGEX.exec(text)) !== null) { const qty = parseInt(match[1]); const description = match[2].trim(); const price = parseFloat(match[3]); if (description.length > 2) { items.push({ name: description, qty: qty, unitPrice: price, total: qty * price }); } } if (items.length === 0) { const lines = text.split('\n'); lines.forEach(line => { const priceMatch = line.match(/(\d+\.\d{2})$/); if (priceMatch) { const price = parseFloat(priceMatch[1]); const name = line.replace(priceMatch[0], '').replace('$', '').trim(); if (name.length > 3) { items.push({ name: name, qty: 1, unitPrice: price, total: price }); } } }); } const calcTotal = items.reduce((sum, i) => sum + i.total, 0); if (!totalAmount || calcTotal > totalAmount) { totalAmount = calcTotal; } return { date: date || new Date().toLocaleDateString(), amount: totalAmount || 0, description: `Invoice with ${items.length} items`, items: items }; }