// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
export const TIER_LEVELS = { LEVEL_1: 'LEVEL_1', LEVEL_2: 'LEVEL_2', LEVEL_3: 'LEVEL_3' }; export const CAPABILITIES = { AI_OVERLAY_GLOBAL: 'ai_overlay_global', AI_OVERLAY_PAGE: 'ai_overlay_page', FULL_DATA_BRIDGING: 'full_data_bridging', BUNDLE_ONLY_BRIDGING: 'bundle_only_bridging', MANUAL_DATA_TRANSFER: 'manual_data_transfer', SMART_ROUTING: 'smart_routing', MAGIC_LINKS: 'magic_links', RED_PHONE: 'red_phone' }; import { Governance } from './governance.js'; const TIER_CONFIG = { [TIER_LEVELS.LEVEL_3]: [ CAPABILITIES.FULL_DATA_BRIDGING, CAPABILITIES.AI_OVERLAY_GLOBAL, CAPABILITIES.GEO_FENCING, CAPABILITIES.BASIC_MANUAL_COMM, CAPABILITIES.AI_OVERLAY_PAGE, CAPABILITIES.SMART_ROUTING, CAPABILITIES.MAGIC_LINKS, CAPABILITIES.RED_PHONE ], [TIER_LEVELS.LEVEL_2]: [ CAPABILITIES.FULL_DATA_BRIDGING, CAPABILITIES.MANUAL_DATA_TRANSFER, CAPABILITIES.AI_OVERLAY_PAGE, CAPABILITIES.BASIC_MANUAL_COMM ], [TIER_LEVELS.LEVEL_1]: [ CAPABILITIES.BUNDLE_ONLY_BRIDGING, CAPABILITIES.MANUAL_DATA_TRANSFER ] }; export class PermissionGate { constructor() { let storedTier = null; if (typeof localStorage !== 'undefined') { storedTier = localStorage.getItem('city_pave_tier'); } this.currentTier = storedTier && Object.values(TIER_LEVELS).includes(storedTier) ? storedTier : TIER_LEVELS.LEVEL_1; if (typeof window !== 'undefined') { window.addEventListener('storage', (e) => { if (e.key === 'city_pave_tier' && e.newValue) { console.log(`[PermissionGate] Storage update: ${e.newValue}`); this.currentTier = e.newValue; } }); } } setTier(tier) { if (!Object.values(TIER_LEVELS).includes(tier)) { console.warn(`Invalid tier: ${tier}. Defaulting to LEVEL_1`); tier = TIER_LEVELS.LEVEL_1; } this.currentTier = tier; if (typeof localStorage !== 'undefined') { localStorage.setItem('city_pave_tier', tier); } console.log(`[PermissionGate] Tier set to ${tier}`); } syncWithUser(user) { if (!user) { this.setTier(TIER_LEVELS.LEVEL_1); return; } if (user.role === 'admin' || user.role === 'super_admin') { console.log("[PermissionGate] Admin detected. Granting LEVEL_3."); this.setTier(TIER_LEVELS.LEVEL_3); return; } if (user.tier && Object.values(TIER_LEVELS).includes(user.tier)) { this.setTier(user.tier); } else { this.setTier(TIER_LEVELS.LEVEL_1); } } can(capability) { const tierCaps = TIER_CONFIG[this.currentTier] || []; return tierCaps.includes(capability); } check(capability, userRoleTier) { const effectiveTier = Governance.getEffectiveTier(this.currentTier, userRoleTier); const caps = TIER_CONFIG[effectiveTier] || []; return caps.includes(capability); } getCapabilities() { return TIER_CONFIG[this.currentTier] || []; } } export const globalPermissionGate = new PermissionGate(); export const BUNDLES = { ESTIMATOR_SUITE: { id: 'bundle_estimator_suite', name: 'Estimator Suite', modules: ['estimator', 'sketch'], description: 'The core value prop: Professional Estimates + Sketch Tool.' }, FIELD_OPS: { id: 'bundle_field_ops', name: 'Field Ops Pack', modules: ['dispatch', 'safety', 'fleet'], description: 'Manage crews, safety compliance, and fleet maintenance.' }, GROWTH_ENGINE: { id: 'bundle_growth_engine', name: 'Growth Engine', modules: ['growth', 'client_portal'], description: 'Marketing tools, Chatbot, and Client Portal.' }, ENTERPRISE: { id: 'bundle_enterprise', name: 'Full Enterprise', modules: ['estimator', 'sketch', 'dispatch', 'safety', 'fleet', 'growth', 'client_portal', 'operations', 'employee', 'admin'], description: 'All modules included. The complete operating system.' } };