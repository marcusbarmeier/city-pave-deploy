// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
import { collection, getDocs, addDoc, deleteDoc, updateDoc, doc, query, where } from "https: import { MOCK_EMPLOYEES, STANDARD_PPE, STANDARD_SWP } from './mock-data.js'; let currentAssetId = null; let tempOpsInstructions = []; let tempMaintenanceSchedule = []; let tempInspectionRoutines = { pre: [], mid: [], post: [] }; export function initializeAssetManager() { console.log("Initializing Asset Manager v1.1"); loadAssetList(); } async function loadAssetList() { const container = document.getElementById('view-assets'); if (!container) return; container.innerHTML = ` <div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-bold text-gray-900">Fleet Assets</h2> <button onclick="window.createNewAsset()" class="bg-blue-600 text-white px-4 py-2 rounded-md font-bold hover:bg-blue-700 shadow-sm transition-all flex items-center"> <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Asset </button> </div> <div class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200"> <table class="min-w-full divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Unit ID</th> <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Make / Model</th> <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Type</th> <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th> <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th> </tr> </thead> <tbody id="asset-list-body" class="bg-white divide-y divide-gray-200"> <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading assets...</td></tr> </tbody> </table> </div> `; const { db } = window.firebaseServices; try { const snap = await getDocs(collection(db, "assets")); const tbody = document.getElementById('asset-list-body'); tbody.innerHTML = ''; if (snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No assets found. Click "Add Asset" to start.</td></tr>'; return; } snap.forEach(docSnap => { const asset = { id: docSnap.id, ...docSnap.data() }; const statusColor = asset.status === 'Down' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'; const tr = document.createElement('tr'); tr.className = "hover:bg-gray-50 cursor-pointer transition-colors"; tr.innerHTML = ` <td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900">${asset.unitId}</td> <td class="px-6 py-4 whitespace-nowrap text-gray-700"> <div class="font-medium">${asset.make || '-'} ${asset.model || '-'}</div> <div class="text-xs text-gray-400">${asset.year || ''} â€¢ VIN: ${asset.vin ? '...' + asset.vin.slice(-4) : 'N/A'}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.type || 'General'}</td> <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}"> ${asset.status || 'Operational'} </span> </td> <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"> <button class="text-blue-600 hover:text-blue-900 font-bold">View >></button> </td> `; tr.onclick = () => loadAssetDetail(asset); tbody.appendChild(tr); }); } catch (e) { console.error(e); document.getElementById('asset-list-body').innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error: ${e.message}</td></tr>`; } } async function loadAssetDetail(asset) { currentAssetId = asset.id; tempOpsInstructions = asset.opsInstructions || []; tempMaintenanceSchedule = asset.maintenanceSchedule || []; tempInspectionRoutines = asset.inspectionRoutines || { pre: [], mid: [], post: [] }; const container = document.getElementById('view-assets'); container.innerHTML = ` <div class="mb-4 flex items-center gap-4"> <button onclick="window.backToAssetList()" class="text-gray-500 hover:text-gray-700 flex items-center"> <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to List </button> <h2 class="text-2xl font-bold text-gray-900 flex-1">${asset.unitId} - ${asset.make || ''} ${asset.model || ''}</h2> <div class="flex items-center gap-2"> <span class="text-sm text-gray-500 mr-2">Status:</span> <select id="detail-status" onchange="window.updateAssetStatus(this.value)" class="rounded-md border-gray-300 shadow-sm text-sm font-bold ${asset.status === 'Down' ? 'text-red-700 bg-red-50' : 'text-green-700 bg-green-50'}"> <option value="Operational" ${asset.status !== 'Down' ? 'selected' : ''}>Operational</option> <option value="Down" ${asset.status === 'Down' ? 'selected' : ''}>Down (Maintenance)</option> <option value="Inactive" ${asset.status === 'Inactive' ? 'selected' : ''}>Inactive / Sold</option> </select> <button onclick="window.saveAssetDetails()" class="ml-4 bg-blue-600 text-white px-4 py-2 rounded-md font-bold hover:bg-blue-700 shadow-sm"> Save Changes </button> </div> </div> <div class="bg-white shadow rounded-lg border border-gray-200 min-h-[600px] flex flex-col"> <!-- TABS --> <div class="border-b border-gray-200"> <nav class="-mb-px flex space-x-8 px-6 overflow-x-auto" aria-label="Tabs"> <button onclick="window.switchTab('tab-overview')" id="btn-tab-overview" class="asset-tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Overview</button> <button onclick="window.switchTab('tab-maintenance')" id="btn-tab-maintenance" class="asset-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Maintenance</button> <button onclick="window.switchTab('tab-ops')" id="btn-tab-ops" class="asset-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Operations</button> <button onclick="window.switchTab('tab-inspect')" id="btn-tab-inspect" class="asset-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Inspections</button> <button onclick="window.switchTab('tab-safety')" id="btn-tab-safety" class="asset-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Safety</button> <button onclick="window.switchTab('tab-perms')" id="btn-tab-perms" class="asset-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Permissions</button> </nav> </div> <!-- CONTENT --> <div class="p-6 flex-1 overflow-y-auto"> <!-- 1. OVERVIEW --> <div id="tab-overview" class="space-y-6"> <div class="grid grid-cols-1 md:grid-cols-3 gap-6"> <div class="bg-gray-50 p-4 rounded-lg border border-gray-200"> <h3 class="font-bold text-gray-700 mb-4">Identification</h3> <div class="space-y-4"> ${renderInput("Unit ID", "unitId", asset.unitId)} ${renderInput("VIN / Serial", "vin", asset.vin)} ${renderInput("License Plate", "plate", asset.plate)} ${renderInput("Year", "year", asset.year, "number")} </div> </div> <div class="bg-gray-50 p-4 rounded-lg border border-gray-200"> <h3 class="font-bold text-gray-700 mb-4">Specifications</h3> <div class="space-y-4"> ${renderInput("Make", "make", asset.make)} ${renderInput("Model", "model", asset.model)} ${renderInput("Type", "type", asset.type, "text", "e.g. Truck, Excavator")} ${renderInput("GVWR (Lbs)", "gvwr", asset.gvwr, "number")} </div> </div> <div class="bg-gray-50 p-4 rounded-lg border border-gray-200"> <h3 class="font-bold text-gray-700 mb-4">Ownership</h3> <div class="space-y-4"> ${renderInput("Purchase Date", "purchaseDate", asset.purchaseDate, "date")} ${renderInput("Purchase Price ($)", "cost", asset.cost, "number")} ${renderInput("Vendor / Source", "vendor", asset.vendor)} ${renderInput("Warranty Exp.", "warrantyDate", asset.warrantyDate, "date")} </div> </div> </div> </div> <!-- 2. MAINTENANCE (Advanced) --> <div id="tab-maintenance" class="hidden space-y-6"> <div class="flex justify-between items-end"> <h3 class="font-bold text-gray-700">Scheduled Services</h3> <div class="text-right text-sm text-gray-500"> Current: <span class="font-mono font-bold text-black">${asset.currentMiles || 0} mi</span> | <span class="font-mono font-bold text-black">${asset.currentHours || 0} hrs</span> </div> </div> <!-- Service List --> <ul id="maintenance-schedule-list" class="space-y-3"> <!-- Injected by JS --> </ul> <button onclick="window.addServiceItem()" class="w-full py-3 bg-gray-50 hover:bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 font-bold"> + Add Periodic Service </button> </div> <!-- 3. OPERATIONS (Instruction Sets) --> <div id="tab-ops" class="hidden space-y-6"> <h3 class="font-bold text-gray-700 mb-4">Operational Guidelines</h3> <div id="ops-instructions-list" class="space-y-6"> <!-- Injected by JS --> </div> <button onclick="window.addOpsInstructionSet()" class="w-full py-3 bg-gray-50 hover:bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 font-bold"> + Add Instruction Set (e.g. "Startup Procedure") </button> </div> <!-- 4. INSPECTIONS (Pre/Mid/Post) --> <div id="tab-inspect" class="hidden space-y-6"> <h3 class="font-bold text-gray-700 mb-4">Inspection Checklists</h3> <div class="grid grid-cols-1 md:grid-cols-3 gap-6"> ${renderInspectionColumn("Pre-Trip / Start", "pre")} ${renderInspectionColumn("Mid-Shift", "mid")} ${renderInspectionColumn("Post-Trip / Shut", "post")} </div> </div> <!-- 5. SAFETY (Checkboxes) --> <div id="tab-safety" class="hidden space-y-6"> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> <!-- PPE --> <div class="bg-white p-4 rounded-lg border border-gray-200"> <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">Required PPE</h4> <div class="grid grid-cols-2 gap-2" id="safety-ppe-list"> <!-- JS Injected --> </div> </div> <!-- SWP --> <div class="bg-white p-4 rounded-lg border border-gray-200"> <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">Safe Work Procedures</h4> <div class="space-y-2" id="safety-swp-list"> <!-- JS Injected --> </div> </div> </div> <div> <label class="block text-sm font-medium text-red-900 mb-1">Additional Safety Notes / Hazards</label> <textarea id="field-safetyProcedures" rows="4" class="w-full border-red-200 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="Specific hazards...">${asset.safetyProcedures || ''}</textarea> </div> </div> <!-- 6. PERMISSIONS --> <div id="tab-perms" class="hidden space-y-6"> <div class="bg-white p-6 rounded-lg border border-gray-200"> <h3 class="font-bold text-gray-900 mb-2">Qualified Operators</h3> <p class="text-sm text-gray-500 mb-6">Select employees who are trained and authorized to operate this asset.</p> <div id="employee-perm-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"> <!-- Populated via JS --> </div> </div> </div> </div> </div> `; renderMaintenanceList(); renderOpsInstructions(); renderInspectionLists(); renderSafetyChecklists(asset.requiredPPE || [], asset.requiredSWP || []); renderPermissionsList(asset.permittedOperators || []); } function renderInput(label, fieldId, value, type = "text", placeholder = "") { return ` <div> <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">${label}</label> <input type="${type}" id="field-${fieldId}" value="${value || ''}" placeholder="${placeholder}" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm h-9 px-2"> </div> `; } function renderMaintenanceList() { const list = document.getElementById('maintenance-schedule-list'); if (!list) return; list.innerHTML = ''; tempMaintenanceSchedule.forEach((item, index) => { const li = document.createElement('li'); li.className = "bg-white border rounded-lg p-4 relative hover:shadow-sm"; let triggers = []; if (item.everyMiles) triggers.push(`${item.everyMiles} miles`); if (item.everyHours) triggers.push(`${item.everyHours} hours`); if (item.everyMonths) triggers.push(`${item.everyMonths} months`); li.innerHTML = ` <div class="flex justify-between items-start"> <div> <h4 class="font-bold text-blue-700">${item.serviceName || 'Unnamed Service'}</h4> <p class="text-xs text-gray-500">Triggers: ${triggers.join(' OR ') || 'None'}</p> <p class="text-sm mt-1 text-gray-600">${item.instructions || ''}</p> </div> <button onclick="window.removeMaintenanceItem(${index})" class="text-red-400 hover:text-red-600 font-bold text-xl">&times;</button> </div> `; list.appendChild(li); }); } window.addServiceItem = function () { const name = prompt("Service Name (e.g. Oil Change, Grease):"); if (!name) return; const miles = prompt("Every X Miles (leave blank if none):"); const hours = prompt("Every X Hours (leave blank if none):"); const months = prompt("Every X Months (leave blank if none):"); const inst = prompt("Key Instructions/Notes:"); tempMaintenanceSchedule.push({ serviceName: name, everyMiles: miles ? parseInt(miles) : null, everyHours: hours ? parseInt(hours) : null, everyMonths: months ? parseInt(months) : null, instructions: inst }); renderMaintenanceList(); }; window.removeMaintenanceItem = function (idx) { if (confirm("Remove this service item?")) { tempMaintenanceSchedule.splice(idx, 1); renderMaintenanceList(); } }; function renderOpsInstructions() { const list = document.getElementById('ops-instructions-list'); if (!list) return; list.innerHTML = ''; tempOpsInstructions.forEach((set, setIdx) => { const div = document.createElement('div'); div.className = "bg-gray-50 border rounded-lg p-4"; div.innerHTML = ` <div class="flex justify-between items-center mb-3"> <h4 class="font-bold text-gray-800 text-lg">${set.title}</h4> <button onclick="window.removeOpsSet(${setIdx})" class="text-red-500 hover:text-red-700 text-sm">Delete Set</button> </div> <ul class="list-decimal list-inside space-y-1 bg-white p-3 rounded border border-gray-200"> ${set.steps.map(s => `<li class="text-gray-700">${s}</li>`).join('')} </ul> <div class="mt-3 flex gap-2"> <button onclick="window.addOpsStep(${setIdx})" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">+ Add Step</button> <button class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">ðŸ“· Attach Media</button> </div> `; list.appendChild(div); }); } window.addOpsInstructionSet = function () { const title = prompt("Section Title (e.g. Startup Procedure):"); if (title) { tempOpsInstructions.push({ title, steps: [], media: [] }); renderOpsInstructions(); } }; window.addOpsStep = function (setIdx) { const step = prompt("Step Description:"); if (step) { tempOpsInstructions[setIdx].steps.push(step); renderOpsInstructions(); } }; window.removeOpsSet = function (idx) { tempOpsInstructions.splice(idx, 1); renderOpsInstructions(); }; function renderInspectionColumn(title, type) { return ` <div class="bg-gray-50 p-4 rounded-lg flex flex-col h-full border border-gray-200"> <h4 class="font-bold text-gray-800 mb-3 text-center border-b pb-2">${title}</h4> <ul id="inspect-list-${type}" class="flex-1 space-y-2 mb-4"></ul> <button onclick="window.addInspectionItem('${type}')" class="text-sm text-blue-600 hover:underline">+ Add Item</button> </div> `; } function renderInspectionLists() { ['pre', 'mid', 'post'].forEach(type => { const list = document.getElementById(`inspect-list-${type}`); if (list) { list.innerHTML = ''; (tempInspectionRoutines[type] || []).forEach((item, idx) => { const li = document.createElement('li'); li.className = "flex justify-between items-center bg-white px-2 py-1 rounded border border-gray-200 shadow-sm text-sm"; li.innerHTML = `<span>${item}</span> <span onclick="window.removeInspectionItem('${type}', ${idx})" class="text-red-400 cursor-pointer hover:text-red-600">&times;</span>`; list.appendChild(li); }); } }); } window.addInspectionItem = function (type) { const item = prompt("Inspection Item (e.g. Check Oil Level):"); if (item) { tempInspectionRoutines[type].push(item); renderInspectionLists(); } }; window.removeInspectionItem = function (type, idx) { tempInspectionRoutines[type].splice(idx, 1); renderInspectionLists(); }; function renderSafetyChecklists(selectedPPE, selectedSWP) { const ppeList = document.getElementById('safety-ppe-list'); if (ppeList) { ppeList.innerHTML = ''; STANDARD_PPE.forEach(item => { const isChecked = selectedPPE.includes(item.id); const label = document.createElement('label'); label.className = "flex items-center space-x-2 text-sm text-gray-700 cursor-pointer"; label.innerHTML = ` <input type="checkbox" name="ppe" value="${item.id}" ${isChecked ? 'checked' : ''} class="rounded text-blue-600 focus:ring-blue-500"> <span>${item.label}</span> `; ppeList.appendChild(label); }); } const swpList = document.getElementById('safety-swp-list'); if (swpList) { swpList.innerHTML = ''; STANDARD_SWP.forEach(item => { const isChecked = selectedSWP.includes(item.id); const label = document.createElement('label'); label.className = "flex items-center space-x-2 text-sm text-gray-700 cursor-pointer font-medium"; label.style.color = isChecked ? '#b91c1c' : '#374151'; label.innerHTML = ` <input type="checkbox" name="swp" value="${item.id}" ${isChecked ? 'checked' : ''} class="rounded text-red-600 focus:ring-red-500"> <span>${item.label}</span> `; label.querySelector('input').onchange = (e) => { label.style.color = e.target.checked ? '#b91c1c' : '#374151'; }; swpList.appendChild(label); }); } } function renderPermissionsList(selectedIds) { const list = document.getElementById('employee-perm-list'); if (!list) return; list.innerHTML = ''; MOCK_EMPLOYEES.forEach(emp => { const isChecked = selectedIds.includes(emp.id); const div = document.createElement('div'); div.className = `border rounded-md p-3 flex items-center cursor-pointer transition-colors ${isChecked ? 'bg-blue-50 border-blue-300' : 'hover:bg-gray-50 border-gray-200'}`; div.onclick = (e) => togglePermission(e, emp.id); div.innerHTML = ` <input type="checkbox" value="${emp.id}" ${isChecked ? 'checked' : ''} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-3 pointer-events-none"> <div> <div class="font-medium text-sm text-gray-900">${emp.name}</div> <div class="text-xs text-gray-500">${emp.role}</div> </div> `; list.appendChild(div); }); } window.togglePermission = function (e, empId) { const checkbox = e.currentTarget.querySelector('input'); if (e.target !== checkbox) checkbox.checked = !checkbox.checked; if (checkbox.checked) { e.currentTarget.classList.add('bg-blue-50', 'border-blue-300'); e.currentTarget.classList.remove('hover:bg-gray-50', 'border-gray-200'); } else { e.currentTarget.classList.remove('bg-blue-50', 'border-blue-300'); e.currentTarget.classList.add('hover:bg-gray-50', 'border-gray-200'); } }; window.createNewAsset = function () { loadAssetDetail({ unitId: 'NEW-' + Math.floor(Math.random() * 1000), status: 'Operational' }); currentAssetId = null; }; window.backToAssetList = function () { loadAssetList(); }; window.switchTab = function (tabId) { ['tab-overview', 'tab-maintenance', 'tab-ops', 'tab-inspect', 'tab-safety', 'tab-perms'].forEach(id => { const pan = document.getElementById(id); const btn = document.getElementById('btn-' + id); if (pan) pan.classList.add('hidden'); if (btn) { btn.classList.remove('border-blue-500', 'text-blue-600'); btn.classList.add('border-transparent', 'text-gray-500'); } }); const activePan = document.getElementById(tabId); const activeBtn = document.getElementById('btn-' + tabId); if (activePan) activePan.classList.remove('hidden'); if (activeBtn) { activeBtn.classList.remove('border-transparent', 'text-gray-500'); activeBtn.classList.add('border-blue-500', 'text-blue-600'); } }; window.saveAssetDetails = async function () { const fields = [ 'unitId', 'vin', 'plate', 'year', 'make', 'model', 'type', 'gvwr', 'purchaseDate', 'cost', 'vendor', 'warrantyDate', 'safetyProcedures' ]; const data = {}; fields.forEach(f => { const el = document.getElementById('field-' + f); if (el) data[f] = el.value; }); const statusEl = document.getElementById('detail-status'); if (statusEl) data.status = statusEl.value; const permCheckboxes = document.querySelectorAll('#employee-perm-list input:checked'); data.permittedOperators = Array.from(permCheckboxes).map(cb => cb.value); const ppeCheckboxes = document.querySelectorAll('input[name="ppe"]:checked'); data.requiredPPE = Array.from(ppeCheckboxes).map(cb => cb.value); const swpCheckboxes = document.querySelectorAll('input[name="swp"]:checked'); data.requiredSWP = Array.from(swpCheckboxes).map(cb => cb.value); data.maintenanceSchedule = tempMaintenanceSchedule; data.opsInstructions = tempOpsInstructions; data.inspectionRoutines = tempInspectionRoutines; const { db } = window.firebaseServices; const btn = document.querySelector('button[onclick="window.saveAssetDetails()"]'); const originalText = btn.textContent; btn.textContent = "Saving..."; btn.disabled = true; try { if (currentAssetId) { await updateDoc(doc(db, "assets", currentAssetId), data); alert("Asset Updated!"); } else { const docRef = await addDoc(collection(db, "assets"), { ...data, currentMiles: 0, currentHours: 0, createdAt: new Date().toISOString() }); currentAssetId = docRef.id; alert("New Asset Created!"); } } catch (e) { console.error(e); alert("Error saving: " + e.message); } finally { btn.textContent = originalText; btn.disabled = false; } }; window.updateAssetStatus = function (val) { const el = document.getElementById('detail-status'); el.className = `rounded-md border-gray-300 shadow-sm text-sm font-bold ${val === 'Down' ? 'text-red-700 bg-red-50' : 'text-green-700 bg-green-50'}`; };