// Â© 2025 City Pave. All Rights Reserved. Unauthorized copying is prohibited.
export async function checkAssetMaintenanceStatus(assetId) { if (!assetId) return { status: 'ok', alerts: [] }; const { db, doc, getDoc } = window.firebaseServices; try { const assetRef = doc(db, "assets", assetId); const snapshot = await getDoc(assetRef); if (!snapshot.exists()) return { status: 'ok', alerts: [] }; const asset = snapshot.data(); const schedule = asset.maintenanceSchedule || []; const alerts = []; let maxSeverity = 'ok'; const currentMiles = asset.currentMiles || 0; const currentHours = asset.currentHours || 0; schedule.forEach(item => { let due = false; let msg = ''; if (item.everyMiles) { const last = item.lastServiceMiles || 0; if (asset.nextServiceMiles && currentMiles >= asset.nextServiceMiles) { } const milesSinceLast = currentMiles % item.everyMiles; const milesRemaining = item.everyMiles - milesSinceLast; if (milesRemaining < 100) { due = true; msg = `${item.serviceName} due in ${milesRemaining} miles`; } } if (item.everyHours) { const hoursSinceLast = currentHours % item.everyHours; const hoursRemaining = item.everyHours - hoursSinceLast; if (hoursRemaining < 20) { due = true; msg = `${item.serviceName} due in ${hoursRemaining} hours`; } } if (due) { alerts.push(msg); maxSeverity = 'warning'; if (msg.includes("due in -")) maxSeverity = 'critical'; } }); return { status: maxSeverity, alerts }; } catch (e) { console.error("Maintenance Bridge Error:", e); return { status: 'error', alerts: ["Error checking status"] }; } }